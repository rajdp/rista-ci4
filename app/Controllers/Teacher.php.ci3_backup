<?php
defined('BASEPATH') OR exit('No direct script access allowed');
header('Access-Control-Allow-Origin: *');
header("Access-Control-Allow-Headers: AccessToken");
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');

require APPPATH . '/libraries/REST_Controller.php';

class Teacher extends REST_Controller
{
    protected $jsonarr = array();
    protected $headers;
    protected $urlAuth;
    protected $controller;

    function __construct()
    {
        parent::__construct();
        $this->load->model("teacher_model");
        $this->load->model("common_model");
        $this->load->model("student_model");

        header("Access-Control-Allow-Origin: *");
        $this->controller = uri_string();
        $urlAuth = $this->verifyAuthUrl();
        $headers = $this->input->request_headers();
        if ($urlAuth) {
            $excludeurl = $this->excludefunction();
            if ($excludeurl != 'true') {
                if (isset($headers['Accesstoken'])) {
                    $this->output->set_status_header(200);
                    $headers['Accesstoken'];
                } else {
                    $this->jsonarr['ErrorObject'] = "Unauthorized User";
                    $this->jsonarr['IsSuccess'] = false;
                    $this->printjson($this->jsonarr);
                    $this->output->set_status_header(401);
                    exit();
                }

            } else {
                $this->output->set_status_header(200);
                return true;
            }
        } else {
            $this->output->set_status_header(200);
            $this->jsonarr['ErrorObject'] = "The requested url is not found.";
            $this->jsonarr['IsSuccess'] = false;
            $this->printjson($this->jsonarr);
            exit();
        }
    }

    public function verifyAuthUrl()
    {
        $this->allowedRoutes = array(
            'v1/teacher/add',
            'v1/teacher/edit',
            'v1/teacher/list',
            'v1/teacher/detail',
            'v1/teacher/schoolList',
            'v1/teacher/teacherPermissionList',
            'v1/teacher/classList',
            'v1/teacher/studentClassList',
            'v1/teacher/assignmentList',
            'v1/teacher/assessmentList',
            'v1/teacher/dashboard',
            'v1/teacher/teacherassignStudent',
            'v1/teacher/studentAnswerList',
            'v1/teacher/teacherCorrection',
            'v1/teacher/getQuestions',
            'v1/teacher/releaseScore',
            'v1/teacher/studentContentStatusChange',
            'v1/teacher/saveAnnotation',
            'v1/teacher/studentAssessment',
            'v1/teacher/individualTeacherAdd',
            'v1/teacher/studentCorrectionList',
            'v1/teacher/notifyParents',
            'v1/teacher/notifyAllStudentParents',
            'v1/teacher/teacherUploadExcel',
            'v1/teacher/teacherCorrectionAnnotation',
            'v1/teacher/releaseScoreAll',
            'v1/teacher/studentQuestionStatus',
            'v1/teacher/questionList',
            'v1/teacher/itemWiseStudentList',
            'v1/teacher/saveAnswerSheetAnnotation',
            'v1/teacher/studentCorrectionInfo',
            'v1/teacher/teacherassignStudentPrint',
            'v1/teacher/addAcademyTeacher',
            'v1/teacher/editAcademyTeacher'
        );
        foreach ($this->allowedRoutes as $routeString) {
            if ($this->controller == $routeString) {
                return true;
            }
        }
        return false;
    }

    public function excludefunction()
    {
        $this->excludeRoutes = array(
        );
        foreach ($this->excludeRoutes as $routeString) {
            if ($this->controller == $routeString) {
                return true;
            }
        }
    }

    public function add_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Email should not be empty";
        } elseif ($params['mobile'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "mobile should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "school id should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Status should not be empty";
        } elseif ($params['permission'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Permission should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/add','only request','add');
            $userExists = $this->teacher_model->user($params, 'add', '');
            if (count($userExists) == 0) {
                $checkSchool = $this->teacher_model->checkSchool($params);
                if (count($checkSchool) == 0) {
                    $user = [];
                    $user['role_id'] = 4;
                    $user['school_id'] = $params['school_id'];
                    $user['status'] = $params['status'];
                    $user['login_type'] = 'WEB';
                    $user['created_by'] = $params['user_id'];
                    $user['created_date'] = date('Y-m-d H:i:s');
                    $user['email_id'] = $params['email_id'];
                    $user['mobile'] = $params['mobile'];
                    $user['academy_user_id'] = isset($params['academy_teacher_id']) ? $params['academy_teacher_id'] : 0;
                    $id = $this->common_model->insert('user', $user);
                    if ($id > 0) {
                        $userPermission = [];
                        $c = 0;
                        for ($i = 0; $i < count($params['permission']); $i++) {
                            for ($j = 0; $j < count($params['permission'][$i]['permission']); $j++) {
                                if ($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                    $userPermission[$c]['user_id'] = $id;
                                    $userPermission[$c]['role_id'] = 4;
                                    $userPermission[$c]['school_id'] = $params['school_id'];
                                    $userPermission[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                    $c++;
                                }
                            }
                        }
                        if (count($userPermission) > 0) {
                            $this->common_model->bulkInsert('user_role_permission', $userPermission);
                        }
                        $userProfile = [];
                        $userProfile['user_id'] = $id;
                        $userProfile['first_name'] = $params['first_name'];
                        $userProfile['last_name'] = $params['last_name'];
                        $userProfile['profile_url'] = $params['profile_url'];
                        $userProfile['gender'] = $params['gender'];
                        $userProfile['birthday'] = $params['birthday'];
                        $userProfile['created_by'] = $params['user_id'];
                        $userProfile['created_date'] = date('Y-m-d H:i:s');
                        if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                            $userProfile['profile_url'] = $params['profile_url'];
                            $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                        }
                        $profileId = $this->common_model->insert('user_profile', $userProfile);
                        if ($profileId > 0) {
                            $userProfileDetails = [];
                            $userProfileDetails['user_id'] = $id;
                            $userProfileDetails['school_id'] = $params['school_id'];
                            $userProfileDetails['doj'] = $params['doj'];
                            $userProfileDetails['grade_id'] = is_array($params['grade']) ? implode(',', $params['grade']) : '';
                            $userProfileDetails['subject'] = is_array($params['subject']) ? implode(',', $params['subject']) : '';
                            $userProfileDetails['profile_grade'] = isset($params['profile_grade']) && is_array($params['profile_grade']) ? implode(',', $params['profile_grade']) : NULL;
                            $userProfileDetails['profile_subject'] = isset($params['profile_subject']) &&  is_array($params['profile_subject']) ? implode(',', $params['profile_subject']) : NULL;
                            $userProfileDetails['designation'] = $params['designation'];
                            $userProfileDetails['school_idno'] = $params['school_idno'];
                            $userProfileDetails['created_by'] = $params['user_id'];
                            $userProfileDetails['created_date'] = date('Y-m-d H:i:s');
                            $profileDetailId = $this->common_model->insert('user_profile_details', $userProfileDetails);
                            if ($profileDetailId > 0) {
                                $userAddress = [];
                                $userAddress['address_type'] = 1;
                                $userAddress['user_id'] = $id;
                                $userAddress['name'] = $params['last_name'];
                                $userAddress['address1'] = $params['address1'];
                                $userAddress['address2'] = $params['address2'];
                                $userAddress['city'] = $params['city'];
                                $userAddress['state'] = $params['state'];
                                $userAddress['country'] = $params['country'];
                                $userAddress['postal_code'] = $params['postal_code'];
                                $userAddress['created_date'] = date('Y-m-d H:i:s');
                                $address_id = $this->common_model->insert('user_address', $userAddress);
                                if ($address_id > 0) {
                                    $messageTemplates = $this->common_model->smsEmailTemplate('password_generate_link', 'email');
                                    $emailMsg = $messageTemplates['template'];
                                    $userLink = base64_encode($id);
                                    $userLink = base64_encode($userLink);
                                    $this->load->library('bitly');
                                    $url = $this->config->item('user_password_url') . '/' . $userLink;
                                   // $urlLink = $this->bitly->shorten($url);
                                    //$emailMsg = str_replace('%PASSWORD%', $this->config->item('password'), $message);
                                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                                    if ($this->config->item('user_send_email') == true) {
                                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '', '');
                                    }
//                                        else {
//                                            $mailSent = true;
//                                        }
//                                        if ($mailSent == true) {
                                    $this->jsonarr["IsSuccess"] = true;
                                    $this->jsonarr["ResponseObject"] = "Teacher added successfully";
                                    $this->jsonarr["Link"] = $url;
                                    $this->jsonarr["teacher_id"] = $id;
//                                        } else {
//                                            $this->jsonarr['IsSuccess'] = false;
//                                            $this->jsonarr['ErrorObject'] = "Failed to send mail";
//                                        }
                                } else {
                                    $this->jsonarr["IsSuccess"] = false;
                                    $this->jsonarr["ErrorObject"] = "Failed to Add Teacher Address";
                                }
                            } else {
                                $this->jsonarr["IsSuccess"] = false;
                                $this->jsonarr["ErrorObject"] = "Failed to Add Teacher Profile details";
                            }
                        } else {
                            $this->jsonarr["IsSuccess"] = false;
                            $this->jsonarr["ErrorObject"] = "Failed to Add Teacher Profile";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Failed to Add Teacher";
                    }
                } elseif (count($checkSchool) > 0) {
                    $condition = array('user_id' => $checkSchool[0]['user_id']);
                    $school = array();
                    $schoolIds = explode(",", $checkSchool[0]['school_id']);
                    array_push($schoolIds, $params['school_id']);
                    $school['school_id'] = implode(",", $schoolIds);
                    $school['academy_user_id'] = isset($params['academy_teacher_id']) ? $params['academy_teacher_id'] : 0;
                    $userProfileDetail = [];
                    $userProfileDetail['user_id'] = $checkSchool[0]['user_id'];
                    $userProfileDetail['school_id'] = $params['school_id'];
                    $userProfileDetail['grade_id'] = is_array($params['grade']) ? implode(',', $params['grade']) : '';
                    $userProfileDetail['subject'] = is_array($params['subject']) ? implode(',', $params['subject']) : '';
                    $userProfileDetail['profile_grade'] = isset($params['profile_grade']) && is_array($params['profile_grade']) ? implode(',', $params['profile_grade']) : NULL;
                    $userProfileDetail['profile_subject'] = isset($params['profile_subject']) &&  is_array($params['profile_subject']) ? implode(',', $params['profile_subject']) : NULL;
                    $userProfileDetail['doj'] = $params['doj'];
                    $userProfileDetail['designation'] = $params['designation'];
                    $userProfileDetail['school_idno'] = $params['school_idno'];
                    $userProfileDetail['created_by'] = $params['user_id'];
                    $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                    $userPermission = [];
                    $c = 0;
                    for ($i = 0; $i < count($params['permission']); $i++) {
                        for ($j = 0; $j < count($params['permission'][$i]['permission']); $j++) {
                            if ($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                $userPermission[$c]['user_id'] = $checkSchool[0]['user_id'];
                                $userPermission[$c]['role_id'] = 4;
                                $userPermission[$c]['school_id'] = $params['school_id'];
                                $userPermission[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                $c++;
                            }
                        }
                    }
                    if (count($userPermission) > 0) {
                        $this->common_model->bulkInsert('user_role_permission', $userPermission);
                    }
                    $update1 = $this->common_model->update('user', $school, $condition);
                    $update2 = $this->common_model->insert('user_profile_details', $userProfileDetail);
                    $messageTemplates = $this->common_model->smsEmailTemplate('existing_user', 'email');
                    $schoolName = $this->common_model->schoolName($params['school_id']);
                    $emailMsg = $messageTemplates['template'];
                    $this->load->library('bitly');
                    $url = $this->config->item('teacher_login_url');
                   // $urlLink = $this->bitly->shorten($url);
                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                    $emailMsg = str_replace('%SCHOOL%', $schoolName['name'], $emailMsg);
                    if ($this->config->item('user_send_email') == true) {
                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '', '');
                    }
                    if ($update1 && $update2) {
                        $this->jsonarr["IsSuccess"] = True;
                        $this->jsonarr["ErrorObject"] = "Teacher Added Successfully";
                        $this->jsonarr["teacher_id"] = $checkSchool[0]['user_id'];
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Failed to add Teacher";
                    }
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Email-Id already exists";
            }
        }
        $this->common_model->createLog($params,'v1/teacher/add',$this->jsonarr,'add');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function list_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        }elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "school Id should not be empty";
        }
        else {
            $this->common_model->createLog($params,'v1/teacher/list','only request','list');
            $teacherList = $this->teacher_model->teacherList($params);
            foreach ($teacherList as $key => $value) {
                if ($teacherList[$key]['grade_id'] == "") {
                    $teacherList[$key]['grade_id'] = [];
                    $teacherList[$key]['grade_name'] = [];
                } else {
                    $teacherList[$key]['grade_id'] = explode(',', $value['grade_id']);
                    $teacherList[$key]['grade_name'] = explode(',', $value['grade_name']);
                }
                if ($teacherList[$key]['subject'] == "") {
                    $teacherList[$key]['subject'] = [];
                    $teacherList[$key]['subject_name'] = [];
                } else {
                    $teacherList[$key]['subject'] = explode(',', $value['subject']);
                    $teacherList[$key]['subject_name'] = explode(',', $value['subject_name']);
                }
                if ($teacherList[$key]['profile_grade'] == "") {
                    $teacherList[$key]['profile_grade'] = [];
                    $teacherList[$key]['profile_grade_name'] = [];
                } else {
                    $teacherList[$key]['profile_grade'] = explode(',', $value['profile_grade']);
                    $teacherList[$key]['profile_grade_name'] = explode(',', $value['profile_grade_name']);
                }
                if ($teacherList[$key]['profile_subject'] == "") {
                    $teacherList[$key]['profile_subject'] = [];
                    $teacherList[$key]['profile_subject_name'] = [];
                } else {
                    $teacherList[$key]['profile_subject'] = explode(',', $value['profile_subject']);
                    $teacherList[$key]['profile_subject_name'] = explode(',', $value['profile_subject_name']);
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $teacherList;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/list',$this->jsonarr,'list');
        return $this->printjson($this->jsonarr);
    }

    public function edit_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Email should not be empty";
        } elseif ($params['mobile'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "mobile should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "status should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "school_idno should not be empty";
        } else if($params['permission'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Permission should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/teacher/edit','only request','edit');
            if (count($this->jsonarr) == 0) {
                $userExists = $this->teacher_model->checkemail($params,$params['selected_user_id']);
                if (count($userExists) == 0) {
                    $checkPermission = $this->teacher_model->checkPermission($params['selected_user_id']);
                    if(count($checkPermission) > 0) {
                        $this->teacher_model->deletePermission($params['selected_user_id'],$params['school_id']);
                    }
                    $userPermission = [];
                    $c = 0;
                    for($i = 0; $i < count($params['permission']); $i++) {
                        for($j =0; $j < count($params['permission'][$i]['permission']);$j++) {
                            if($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                $userPermission[$c]['user_id'] = $params['selected_user_id'];
                                $userPermission[$c]['role_id'] = 4;
                                $userPermission[$c]['school_id'] = $params['school_id'];
                                $userPermission[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                $c++;
                            }}}
                    if(count($userPermission) > 0){
                        $this->common_model->bulkInsert('user_role_permission',$userPermission);
                    }
                    $condition = array("user_id" => $params['selected_user_id']);
                    $user = [];
                    $user['mobile'] = $params['mobile'];
                    $user['modified_by'] = $params['user_id'];
                    $user['status'] = $params['status'];
                    $user['email_id'] = $params['email_id'];
                    $userUpdate = $this->common_model->update('user', $user, $condition);
                    if ($userUpdate) {
                        $this->jsonarr['IsSuccess'] = true;
                        $this->jsonarr['ResponseObject'] = "User updated successfully";
                        $userProfile = [];
                        $userProfile['first_name'] = $params['first_name'];
                        $userProfile['last_name'] = $params['last_name'];
                        $userProfile['profile_url'] = $params['profile_url'];
                        $userProfile['gender'] = $params['gender'];
                        $userProfile['birthday'] = $params['birthday'];
                        $userProfile['modified_by'] = $params['role_id'];
                        $userProfile['modified_date'] = date('Y-m-d H:i:s');
                        if(isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                            $userProfile['profile_url'] = $params['profile_url'];
                            $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                        }
                        $userProfileUpdate = $this->common_model->update('user_profile', $userProfile, $condition);
                        if ($userProfileUpdate) {
                            $getUserId = $this->common_model->getUserId($params['selected_user_id'], $params['school_id']);
                            $userCondition = "user_details_id = {$getUserId['user_details_id']} AND school_id = {$params['school_id']}";
                            $userProfileDetails = [];
                            $userProfileDetails['doj'] = $params['doj'];
                            $userProfileDetails['status'] = $params['status'];
                            $userProfileDetails['designation'] = $params['designation'];
                            $userProfileDetails['school_idno'] = $params['school_idno'];
                            $userProfileDetails['grade_id'] = is_array($params['grade']) ? implode(',',$params['grade']) : '';
                            $userProfileDetails['subject'] = is_array($params['subject']) ? implode(',',$params['subject']) : '';
                            $userProfileDetails['profile_grade'] = isset($params['profile_grade']) && is_array($params['profile_grade']) ? implode(',', $params['profile_grade']) : NULL;
                            $userProfileDetails['profile_subject'] = isset($params['profile_subject']) &&  is_array($params['profile_subject']) ? implode(',', $params['profile_subject']) : NULL;
                            $userProfileDetailUpdate = $this->common_model->update('user_profile_details', $userProfileDetails, $userCondition);
                            if($userProfileDetailUpdate) {
                                $userAddress = [];
                                $userAddress['name'] = $params['last_name'];
                                $userAddress['address1'] = $params['address1'];
                                $userAddress['address2'] = $params['address2'];
                                $userAddress['city'] = $params['city'];
                                $userAddress['state'] = $params['state'];
                                $userAddress['country'] = $params['country'];
                                $userAddress['postal_code'] = $params['postal_code'];
                                $userAddress['modified_date'] = date('Y-m-d H:i:s');
                                $userAddressUpdate = $this->common_model->update('user_address', $userAddress, $condition);
                                if ($userAddressUpdate) {
                                    $this->jsonarr['IsSuccess'] = true;
                                    $this->jsonarr['ResponseObject'] = "Teacher updated successfully";
                                } else {
                                    $this->jsonarr['IsSuccess'] = false;
                                    $this->jsonarr['ErrorObject'] = "Failed to update address";
                                }
                            } else {
                                $this->jsonarr['IsSuccess'] = false;
                                $this->jsonarr['ErrorObject'] = "Failed to update user profile detail";
                            }
                        } else {
                            $this->jsonarr['IsSuccess'] = false;
                            $this->jsonarr['ErrorObject'] = "Failed to update user profile";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Failed to update User";
                    }

                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "EmailId already exists";
                }
            }
        }
        $this->common_model->createLog($params,'v1/teacher/edit',$this->jsonarr,'edit');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function detail_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['selected_user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/teacher/detail','only request','detail');
            $teacherDetail = $this->teacher_model->teacherDetail($params);
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $teacherDetail;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/detail',$this->jsonarr,'detail');
        return $this->printjson($this->jsonarr);
    }

    public function teacherPermissionList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } else {
            $this->common_model->createLog($params, 'v1/teacher/teacherPermissionList', 'only request', 'teacherPermissionList');
            $teacherPermissionList = $this->teacher_model->teacherPermissionList();
            $list = [];
            for ($i = 0; $i < count($teacherPermissionList); $i++) {
                $dataAvailable = false;
                for ($j = 0; $j < count($list); $j++) {
                    if ($list[$j]['group_id'] == $teacherPermissionList[$i]['group_id']) {
                        $dataAvailable = true;
                    }
                }
                if (!$dataAvailable) {
                    $c = count($list);
                    $list[$c]['group_id'] = $teacherPermissionList[$i]['group_id'];
                    $list[$c]['group_name'] = $teacherPermissionList[$i]['group_name'];
                    $list[$c]['permission'][0]['id'] = $teacherPermissionList[$i]['id'];
                    $list[$c]['permission'][0]['description'] = $teacherPermissionList[$i]['description'];
                    $list[$c]['permission'][0]['display_order'] = $teacherPermissionList[$i]['display_order'];
                    $list[$c]['permission'][0]['status'] = 0;
                } else {
                    for ($k = 0; $k < count($list); $k++) {
                        if ($list[$k]['group_id'] == $teacherPermissionList[$i]['group_id']) {
                            $cnt = count($list[$k]['permission']);
                            $list[$k]['permission'][$cnt]['id'] = $teacherPermissionList[$i]['id'];
                            $list[$k]['permission'][$cnt]['description'] = $teacherPermissionList[$i]['description'];
                            $list[$k]['permission'][$cnt]['display_order'] = $teacherPermissionList[$i]['display_order'];
                            $list[$k]['permission'][$cnt]['status'] = 0;
                        }
                    }
                }
            }
            if (isset($params['teacher_id']) && $params['teacher_id'] > 0) {
                // get user_permission_id from  user_role_permission for the required teacherId and loop thru the list
                // and change the status to 1 for the required user_permission_id.
                $permissionIds = $this->teacher_model->teacherPermissionIds($params['teacher_id'], $params['school_id']);
                if (count($permissionIds) > 0) {
                    $permissionArray = explode(',', $permissionIds[0]['permission_id']);
                    for ($i = 0; $i < count($list); $i++) {
                        for ($j = 0; $j < count($list[$i]['permission']); $j++) {
                            if (in_array($list[$i]['permission'][$j]['id'], $permissionArray)) {
                                $list[$i]['permission'][$j]['status'] = 1;
                            }
                        }
                    }
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"]["Permission"] = $list;
        }
        $this->common_model->createLog($params, 'v1/teacher/teacherPermissionList', $this->jsonarr, 'teacherPermissionList');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function schoolList_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } if(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/schoolList','only request','schoolList');
            $schoolList = $this->teacher_model->schoolList($params);
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $schoolList;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/schoolList',$this->jsonarr,'schoolList');
        return $this->printjson($this->jsonarr);
    }

    public function studentClassList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
//        $this->common_model->checkpermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['teacher_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "teacher Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/teacher/studentClassList','only request','studentClassList');
            $teacherassignlist = $this->teacher_model->teacherassignlist($params);
            $student = [];
            for ($i = 0; $i < count($teacherassignlist); $i++) {
                $dataAvailable = false;
                for ($j = 0; $j < count($student); $j++) {
                    if ($student[$j]['class_id'] == $teacherassignlist[$i]['class_id']) {
                        $dataAvailable = true;
                    }
                }
                if (!$dataAvailable) {
                    $a = count($student);
                    $student[$a]['class_id'] = $teacherassignlist[$i]['class_id'];
                    $student[$a]['class_name'] = $teacherassignlist[$i]['class_name'];
                    if ($teacherassignlist[$i]['student_id']==''){
                        $student[$a]['student'][0]="";
                    }else {
                        $student[$a]['student'][0]['student_id'] = $teacherassignlist[$i]['student_id'];
                        $student[$a]['student'][0]['first_name'] = $teacherassignlist[$i]['first_name'];
                        $student[$a]['student'][0]['last_name'] = $teacherassignlist[$i]['last_name'];
                    }} else {
                    $studentList = [];
                    $s = 0;
                    for ($n = 0; $n < count($student); $n++) {
                        if ($student[$n]['class_id'] == $teacherassignlist[$i]['class_id']) {
                            if ($teacherassignlist[$i]['student_id']==''){
                                $studentList[$s]['student'][0]="";
                            }else{
                                $studentList[$s]['student_id'] = $teacherassignlist[$i]['student_id'];
                                $studentList[$s]['first_name'] = $teacherassignlist[$i]['first_name'];
                                $studentList[$s]['last_name'] = $teacherassignlist[$i]['last_name'];
                                $s++;
                            }}
                        if (count($studentList) > 0) {
                            array_push($student[$n]['student'], $studentList[0]);
                        }
                    }
                }
            }
            $student=array_filter($student);
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $student;
        }
        $this->common_model->createLog($params,'v1/teacher/studentClassList',$this->jsonarr,'studentClassList');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function classList_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/classList','only request','classList');
            $classList = $this->teacher_model->classList($params);
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $classList;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/classList',$this->jsonarr,'classList');
        return $this->printjson($this->jsonarr);
    }

    public function assignmentList_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/assignmentList','only request','assignmentList');
            $assignmentList = $this->teacher_model->assignmentList($params);
            foreach ($assignmentList as $key => $value){
                if($value['student_ids'] != "") {
                    $totalStudentsName = $this->teacher_model->getStudentsName($value['student_ids']);
                    $assignmentList[$key]['total_students_Name'] = explode(',',$totalStudentsName[0]['student_names']);
                } else {
                    $assignmentList[$key]['total_students_Name'] = [];
                }
            }
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $assignmentList;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/assignmentList',$this->jsonarr,'assignmentList');
        return $this->printjson($this->jsonarr);
    }

    public function assessmentList_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/assessmentList','only request','assessmentList');
            $assessmentList = $this->teacher_model->assessmentList($params);
            foreach ($assessmentList as $key => $value) {
                if ($value['student_ids'] != "") {
                    $totalStudentsName = $this->teacher_model->getStudentsName($value['student_ids']);
                    $assessmentList[$key]['total_students_Name'] = explode(',', $totalStudentsName[0]['student_names']);
                } else {
                    $assessmentList[$key]['total_students_Name'] = [];
                }
            }
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $assessmentList;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/assessmentList',$this->jsonarr,'assessmentList');
        return $this->printjson($this->jsonarr);
    }


    public function dashboard_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        }elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['teacher_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Teacher Id should not be empty";
        }elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/teacher/dashboard','only request','dashboard');
            $dashboard=[];
            //$dashboard = $this->teacher_model->dashboardlist($params);
            $classList = $this->teacher_model->classList($params);
            $assignmentList= $this->teacher_model->assignmentList($params);
            $assessmentList= $this->teacher_model->assessmentList($params);
            $dashboard['classes']=$classList;
            $dashboard['assignments']=$assignmentList;
            $dashboard['assessmentList']=$assessmentList;
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $dashboard;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/dashboard',$this->jsonarr,'dashboard');
        return $this->printjson($this->jsonarr);

    }

    public function teacherassignStudent_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        }elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif(count($this->jsonarr) == 0){
            $this->common_model->createLog($params,'v1/teacher/teacherassignStudent','only request','teacherassignStudent');
            $teacherassignStudent = $this->teacher_model->teacherAssign($params);
            if(count($teacherassignStudent) > 0) {
                foreach($teacherassignStudent as $key => $value) {
                    if ($value['total_question'] != 0) {
                        if ($value['attend_questions'] == '-') {
                            $teacherassignStudent[$key]['attend_questions'] = 0;
                        }
                    }
                    if($value['attend_questions'] == '-' || $value['attend_questions'] != 0) {
                        $teacherassignStudent[$key]['percentage'] = $value['total_points'] != 0 ? round($value['earned_points'] ? ($value['earned_points'] / $value['total_points']) * 100 : 0) : 0;
                        $teacherassignStudent[$key]['percentage'] = $teacherassignStudent[$key]['percentage'] . '%';
                    } else {
                        $teacherassignStudent[$key]['percentage'] = 0;
                        $teacherassignStudent[$key]['percentage'] = $teacherassignStudent[$key]['percentage'] . '%';
                    }
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $teacherassignStudent;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/teacherassignStudent',$this->jsonarr,'teacherassignStudent');
        return $this->printjson($this->jsonarr);
    }

    public function teacherassignStudentPrint_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
      //  $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        }elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif(count($this->jsonarr) == 0){
            $this->common_model->createLog($params,'v1/teacher/teacherassignStudent','only request','teacherassignStudent');
            $teacherassignStudent = $this->teacher_model->teacherAssign($params);
            if(count($teacherassignStudent) > 0) {
                foreach($teacherassignStudent as $key => $value) {
                    if ($value['total_question'] != 0) {
                        if ($value['attend_questions'] == '-') {
                            $teacherassignStudent[$key]['attend_questions'] = 0;
                        }
                    }
                    if($value['attend_questions'] == '-' || $value['attend_questions'] != 0) {
                        $teacherassignStudent[$key]['percentage'] = $value['total_points'] != 0 ? round($value['earned_points'] ? ($value['earned_points'] / $value['total_points']) * 100 : 0) : 0;
                        $teacherassignStudent[$key]['percentage'] = $teacherassignStudent[$key]['percentage'] . '%';
                    } else {
                        $teacherassignStudent[$key]['percentage'] = 0;
                        $teacherassignStudent[$key]['percentage'] = $teacherassignStudent[$key]['percentage'] . '%';
                    }
                }
            }
            echo 'data:'.json_encode($teacherassignStudent);
            exit();
        }
    }


    public function questionList_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'),true);
        $headers= $this->input->request_headers();
        $this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        }elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/questionList','only request','questionList');
            $studentQuestion = $this->teacher_model->question($params);
            $this->jsonarr["IsSuccess"] = "true";
            $this->jsonarr["ResponseObject"] = $studentQuestion;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/questionList',$this->jsonarr,'questionList');
        return $this->printjson($this->jsonarr);

    }

    public function studentQuestionStatusOld_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'),true);
        $headers= $this->input->request_headers();
        $this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        }elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/studentQuestionStatus','only request','studentQuestionStatus');
            $studentQuestion = $this->teacher_model->question($params);
            $allStudentList = $this->teacher_model->allStudentList($params);
            $student = array();
            foreach ($allStudentList as $key => $value) {
                $student[$key]['student_id'] = $value['student_id'];
                $student[$key]['student_name'] = $value['student_name'];
                $student[$key]['content_id'] = $params['content_id'];
                $student[$key]['content_format'] = $params['content_format'];
                $student[$key]['class_id'] = $params['class_id'];
                $student[$key]['question'] = array();
                foreach ($studentQuestion as $key1 => $value1) {
                    $answerStatus = $this->teacher_model->checkAnswerStatus($params, $value['student_id'], $value1['question_id']);
                    $student[$key]['question'][$key1]['question_no'] = $value1['sub_question_no'];
                    $student[$key]['question'][$key1]['question'] = $value1['question'];
                    $student[$key]['question'][$key1]['question_id'] = $value1['question_id'];
                    if(count($answerStatus) > 0) {
                        if (($answerStatus[0]['status'] == 3 || $answerStatus[0]['status'] == 5) && $answerStatus[0]['answer_status'] == 1) {
                            //incorrect
                            $student[$key]['question'][$key1]['status'] = 2;
                        } elseif (($answerStatus[0]['status'] == 3 || $answerStatus[0]['status'] == 5) && $answerStatus[0]['answer_status'] == 2) {
                            //correct
                            $student[$key]['question'][$key1]['status'] = 3;
                        } else {
                            //not start
                            $student[$key]['question'][$key1]['status'] = 1;
                        }
                    } else {
                        $student[$key]['question'][$key1]['question_no'] = $value1['sub_question_no'];
                        $student[$key]['question'][$key1]['question'] = $value1['question'];
                        $student[$key]['question'][$key1]['question_id'] = $value1['question_id'];
                        $student[$key]['question'][$key1]['status'] = 1;
                    }
                }
            }
            $this->jsonarr["IsSuccess"] = "true";
            $this->jsonarr["ResponseObject"] = $student;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/studentQuestionStatus',$this->jsonarr,'studentQuestionStatus');
        return $this->printjson($this->jsonarr);

    }


    public function studentQuestionStatus_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'),true);
        $headers= $this->input->request_headers();
        //$this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        }elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif(count($this->jsonarr) == 0) {
            $questionId = [];
            $studentId = [];
            $this->common_model->createLog($params,'v1/teacher/studentQuestionStatus','only request','studentQuestionStatus');
            $studentQuestion = $this->teacher_model->question($params);
            $student = array();
            if($studentQuestion) {
                for ($h = 0; $h < count($studentQuestion); $h++) {
                    array_push($questionId, $studentQuestion[$h]['question_id']);
                }
                $ids = array_values(array_unique($questionId));
                $implode = implode(',', $ids);
                $allStudentList = $this->teacher_model->allStudentList($params);
                for ($i = 0; $i < count($allStudentList); $i++) {
                    array_push($studentId, $allStudentList[$i]['student_id']);
                }
                $ids2 = array_values(array_unique($studentId));
                $implode2 = implode(',', $ids2);
                $allStudentListAll = $this->teacher_model->allStudentList1($params, $implode2, $implode);
                $allStudentList1 = array_values(array_map("unserialize", array_unique(array_map("serialize", $allStudentListAll))));
                for ($i = 0; $i < count($allStudentList1); $i++) {
                    $dataAvailable = false;
                    for ($j = 0; $j < count($student); $j++) {
                        if ($student[$j]['student_id'] == $allStudentList1[$i]['student_id']) {
                            $dataAvailable = true;
                        }
                    }
                    if (!$dataAvailable) {

                        $count = count($student);
                        $student[$count]['student_id'] = $allStudentList1[$i]['student_id'];
                        $student[$count]['student_name'] = $allStudentList1[$i]['student_name'];
                        $student[$count]['class_id'] = $params['class_id'];
                        $student[$count]['content_id'] = $params['content_id'];
                        $student[$count]['content_format'] = $params['content_format'];
                        $student[$count]['student_content_id'] = $allStudentList1[$i]['student_content_id'];
                        $student[$count]['question'][0]['question'] = $allStudentList1[$i]['question'];
                        $student[$count]['question'][0]['question_id'] = $allStudentList1[$i]['question_id'];
                        $student[$count]['question'][0]['question_no'] = $allStudentList1[$i]['sub_question_no'];
                        $student[$count]['question'][0]['has_sub_question'] = $allStudentList1[$i]['has_sub_question'];
                        $student[$count]['question'][0]['sub_question_no'] = $allStudentList1[$i]['sub_question_no'];
                        $student[$count]['question'][0]['heading'] = $allStudentList1[$i]['heading'];
                        if (($allStudentList1[$i]['status'] == 3 || $allStudentList1[$i]['status'] == 5) && $allStudentList1[$i]['answer_status'] == 1) {
                            //incorrect
                            $student[$count]['question'][0]['status'] = 2;
                        } elseif (($allStudentList1[$i]['status'] == 3 || $allStudentList1[$i]['status'] == 5) && $allStudentList1[$i]['answer_status'] == 2) {
                            //correct
                            $student[$count]['question'][0]['status'] = 3;
                        } else {
                            //not start
                            $student[$count]['question'][0]['status'] = 1;
                        }

                    } else {
                        for ($k = 0; $k < count($student); $k++) {
                            if ($student[$k]['student_id'] == $allStudentList1[$i]['student_id']) {
                                $cnt = count($student[$k]['question']);
                                $student[$k]['question'][$cnt]['question'] = $allStudentList1[$i]['question'];
                                $student[$k]['question'][$cnt]['question_id'] = $allStudentList1[$i]['question_id'];
                                $student[$k]['question'][$cnt]['question_no'] = $allStudentList1[$i]['sub_question_no'];
                                $student[$k]['question'][$cnt]['status'] = $allStudentList1[$i]['question_id'];
                                $student[$k]['question'][$cnt]['has_sub_question'] = $allStudentList1[$i]['has_sub_question'];
                                $student[$k]['question'][$cnt]['sub_question_no'] = $allStudentList1[$i]['sub_question_no'];
                                $student[$k]['question'][$cnt]['heading'] = $allStudentList1[$i]['heading'];
                                if (($allStudentList1[$i]['status'] == 3 || $allStudentList1[$i]['status'] == 5) && $allStudentList1[$i]['answer_status'] == 1) {
                                    //incorrect
                                    $student[$k]['question'][$cnt]['status'] = 2;
                                } elseif (($allStudentList1[$i]['status'] == 3 || $allStudentList1[$i]['status'] == 5) && $allStudentList1[$i]['answer_status'] == 2) {
                                    //correct
                                    $student[$k]['question'][$cnt]['status'] = 3;
                                } else {
                                    //not start
                                    $student[$k]['question'][$cnt]['status'] = 1;
                                }
                            }
                        }
                    }
                }
                for ($p = 0; $p < count($student); $p++) {
                    if ($student[$p]['question'][0]['heading'] != "") {
                        $allAnswerList = $this->group_by('heading', $student[$p]['question']);
                    } else {
                        $allAnswerList = $student[$p]['question'];
                        usort($allAnswerList, function ($a, $b) {
                            return $a['question_no'] <=> $b['question_no'];
                        });
                    }
                    $answerList = [];
                    $subQ = 0;
                    $tempSubQuestionsArray = [];
                    for ($i = 0; $i < count($allAnswerList); $i++) {
                        $dataAvailable = false;
                        for ($j = 0; $j < count($answerList); $j++) {
                            //if ($allAnswerList[$i]['heading'] != "") {
                            if ($answerList[$j]['heading'] == $allAnswerList[$i]['heading']) {
                                $dataAvailable = true;
                            }
                            // }
                        }
                        $c = count($answerList);
                        if (!$dataAvailable) {
                            if (count($answerList) >= 1) {
                                if ($answerList[$c - 1]['heading'] == $allAnswerList[$i]['heading']) {
//                                if ($answerList[$c - 1]['section']['question_no'] == $allAnswerList[$i]['question_no']) {
                                    $tempSubQuestionsArray[$subQ]['question'] = $allAnswerList[$i]['question'];
                                    $tempSubQuestionsArray[$subQ]['question_id'] = $allAnswerList[$i]['question_id'];
                                    $tempSubQuestionsArray[$subQ]['question_no'] = $allAnswerList[$i]['question_no'];
                                    $tempSubQuestionsArray[$subQ]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                    $tempSubQuestionsArray[$subQ]['status'] = $allAnswerList[$i]['status'];

//                                } else {
//                                    $answerList[$c]['heading'] = $allAnswerList[$i]['heading'];
//                                    $answerList[$c]['section'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
//                                    $answerList[$c]['section'][0]['question'] = $allAnswerList[$i]['question'];
//                                    $answerList[$c]['section'][0]['question_id'] = $allAnswerList[$i]['question_id'];
//                                    $answerList[$c]['section'][0]['question_no'] = $allAnswerList[$i]['question_no'];
//                                    $answerList[$c]['section'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
//                                    $answerList[$c]['section'][0]['status'] = $allAnswerList[$i]['status'];
//                                }
                                } else {
                                    $answerList[$c]['heading'] = $student[$p]['question'][$i]['heading'];
                                    $answerList[$c]['section'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                                    $answerList[$c]['section'][0]['question'] = $allAnswerList[$i]['question'];
                                    $answerList[$c]['section'][0]['question_id'] = $allAnswerList[$i]['question_id'];
                                    $answerList[$c]['section'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                                    $answerList[$c]['section'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                    $answerList[$c]['section'][0]['status'] = $allAnswerList[$i]['status'];
                                }
                            } else {
                                $answerList[$c]['heading'] = $allAnswerList[$i]['heading'];
                                $answerList[$c]['section'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                                $answerList[$c]['section'][0]['question'] = $allAnswerList[$i]['question'];
                                $answerList[$c]['section'][0]['question_id'] = $allAnswerList[$i]['question_id'];
                                $answerList[$c]['section'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                                $answerList[$c]['section'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                $answerList[$c]['section'][0]['status'] = $allAnswerList[$i]['status'];
                            }
                        } else {
                            $subQuestion = 0;
                            $noSubQuestion = 0;
                            $tempSubQuestionsArray = [];
                            if ($answerList[$c - 1]['heading'] == $allAnswerList[$i]['heading']) {
                                //$l => count of each heading questions
                                $l = count($answerList[$c - 1]['section']) - 1;
//                            if (isset($answerList[$c - 1]['section'][$l]['sub_questions'])) {
//                                //$m => count of each subquestions in a heading
//                                $m = count($answerList[$c - 1]['section'][$l]['sub_questions']) - 1;
//                            }
                                $noSubQuestion = 1;
                                $tempSubQuestionsArray[$subQ]['question'] = $allAnswerList[$i]['question'];
                                $tempSubQuestionsArray[$subQ]['question_id'] = $allAnswerList[$i]['question_id'];
                                $tempSubQuestionsArray[$subQ]['question_no'] = $allAnswerList[$i]['question_no'];
                                $tempSubQuestionsArray[$subQ]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                $tempSubQuestionsArray[$subQ]['status'] = $allAnswerList[$i]['status'];
//                            if ($answerList[$c - 1]['section'][$l]['sub_questions'][$m]['question_no'] == $allAnswerList[$i]['question_no']) {
//                                $subQuestion = 1;
//                                $tempSubQuestionsArray[$subQ]['question'] = $allAnswerList[$i]['question'];
//                                $tempSubQuestionsArray[$subQ]['question_id'] = $allAnswerList[$i]['question_id'];
//                                $tempSubQuestionsArray[$subQ]['question_no'] = $allAnswerList[$i]['question_no'];
//                                $tempSubQuestionsArray[$subQ]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
//                                $tempSubQuestionsArray[$subQ]['status'] = $allAnswerList[$i]['status'];
//
//                            } else {
//                                $noSubQuestion = 1;
//                                $tempSubQuestionsArray[$subQ]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
//                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['question'] = $allAnswerList[$i]['question'];
//                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['question_id'] = $allAnswerList[$i]['question_id'];
//                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
//                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
//                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['status'] = $allAnswerList[$i]['status'];
//                            }
                                if (count($tempSubQuestionsArray) > 0) {
                                    if ($subQuestion > 0) {
//                                    $check = array_search($allAnswerList[$i]['question_id'], $answerList[$c - 1]['section'][$l]['sub_questions'][$m]);
//                                    if (!$check) {
                                        array_push($answerList[$c - 1]['section'][$l]['sub_questions'], $tempSubQuestionsArray[0]);
//                                    }
                                    } elseif ($noSubQuestion > 0) {
//                                    $check = array_search($allAnswerList[$i]['question_id'], $answerList[$c - 1]['section'][$l]['sub_questions'][$m]);
//                                    if (!$check) {
                                        array_push($answerList[$c - 1]['section'], $tempSubQuestionsArray[0]);
//                                    }
                                    }
                                }
                            }
                        }
                    }
                    $student[$p]['question'] = $answerList;
                }
            } else {
                $getStudentList = $this->teacher_model->studentNoQuestionList($params);
                foreach($getStudentList as $key => $value) {
                    $getStudentList[$key]['question'] = array();
                }
                $student = $getStudentList;
            }
            $this->jsonarr["IsSuccess"] = "true";
            $this->jsonarr["ResponseObject"] = $student;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/studentQuestionStatus',$this->jsonarr,'studentQuestionStatus');
        return $this->printjson($this->jsonarr);

    }


    public function itemWiseStudentList_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'),true);
        $headers= $this->input->request_headers();
        $this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios"){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should Not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should Not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should Not be Empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class Id Should Not be Empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id Should not be Empty";
        } elseif (count($this->jsonarr) == 0){
            $this->common_model->createLog($params,'v1/teacher/itemWiseStudentList','only request','itemWiseStudentList');
            $studentList = $this->teacher_model->itemWiseStudentList($params);
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = array_values(array_map("unserialize",array_unique(array_map("serialize",$studentList))));
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/itemWiseStudentList',$this->jsonarr,'itemWiseStudentList');
        return $this->printjson($this->jsonarr);
    }

    public function studentAnswerList_post(){
        $this->benchmark->mark('code_start');
        $params=json_decode(file_get_contents('php://input'),true);
        $headers= $this->input->request_headers();
      //  $this->common_model->checkPermission($this->controller,$params,$headers);
        if($params['platform']!= "web" && $params['platform']!="ios"){
            $this->jsonarr["IsSuccess"]=false;
            $this->jsonarr["ErrorObject"]= "Platform should not be empty";
        }elseif ($params['role_id']==""){
            $this->jsonarr["IsSuccess"]=false;
            $this->jsonarr["ErrorObject"]= "Role Id should not be empty";
        }elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        }elseif ($params['content_format'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content_Format should not be empty";
        }elseif (count($this->jsonarr)==0){
            $this->common_model->createLog($params,'v1/teacher/studentAnswerList','only request','studentAnswerList');
            $studentList = [];
            $studentName = [];
            if ($params['platform']=="web") {
                $studentName = $this->teacher_model->name($params);
            }
            if(isset($params['student_id'])) {
                $studentList['student_id'] = $params['student_id'];
                if ($params['platform']=="web") {
                    $studentList['student_name'] = $studentName[0]['student_name'];
                }
                $studentList['content_id'] = $params['content_id'];
                $studentList['class_id'] = $params['class_id'];
                $studentContentAnnotation = $this->teacher_model->studentContentAnnotation($params);
                $allAnswerList = $this->teacher_model->studentcontentIdList($params);
                $studentList['status'] = $studentContentAnnotation[0]['status'];
                if($this->config->item('filePathBase64') == true) {
                    $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode($studentContentAnnotation[0]['file_path']))));
                }
                if ($this->config->item('filePathBase64') == true && $params['platform'] != "ios") {
                    if ($studentContentAnnotation[0]['file_path'] != '' && $studentContentAnnotation[0]['file_path'] != '[]') {
                        $studentList['file_path'] = $base64FilePath;
                    } else {
                        $studentList['file_path'] = [];
                    }
                } else {
                    if ($studentContentAnnotation[0]['file_path'] != '' && $studentContentAnnotation[0]['file_path'] != '[]') {
                        $studentList['file_path'] = json_decode($studentContentAnnotation[0]['file_path'],true);
                        if (!isset($studentList['file_path'][0]['original_image_url'])) {
                            $studentList['file_path'][0]['original_image_url'] = '';
                            $studentList['file_path'][0]['image'] = '';
                            $studentList['file_path'][0]['size'] = 0;
                        }
                    } else {
                        $studentList['file_path'] = [];
                    }
                }

                if($this->config->item('filePathBase64') == true) {
                    $base64AnswerKey = base64_encode(base64_encode(base64_encode(base64_encode($studentContentAnnotation[0]['answerkey_path']))));
                }

                if($params['platform'] != "ios" && isset($studentContentAnnotation[0]['answerkey_path'])) {
                    if ($this->config->item('filePathBase64') == true) {
                        if ($studentContentAnnotation[0]['answerkey_path'] != '' && $studentContentAnnotation[0]['answerkey_path'] != '[]') {
                            $studentList['answerkey_path'] = $base64AnswerKey;
                        } else {
                            $studentList['answerkey_path'] = [];
                        }
                    } else {
                        if ($studentContentAnnotation[0]['answerkey_path'] != '' && $studentContentAnnotation[0]['answerkey_path'] != '[]') {
                            $studentList['answerkey_path'] = json_decode($studentContentAnnotation[0]['answerkey_path']);
                        } else {
                            $studentList['answerkey_path'] = [];
                        }
                    }
                }
                //$studentList['file_path'] = $this->config->item('filePathBase64') == true ? $base64FilePath : $studentContentAnnotation[0]['file_path'] != '' ? json_decode($studentContentAnnotation[0]['file_path']) : [];
//                if ($studentContentAnnotation[0]['file_path'] != '') {
//                    $studentList['file_path']=json_decode($studentContentAnnotation[0]['file_path']);
//                } else {
//                    $studentList['file_path'] = [];
//                }
//                if ($params['platform'] != 'ios') {
                if($this->config->item('filePathBase64') == true) {
                    $base64UploadAnswer = base64_encode(base64_encode(base64_encode(base64_encode($studentContentAnnotation[0]['upload_answer']))));
                }

                if ($this->config->item('filePathBase64') == true && $params['platform'] != "ios") {
                    if ($studentContentAnnotation[0]['upload_answer'] != '' && $studentContentAnnotation[0]['upload_answer'] != '[]') {
                        $studentList['upload_answer'] = $base64UploadAnswer;
                    } else {
                        $studentList['upload_answer'] = [];
                    }
                } else {
                    if($studentContentAnnotation[0]['upload_answer'] != '' && $studentContentAnnotation[0]['upload_answer'] != '[]'){
                        $studentList['upload_answer'] = json_decode($studentContentAnnotation[0]['upload_answer']);
                    } else {
                        $studentList['upload_answer'] = [];
                    }
                }

                if ($params['platform'] != 'ios') {
                    if ($studentContentAnnotation[0]['answer_sheet_annotation'] != '' && $studentContentAnnotation[0]['answer_sheet_annotation'] != '[]') {
                        $answerAnnotation = $this->common_model->annotation($studentContentAnnotation[0]['answer_sheet_annotation']);
                        $studentList['answer_sheet_annotation'] = json_decode($answerAnnotation);
                    } else {
                        $studentList['answer_sheet_annotation'] = [];
                    }
                }
                if ($params['platform'] == 'web') {
                    $studentList['base64_data'] = $studentContentAnnotation[0]['base64_data'];
                }
                if ($studentContentAnnotation[0]['annotation'] != "" && $studentContentAnnotation[0]['annotation'] != "[]") {
                    $annotation = $this->common_model->annotation($studentContentAnnotation[0]['annotation']);
                    $studentList['annotation'] =json_decode($annotation);
                } else {
                    $studentList['annotation'] = [];
                }
                if ($studentContentAnnotation[0]['teacher_annotation'] != "" && $studentContentAnnotation[0]['teacher_annotation'] != "[]") {
                    $teacherAnnotation = $this->common_model->annotation($studentContentAnnotation[0]['teacher_annotation']);
                    $studentList['teacher_annotation'] = json_decode($teacherAnnotation);
                } else {
                    $studentList['teacher_annotation'] = [];
                }
                if ($studentContentAnnotation[0]['student_annotation'] != "" && $studentContentAnnotation[0]['student_annotation'] != "[]") {
                    $studentAnnotation = $this->common_model->annotation($studentContentAnnotation[0]['student_annotation']);
                    $studentList['student_annotation'] = json_decode($studentAnnotation);
                } else {
                    $studentList['student_annotation'] = [];
                }
                if ($params['platform'] == "ios") {
                    $studentList['overall_student_feedback'] = $studentContentAnnotation[0]['overall_student_feedback'];
                } else {
                    if ($studentContentAnnotation[0]['questionAnnotation'] != '' && $studentContentAnnotation[0]['questionAnnotation'] != '[]') {
                        $questionAnnotation = $this->common_model->annotation($studentContentAnnotation[0]['questionAnnotation']);
                        $studentList['question_annotation'] = json_decode($questionAnnotation);
                    } else {
                        $studentList['question_annotation'] = [];
                    }
                    $studentList['student_feedback'] = $studentContentAnnotation[0]['overall_student_feedback'];
                }
                $studentList['feedback'] = $studentContentAnnotation[0]['feedback'];
                $studentList['points'] = $studentContentAnnotation[0]['points'];
                $studentList['earned_points'] = $studentContentAnnotation[0]['earned_points'];
                $answerList = $this->answerFormation($allAnswerList,$params);
                if($params['content_format'] == 1) {
                    $studentList['answers'] = $answerList;
                } elseif($params['content_format'] == 3) {
                    if (count($answerList) > 0) {
                        $studentList['answers'] = array_values($answerList[0]['questions']);
                    } else {
                        $studentList['answers'] = [];
                    }
                }
                $studentList['student_content_id'] = $params['student_content_id'];
                $this->jsonarr["IsSuccess"] = true;
                $this->jsonarr['ResponseObject'] = $studentList;
            } else {
                $list = $this->teacher_model->studentidList($params);
                if(count($list) > 0) {
                    foreach ($list as $key => $value) {
                        $studentList[$key]['student_id'] = $value['student_id'];
                        $studentList[$key]['content_id'] = $value['content_id'];
                        $studentList[$key]['class_id'] = $value['class_id'];
                        $params['student_id'] = $value['student_id'];
                        $allAnswerList = $this->teacher_model->studentcontentIdList($params);
                        $answerList = $this->answerFormation($allAnswerList,$params);
                        if($params['content_format'] == 1) {
                            $studentList[$key]['answers'] = $answerList;
                        } elseif($params['content_format'] == 3) {
                            $studentList[$key]['answers'] = $answerList[0]['questions'];
                        }
                    }
                    $this->jsonarr["IsSuccess"] = true;
                    $this->jsonarr['ResponseObject'] = array_values($studentList);
                } else {
                    $this->jsonarr['IsSuccess'] = false;
                    $this->jsonarr['ErrorObject'] = 'Not Found';
                }
            }
        }
        $this->common_model->createLog($params,'v1/teacher/studentAnswerList',$this->jsonarr,'studentAnswerList');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function teacherCorrection_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/teacherCorrection','only request','teacherCorrection');
            $condition=array("id"=>$params['student_content_id']);
            $user=[];
            if (isset($params['annotation'])) {
                $user['teacher_annotation'] = json_encode($params['annotation']);
            }
            $user['feedback'] = $params['feedback'];
            $user['earned_points'] = $params['earned_points'];
            $user['points'] = $params['points'];
            //$user['answer_sheet_annotation'] = isset($params['answer_sheet_correction']) ? json_encode($params['answer_sheet_correction']) : '';
            $user['correction_completed_date'] = date('Y-m-d H:i:s');
            if($params['type'] == 1) {
                $user['status'] = 5;
            } elseif ($params['type']==2) {
                $user['status'] = 6;
            }
            $update=$this->common_model->update('student_content', $user, $condition);
            $work = array(
                'student_content_status' => $params['type'] == 1 ? 5 : 6,
                'total_score' => $params['points'],
                'obtained_score' => $params['earned_points'],
                'correction_completed_date' => date('Y-m-d H:i:s')
            );
            $condition = array("student_content_id" => $params['student_content_id']);
            $studentworkupdated = $this->common_model->update('student_work',$work,$condition);
            if ($update) {
                if (isset($params['content_format']) && $params['content_format'] == 3) {
                    for ($i = 0; $i < count($params['answers']); $i++) {
                        if ($params['answers'][$i]['question_type_id'] == 24) {
                            for ($j = 0; $j < count($params['answers'][$i]['subQuestions']); $j++) {
                                $data = [];
                                $condition = array("answer_id" => $params['answers'][$i]['subQuestions'][$j]['question_id'], "student_content_id" => $params['student_content_id']);
                                $data['feedback'] = $params['answers'][$i]['subQuestions'][$j]['feedback'];
                                $data['correction_status'] = isset($params['answers'][$i]['subQuestions'][$j]['correction_status']) ? $params['answers'][$i]['subQuestions'][$j]['correction_status'] : 0;
                                $data['earned_points'] = $params['answers'][$i]['subQuestions'][$j]['given_points'];
                                if ($params['answers'][$i]['subQuestions'][$j]['given_points'] != '' &&
                                    $params['answers'][$i]['subQuestions'][$j]['given_points'] != 0) {
                                    $data['answer_status'] = 2;
                                } else {
                                    $data['answer_status'] = 1;
                                }
                                $data['modified_by'] = $params['user_id'];
                                $data['modified_date'] = date('Y-m-d H:i:s');
                                $this->common_model->update('student_answers', $data, $condition);
                            }
                        } else {
                            $data = [];
                            $condition = array("answer_id" => $params['answers'][$i]['question_id'], "student_content_id" => $params['student_content_id']);
                            $data['feedback'] = $params['answers'][$i]['feedback'];
                            $data['earned_points'] = $params['answers'][$i]['given_points'];
                            $data['correction_status'] = $params['answers'][$i]['correction_status'];
                            if ($params['answers'][$i]['given_points'] != '' &&
                                $params['answers'][$i]['given_points'] != 0) {
                                $data['answer_status'] = 2;
                            } else {
                                $data['answer_status'] = 1;
                            }
                            $data['modified_by'] = $params['user_id'];
                            $data['modified_date'] = date('Y-m-d H:i:s');
                            $this->common_model->update('student_answers', $data, $condition);
                        }
                    }
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = "Correction Saved Successfully";
                } else {
                    $count = 0;
                    $cnt = 0;
                    $data = array();
                    $newData = array();
                    for ($i = 0; $i < count($params['answers']); $i++) {
                        for ($z = 0; $z < count($params['answers'][$i]['section']); $z++) {
                            for ($j = 0; $j < count($params['answers'][$i]['section'][$z]['sub_questions']); $j++) {
                                $checkAnswerExists = $this->teacher_model->checkAnswerExists($params['answers'][$i]['section'][$z]['sub_questions'][$j]['answer_id'],$params);
                                if($checkAnswerExists) {
                                    //$condition = array("answer_id" => $params['answers'][$i]['section'][$z]['sub_questions'][$j]['answer_id'], "content_id" => $params['content_id'], "student_id" => $params['student_id'], "class_id" => $params['class_id']);
                                    $data[$count]['answer_id'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['answer_id'];
                                    $data[$count]['feedback'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['feedback'];
                                    $data[$count]['earned_points'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['given_points'];
                                    if ($params['answers'][$i]['section'][$z]['sub_questions'][$j]['given_points'] != '' &&
                                        $params['answers'][$i]['section'][$z]['sub_questions'][$j]['given_points'] != 0) {
                                        $data[$count]['answer_status'] = 2;
                                    } else {
                                        $data[$count]['answer_status'] = 4;
                                    }
                                    $data[$count]['correction_status'] = isset($params['answers'][$i]['section'][$z]['sub_questions'][$j]['correction_status']) ? $params['answers'][$i]['section'][$z]['sub_questions'][$j]['correction_status'] : 0;
                                    $data[$count]['modified_by'] = $params['user_id'];
                                    $data[$count]['modified_date'] = date('Y-m-d H:i:s');
                                    //$this->common_model->update('student_answers', $data, $condition);
                                    $count++;
                                } else {
                                    $newData[$cnt]['answer_id'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['answer_id'];
                                    $newData[$cnt]['question_no'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['question_no'];
                                    $newData[$cnt]['class_id'] = $params['class_id'];
                                    $newData[$cnt]['student_id'] = $params['student_id'];
                                    $newData[$cnt]['content_id'] = $params['content_id'];
                                    $newData[$cnt]['student_content_id'] = $params['student_content_id'];
                                    $newData[$cnt]['feedback'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['feedback'];
                                    $newData[$cnt]['earned_points'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['given_points'];
                                    $newData[$cnt]['answer_status'] = $params['answers'][$i]['section'][$z]['sub_questions'][$j]['given_points'] != 0 ? 2 : 4;
                                    $newData[$cnt]['correction_status'] = isset($params['answers'][$i]['section'][$z]['sub_questions'][$j]['correction_status']) ? $params['answers'][$i]['section'][$z]['sub_questions'][$j]['correction_status'] : 0;
                                    $newData[$cnt]['created_by'] = $params['user_id'];
                                    $newData[$cnt]['created_date'] = date('Y-m-d H:i:s');
                                    $cnt++;
                                }
                            }
                        }
                    }
                    if(count($newData) > 0){
                        $this->common_model->bulkInsert('student_answers', $newData);
                    }
                    if (count($data) > 0) {
                        if (count($data) > 100) {

                            $chunk_result = array_chunk($data, 100, true);
                            foreach ($chunk_result as $chunk) {
                                $this->common_model->updateBatchMultiple('student_answers', $chunk, 'answer_id', $params['student_content_id']);
                            }
                        } else {
                            $this->common_model->updateBatchMultiple('student_answers', $data, 'answer_id', $params['student_content_id']);
                        }
                    }
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = "Correction Saved Successfully";
                }
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr["ErrorObject"] = "Unable to do Teacher Correction";
            }
        }
        $this->common_model->createLog($params,'v1/teacher/teacherCorrection',$this->jsonarr,'teacherCorrection');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function getQuestions_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        }elseif ($params['content_format'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Format should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/getQuestions','only request','getQuestions');
            $question = $this->teacher_model->getquestions($params);
            foreach ($question as $key=> $value){
                $question[$key]['question_name']="Question".' '.$value['question_no'];
            }
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $question;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/getQuestions',$this->jsonarr,'getQuestions');
        return $this->printjson($this->jsonarr);
    }

    public function releaseScore_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        }elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif (count($this->jsonarr)==0) {
            $this->common_model->createLog($params,'v1/teacher/releaseScore','only request','releaseScore');
            $updated = false;
            if (count($params['student_id']) > 0) {
                for ($i = 0; $i < count($params['student_content_id']); $i++) {
                    $condition = array("id" => $params['student_content_id'][$i]);
                    $condition1 = array("student_content_id" => $params['student_content_id'][$i]);
                    $data = [];
                    //status 3 verified and released score
                    $data['status'] = 3;
                    $data['release_score'] = $params['release_score'];
                    $data['score_release_date'] = date('Y-m-d H:i:s');
                    $updated = $this->common_model->update('student_content', $data, $condition);
                    $work = array(
                        'student_content_status' => 3,
                        'score_released' => $params['release_score'],
                        'score_release_date' => date('Y-m-d H:i:s')
                    );
                    $studentworkupdated = $this->common_model->update('student_work',$work,$condition1);
                }
            }
            if ($updated) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Score Released Successfully";
            }else{
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ErrorObject'] = "Unable to Update Score";
            }
        }
        $this->common_model->createLog($params,'v1/teacher/releaseScore',$this->jsonarr,'releaseScore');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function releaseScoreAll_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        }elseif ($params['release_score'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Release_Score should not be empty";
        }  elseif (count($this->jsonarr)==0) {
            $this->common_model->createLog($params,'v1/teacher/releaseScoreAll','only request','releaseScoreAll');
            $updated = false;
            foreach ($params['student_list'] as $key => $value){
                $condition = array('id' => $value['student_content_id']);
                $condition1 = array('student_content_id' => $value['student_content_id']);
                $data = [];
                //status 3 verified and released score
                $data['status'] = 3;
                $data['release_score'] = $params['release_score'];
                $data['score_release_date'] = date('Y-m-d H:i:s');
                $updated = $this->common_model->update('student_content', $data, $condition);
                $work = array(
                    'student_content_status' => 3,
                    'score_released' => $params['release_score'],
                    'score_release_date' => date('Y-m-d H:i:s')
                );
                $studentworkupdated = $this->common_model->update('student_work',$work,$condition1);
            }
            if ($updated) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Score Released Successfully";
            }else{
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ErrorObject'] = "Unable to Update Score";
            }
        }
        $this->common_model->createLog($params,'v1/teacher/releaseScoreAll',$this->jsonarr,'releaseScoreAll');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    private function printjson($jsonarr)
    {
        echo json_encode($jsonarr);
    }

    public function answerFormation($allAnswerList,$params) {
        $answerList = [];
        if($params['content_format'] == 1) {
            usort($allAnswerList, function ($a, $b) {
                if ($a['display_order'] === $b['display_order']) {
                    return $a['answer_id'] <=> $b['answer_id'];
                }
                return $a['display_order'] <=> $b['display_order'];
            });
            //usort($allAnswerList,function ($a,$b) {
            //    return $a['question_no'] <=> $b['question_no'];
            //});
            //usort($allAnswerList,function ($a,$b) {
            //    return $a['sub_question_no'] <=> $b['sub_question_no'];
            //});
            $allAnswerList = $this->group_by('heading',$allAnswerList);
            $subQ = 0;
            $tempSubQuestionsArray = [];
            for ($i = 0; $i < count($allAnswerList); $i++) {
                $dataAvailable = false;
                for ($j = 0; $j < count($answerList); $j++) {
//                    if ($allAnswerList[$i]['heading'] != "") {
                    if ($answerList[$j]['heading'] == $allAnswerList[$i]['heading']) {
                        $dataAvailable = true;
                    }
//                    }
                }
                $c = count($answerList);
                if (!$dataAvailable) {
                    if (count($answerList) >= 1) {
                        if ($answerList[$c - 1]['heading'] == $allAnswerList[$i]['heading']) {
                            if ($answerList[$c - 1]['section'][0]['sub_questions'][0]['question_no'] == $allAnswerList[$i]['question_no']) {
                                $tempSubQuestionsArray[$subQ]['answer_id'] = $allAnswerList[$i]['answer_id'];
                                $tempSubQuestionsArray[$subQ]['question_no'] = $allAnswerList[$i]['question_no'];
                                $tempSubQuestionsArray[$subQ]['question'] = $allAnswerList[$i]['question'];
                                $tempSubQuestionsArray[$subQ]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                                $tempSubQuestionsArray[$subQ]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                $tempSubQuestionsArray[$subQ]['options'] = $allAnswerList[$i]['options'];
                                $tempSubQuestionsArray[$subQ]['array'] = json_decode($allAnswerList[$i]['array']);
                                $tempSubQuestionsArray[$subQ]['mob_options'] = $allAnswerList[$i]['mob_options'] != '' ? json_decode($allAnswerList[$i]['mob_options']) : [];
                                if($allAnswerList[$i]['question_type_id'] == 54) {
                                    $tempSubQuestionsArray[$subQ]['mob_answer'] = $allAnswerList[$i]['answer'] != '' ? json_decode($allAnswerList[$i]['answer']) : [];
                                } else {
                                    $tempSubQuestionsArray[$subQ]['mob_answer'] = [];
                                }
                                if ($allAnswerList[$i]['question_type_id'] == 40) {
                                    $tempSubQuestionsArray[$subQ]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    if ($params['platform'] != 'ios') {
                                        $tempSubQuestionsArray[$subQ]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                                    }
                                } else {
                                  //  $tempSubQuestionsArray[$subQ]['answer'] = $allAnswerList[$i]['answer'];
                                    $tempSubQuestionsArray[$subQ]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    if ($params['platform'] == 'ios') {
                                        if (in_array($allAnswerList[$i]['student_answer'], $tempSubQuestionsArray[$subQ]['answer'])) {
                                            $tempSubQuestionsArray[$subQ]['answer'] = $allAnswerList[$i]['student_answer'];
                                        } else {
                                            $tempSubQuestionsArray[$subQ]['answer'] = $tempSubQuestionsArray[$subQ]['answer'][0];
                                        }
                                    }

                                }
                                if ($allAnswerList[$i]['question_type_id'] == 54) {
                                    if ($params['platform'] == 'web') {
                                        $tempSubQuestionsArray[$subQ]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['answer'] = '';
                                    }
                                }
//                                if ($params['platform'] != 'ios') {
                                $tempSubQuestionsArray[$subQ]['answer_explanation'] = $allAnswerList[$i]['answer_explanation'];
//                                }
                                $tempSubQuestionsArray[$subQ]['auto_grade'] = $allAnswerList[$i]['auto_grade'];
                                $tempSubQuestionsArray[$subQ]['points'] = $allAnswerList[$i]['points'];
                                $tempSubQuestionsArray[$subQ]['given_points'] = $allAnswerList[$i]['earned_points'];
                                $tempSubQuestionsArray[$subQ]['feedback'] = $allAnswerList[$i]['feedback'];
                                $tempSubQuestionsArray[$subQ]['difficulty'] = $allAnswerList[$i]['difficulty'];
                                $tempSubQuestionsArray[$subQ]['allow_exact_match'] = $allAnswerList[$i]['allow_exact_match'];
                                $tempSubQuestionsArray[$subQ]['allow_any_text'] = $allAnswerList[$i]['allow_any_text'];
                                $tempSubQuestionsArray[$subQ]['match_case'] = $allAnswerList[$i]['match_case'];
                                $tempSubQuestionsArray[$subQ]['minimum_line'] = $allAnswerList[$i]['minimum_line'];
                                if ($allAnswerList[$i]['question_type_id'] == 40 || $allAnswerList[$i]['question_type_id'] == 54) {
                                    if ($params['platform'] == 'web') {
                                        if ($allAnswerList[$i]['student_answer'] != '' || $allAnswerList[$i]['editor_answer'] != '') {
                                            $tempSubQuestionsArray[$subQ]['student_answer'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                            $tempSubQuestionsArray[$subQ]['editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                        } else {
                                            $tempSubQuestionsArray[$subQ]['student_answer'] = [];
                                            $tempSubQuestionsArray[$subQ]['editor_answer'] = '';
                                        }
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                        if ($allAnswerList[$i]['question_type_id'] == 54 && $allAnswerList[$i]['student_answer'] != '') {
                                            $tempSubQuestionsArray[$subQ]['mob_options'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                        } else {
                                            $tempSubQuestionsArray[$subQ]['mob_options'] = [];
                                        }
                                    }
                                } else {
                                    $tempSubQuestionsArray[$subQ]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                }
                                $tempSubQuestionsArray[$subQ]['student_roughwork'] = $allAnswerList[$i]['student_roughwork'];
                                $tempSubQuestionsArray[$subQ]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                                $tempSubQuestionsArray[$subQ]['rough_image_thumb_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                                $tempSubQuestionsArray[$subQ]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                                if ($params['platform'] == 'web') {
                                    $tempSubQuestionsArray[$subQ]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                                    $tempSubQuestionsArray[$subQ]['correction_status'] = $allAnswerList[$i]['correction_status'];
                                    if(isset($allAnswerList[$i]['workarea']) && $allAnswerList[$i]['workarea'] != ''){
                                        $workarea = $this->common_model->annotation($allAnswerList[$i]['workarea']);
                                        $tempSubQuestionsArray[$subQ]['workarea'] = json_decode($workarea);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['workarea']= [];
                                    }
                                    if(is_null($tempSubQuestionsArray[$subQ]['workarea'])) {
                                        $tempSubQuestionsArray[$subQ]['workarea'] = [];
                                    }
                                }
                                $tempSubQuestionsArray[$subQ]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                                array_push($answerList[$c - 1]['section'][0]['sub_questions'], $tempSubQuestionsArray[0]);
                            } else {
                                $answerList[$c]['heading'] = $allAnswerList[$i]['heading'];
                                $answerList[$c]['section'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['answer_id'] = $allAnswerList[$i]['answer_id'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['question'] = $allAnswerList[$i]['question'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['question_type_id'] = -$allAnswerList[$i]['question_type_id'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['options'] = $allAnswerList[$i]['options'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['array'] = json_decode($allAnswerList[$i]['array']);
                                $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = $allAnswerList[$i]['mob_options'] != '' ? json_decode($allAnswerList[$i]['mob_options']) : [];
                                if($allAnswerList[$i]['question_type_id'] == 54) {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['mob_answer'] =  $allAnswerList[$i]['answer'] != '' ? json_decode($allAnswerList[$i]['answer']) : [];
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['mob_answer'] = [];
                                }
                                if ($allAnswerList[$i]['question_type_id'] == 40) {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    if ($params['platform'] != 'ios') {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                                    }
                                } else {
                                  //  $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $allAnswerList[$i]['answer'];
                                    $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    if ($params['platform'] == 'ios') {
                                        if (in_array($allAnswerList[$i]['student_answer'], $answerList[$c]['section'][0]['sub_questions'][0]['answer'])) {
                                            $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $allAnswerList[$i]['student_answer'];
                                        } else {
                                            $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $answerList[$c]['section'][0]['sub_questions'][0]['answer'][0];
                                        }
                                    }
                                }
                                if ($allAnswerList[$i]['question_type_id'] == 54) {
                                    if ($params['platform'] == 'web') {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    } else {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = '';
                                    }
                                }
//                                if ($params['platform'] != 'ios') {
                                $answerList[$c]['section'][0]['sub_questions'][0]['answer_explanation'] = $allAnswerList[$i]['answer_explanation'];
//                                }
                                $answerList[$c]['section'][0]['sub_questions'][0]['auto_grade'] = $allAnswerList[$i]['auto_grade'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['points'] = $allAnswerList[$i]['points'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['given_points'] = $allAnswerList[$i]['earned_points'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['feedback'] = $allAnswerList[$i]['feedback'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['difficulty'] = $allAnswerList[$i]['difficulty'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['allow_exact_match'] = $allAnswerList[$i]['allow_exact_match'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['allow_any_text'] = $allAnswerList[$i]['allow_any_text'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['match_case'] = $allAnswerList[$i]['match_case'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['minimum_line'] = $allAnswerList[$i]['minimum_line'];
                                if ($allAnswerList[$i]['question_type_id'] == 40 || $allAnswerList[$i]['question_type_id'] == 54) {
                                    if ($params['platform'] == 'web') {
                                        if ($allAnswerList[$i]['student_answer'] != '' || $allAnswerList[$i]['editor_answer'] != '') {
                                            $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                            $answerList[$c]['section'][0]['sub_questions'][0]['editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                        } else {
                                            $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = [];
                                            $answerList[$c]['section'][0]['sub_questions'][0]['editor_answer'] = '';
                                        }
                                    } else {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                        if ($allAnswerList[$i]['question_type_id'] == 54 && $allAnswerList[$i]['student_answer'] != '') {
                                            $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                        }
                                    }
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                }
                                $answerList[$c]['section'][0]['sub_questions'][0]['student_roughwork'] = $allAnswerList[$i]['student_roughwork'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['rough_image_thumb_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                                if ($params['platform'] == 'web') {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                                    $answerList[$c]['section'][0]['sub_questions'][0]['correction_status'] = $allAnswerList[$i]['correction_status'];
                                    if(isset($allAnswerList[$i]['workarea']) && $allAnswerList[$i]['workarea'] != ''){
                                        $workarea = $this->common_model->annotation($allAnswerList[$i]['workarea']);
                                        $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = json_decode($workarea);
                                    } else {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = [];
                                    }
                                    if(is_null($answerList[$c]['section'][0]['sub_questions'][0]['workarea'])) {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = [];
                                    }

                                }
                                $answerList[$c]['section'][0]['sub_questions'][0]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                            }
                        } else {
                            $answerList[$c]['heading'] = $allAnswerList[$i]['heading'];
                            $answerList[$c]['section'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['answer_id'] = $allAnswerList[$i]['answer_id'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['question'] = $allAnswerList[$i]['question'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['options'] = $allAnswerList[$i]['options'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['array'] = json_decode($allAnswerList[$i]['array']);
                            $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = $allAnswerList[$i]['mob_options'] != '' ? json_decode($allAnswerList[$i]['mob_options']) : [];
                            if($allAnswerList[$i]['question_type_id'] == 54) {
                                $answerList[$c]['section'][0]['sub_questions'][0]['mob_answer'] = $allAnswerList[$i]['answer'] != '' ? json_decode($allAnswerList[$i]['answer']) : [];
                            } else {
                                $answerList[$c]['section'][0]['sub_questions'][0]['mob_answer'] = [];
                            }
                            if ($allAnswerList[$i]['question_type_id'] == 40) {
                                $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                if ($params['platform'] != 'ios') {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                                }
                            } else {
                               // $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $allAnswerList[$i]['answer'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                if ($params['platform'] == 'ios') {
                                    if (in_array($allAnswerList[$i]['student_answer'], $answerList[$c]['section'][0]['sub_questions'][0]['answer'])) {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $allAnswerList[$i]['student_answer'];
                                    } else {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $answerList[$c]['section'][0]['sub_questions'][0]['answer'][0];
                                    }
                                }
                            }
                            if ($allAnswerList[$i]['question_type_id'] == 54) {
                                if ($params['platform'] == 'web') {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = '';
                                }
                            }
//                            if ($params['platform'] != 'ios') {
                            $answerList[$c]['section'][0]['sub_questions'][0]['answer_explanation'] = $allAnswerList[$i]['answer_explanation'];
//                            }
                            $answerList[$c]['section'][0]['sub_questions'][0]['auto_grade'] = $allAnswerList[$i]['auto_grade'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['points'] = $allAnswerList[$i]['points'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['given_points'] = $allAnswerList[$i]['earned_points'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['feedback'] = $allAnswerList[$i]['feedback'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['difficulty'] = $allAnswerList[$i]['difficulty'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['allow_exact_match'] = $allAnswerList[$i]['allow_exact_match'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['allow_any_text'] = $allAnswerList[$i]['allow_any_text'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['match_case'] = $allAnswerList[$i]['match_case'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['minimum_line'] = $allAnswerList[$i]['minimum_line'];
                            if ($allAnswerList[$i]['question_type_id'] == 40 || $allAnswerList[$i]['question_type_id'] == 54) {
                                if ($params['platform'] == 'web') {
                                    if ($allAnswerList[$i]['student_answer'] != '' || $allAnswerList[$i]['editor_answer'] != '') {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                        $answerList[$c]['section'][0]['sub_questions'][0]['editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                    } else {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = [];
                                        $answerList[$c]['section'][0]['sub_questions'][0]['editor_answer'] = '';
                                    }
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                    if ($allAnswerList[$i]['question_type_id'] == 54 && $allAnswerList[$i]['student_answer'] != '') {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                    } else {
                                        $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = [];
                                    }
                                }
                            } else {
                                $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                            }
                            $answerList[$c]['section'][0]['sub_questions'][0]['student_roughwork'] = $allAnswerList[$i]['student_roughwork'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['rough_image_thumb_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                            if ($params['platform'] == 'web') {
                                $answerList[$c]['section'][0]['sub_questions'][0]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                                $answerList[$c]['section'][0]['sub_questions'][0]['correction_status'] = $allAnswerList[$i]['correction_status'];
                                if(isset($allAnswerList[$i]['workarea']) && $allAnswerList[$i]['workarea'] != ''){
                                    $workarea = $this->common_model->annotation($allAnswerList[$i]['workarea']);
                                    $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = json_decode($workarea);
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = [];
                                }
                                if(is_null($answerList[$c]['section'][0]['sub_questions'][0]['workarea'])) {
                                $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = [];
                                }
                            }
                            $answerList[$c]['section'][0]['sub_questions'][0]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                        }
                    } else {
                        $answerList[$c]['heading'] = $allAnswerList[$i]['heading'];
                        $answerList[$c]['section'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['answer_id'] = $allAnswerList[$i]['answer_id'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['question'] = $allAnswerList[$i]['question'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['options'] = $allAnswerList[$i]['options'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['array'] = json_decode($allAnswerList[$i]['array']);
                        $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = $allAnswerList[$i]['mob_options'] != '' ? json_decode($allAnswerList[$i]['mob_options']) : [];
                        if($allAnswerList[$i]['question_type_id'] == 54) {
                            $answerList[$c]['section'][0]['sub_questions'][0]['mob_answer'] = $allAnswerList[$i]['answer'] != '' ? json_decode($allAnswerList[$i]['answer']) : [];
                        } else {
                            $answerList[$c]['section'][0]['sub_questions'][0]['mob_answer'] = [];
                        }
                        if ($allAnswerList[$i]['question_type_id'] == 40) {
                            $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                            if ($params['platform'] != 'ios') {
                                $answerList[$c]['section'][0]['sub_questions'][0]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                            }
                        } else {
                           // $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $allAnswerList[$i]['answer'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                            if ($params['platform'] == 'ios') {
                                if (in_array($allAnswerList[$i]['student_answer'], $answerList[$c]['section'][0]['sub_questions'][0]['answer'])) {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $allAnswerList[$i]['student_answer'];
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = $answerList[$c]['section'][0]['sub_questions'][0]['answer'][0];
                                }
                            }
                        }
                        if ($allAnswerList[$i]['question_type_id'] == 54) {
                            if ($params['platform'] == 'web') {
                                $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                            } else {
                                $answerList[$c]['section'][0]['sub_questions'][0]['answer'] = '';
                            }
                        }
//                        if ($params['platform'] != 'ios') {
                        $answerList[$c]['section'][0]['sub_questions'][0]['answer_explanation'] = $allAnswerList[$i]['answer_explanation'];
//                        }
                        $answerList[$c]['section'][0]['sub_questions'][0]['auto_grade'] = $allAnswerList[$i]['auto_grade'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['points'] = $allAnswerList[$i]['points'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['given_points'] = $allAnswerList[$i]['earned_points'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['feedback'] = $allAnswerList[$i]['feedback'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['difficulty'] = $allAnswerList[$i]['difficulty'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['allow_exact_match'] = $allAnswerList[$i]['allow_exact_match'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['allow_any_text'] = $allAnswerList[$i]['allow_any_text'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['match_case'] = $allAnswerList[$i]['match_case'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['minimum_line'] = $allAnswerList[$i]['minimum_line'];
                        if ($allAnswerList[$i]['question_type_id'] == 40 || $allAnswerList[$i]['question_type_id'] == 54) {
                            if ($params['platform'] == 'web') {
                                if ($allAnswerList[$i]['student_answer'] != '' || $allAnswerList[$i]['editor_answer'] != '') {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                    $answerList[$c]['section'][0]['sub_questions'][0]['editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = [];
                                    $answerList[$c]['section'][0]['sub_questions'][0]['editor_answer'] = '';
                                }
                            } else {
                                $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                if ($allAnswerList[$i]['question_type_id'] == 54 && $allAnswerList[$i]['student_answer'] != '') {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                } else {
                                    $answerList[$c]['section'][0]['sub_questions'][0]['mob_options'] = [];
                                }
                            }
                        } else {
                            $answerList[$c]['section'][0]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                        }
                        $answerList[$c]['section'][0]['sub_questions'][0]['student_roughwork'] = $allAnswerList[$i]['student_roughwork'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['rough_image_thumb_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                        $answerList[$c]['section'][0]['sub_questions'][0]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                        if ($params['platform'] == 'web') {
                            $answerList[$c]['section'][0]['sub_questions'][0]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                            $answerList[$c]['section'][0]['sub_questions'][0]['correction_status'] = $allAnswerList[$i]['correction_status'];
                            if(isset($allAnswerList[$i]['workarea']) && $allAnswerList[$i]['workarea'] != ''){
                                $workarea = $this->common_model->annotation($allAnswerList[$i]['workarea']);
                                $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = json_decode($workarea);
                            } else {
                                $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = [];
                            }
                            if(is_null($answerList[$c]['section'][0]['sub_questions'][0]['workarea'])) {
                                $answerList[$c]['section'][0]['sub_questions'][0]['workarea'] = [];
                            }
                        }
                        $answerList[$c]['section'][0]['sub_questions'][0]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                    }
                } else {
                    $subQuestion = 0;
                    $noSubQuestion = 0;
                    $tempSubQuestionsArray = [];
                    if ($answerList[$c-1]['heading'] == $allAnswerList[$i]['heading']) {
                        //$l => count of each heading questions
                        $l = count($answerList[$c-1]['section']) - 1;
                        if (isset($answerList[$c-1]['section'][$l]['sub_questions'])) {
                            //$m => count of each subquestions in a heading
                            $m = count($answerList[$c-1]['section'][$l]['sub_questions']) - 1;
                        }
                        if ($answerList[$c - 1]['section'][$l]['sub_questions'][$m]['question_no'] == $allAnswerList[$i]['question_no']) {
                            $subQuestion = 1;
                            $tempSubQuestionsArray[$subQ]['answer_id'] = $allAnswerList[$i]['answer_id'];
                            $tempSubQuestionsArray[$subQ]['question_no'] = $allAnswerList[$i]['question_no'];
                            $tempSubQuestionsArray[$subQ]['question'] = $allAnswerList[$i]['question'];
                            $tempSubQuestionsArray[$subQ]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                            $tempSubQuestionsArray[$subQ]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                            $tempSubQuestionsArray[$subQ]['options'] = $allAnswerList[$i]['options'];
                            $tempSubQuestionsArray[$subQ]['array'] = json_decode($allAnswerList[$i]['array']);
                            $tempSubQuestionsArray[$subQ]['mob_options'] = $allAnswerList[$i]['mob_options'] != '' ? json_decode($allAnswerList[$i]['mob_options']) : [];
                            if($allAnswerList[$i]['question_type_id'] == 54) {
                                $tempSubQuestionsArray[$subQ]['mob_answer'] = $allAnswerList[$i]['answer'] != '' ? json_decode($allAnswerList[$i]['answer']) : [];
                            } else {
                                $tempSubQuestionsArray[$subQ]['mob_answer'] = [];
                            }
                            if ($allAnswerList[$i]['question_type_id'] == 40) {
                                $tempSubQuestionsArray[$subQ]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                if ($params['platform'] != 'ios') {
                                    $tempSubQuestionsArray[$subQ]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                                }
                            } else {
                               // $tempSubQuestionsArray[$subQ]['answer'] = $allAnswerList[$i]['answer'];
                                $tempSubQuestionsArray[$subQ]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                if ($params['platform'] == 'ios') {
                                    if (in_array($allAnswerList[$i]['student_answer'], $tempSubQuestionsArray[$subQ]['answer'])) {
                                        $tempSubQuestionsArray[$subQ]['answer'] = $allAnswerList[$i]['student_answer'];
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['answer'] = $tempSubQuestionsArray[$subQ]['answer'][0];
                                    }
                                }
                            }
                            if ($allAnswerList[$i]['question_type_id'] == 54) {
                                if ($params['platform'] == 'web') {
                                    $tempSubQuestionsArray[$subQ]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                } else {
                                    $tempSubQuestionsArray[$subQ]['answer'] = '';
                                }
                            }
//                            if ($params['platform'] != 'ios') {
                            $tempSubQuestionsArray[$subQ]['answer_explanation'] = $allAnswerList[$i]['answer_explanation'];
//                            }
                            $tempSubQuestionsArray[$subQ]['auto_grade'] = $allAnswerList[$i]['auto_grade'];
                            $tempSubQuestionsArray[$subQ]['points'] = $allAnswerList[$i]['points'];
                            $tempSubQuestionsArray[$subQ]['given_points'] = $allAnswerList[$i]['earned_points'];
                            $tempSubQuestionsArray[$subQ]['feedback'] = $allAnswerList[$i]['feedback'];
                            $tempSubQuestionsArray[$subQ]['difficulty'] = $allAnswerList[$i]['difficulty'];
                            $tempSubQuestionsArray[$subQ]['allow_exact_match'] = $allAnswerList[$i]['allow_exact_match'];
                            $tempSubQuestionsArray[$subQ]['allow_any_text'] = $allAnswerList[$i]['allow_any_text'];
                            $tempSubQuestionsArray[$subQ]['match_case'] = $allAnswerList[$i]['match_case'];
                            $tempSubQuestionsArray[$subQ]['minimum_line'] = $allAnswerList[$i]['minimum_line'];
                            if ($allAnswerList[$i]['question_type_id'] == 40 || $allAnswerList[$i]['question_type_id'] == 54) {
                                if ($params['platform'] == 'web') {
                                    if ($allAnswerList[$i]['student_answer'] != '' || $allAnswerList[$i]['editor_answer'] != '') {
                                        $tempSubQuestionsArray[$subQ]['student_answer'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                        $tempSubQuestionsArray[$subQ]['editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['student_answer'] = [];
                                        $tempSubQuestionsArray[$subQ]['editor_answer'] = '';
                                    }
                                } else {
                                    $tempSubQuestionsArray[$subQ]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                    if ($allAnswerList[$i]['question_type_id'] == 54 && $allAnswerList[$i]['student_answer'] != '') {
                                        $tempSubQuestionsArray[$subQ]['mob_options'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['mob_options'] = [];
                                    }
                                }
                            } else {
                                $tempSubQuestionsArray[$subQ]['student_answer'] = $allAnswerList[$i]['student_answer'];
                            }
                            $tempSubQuestionsArray[$subQ]['student_roughwork'] = $allAnswerList[$i]['student_roughwork'];
                            $tempSubQuestionsArray[$subQ]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                            $tempSubQuestionsArray[$subQ]['rough_image_thumb_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                            $tempSubQuestionsArray[$subQ]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                            if ($params['platform'] == 'web') {
                                $tempSubQuestionsArray[$subQ]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                                $tempSubQuestionsArray[$subQ]['correction_status'] = $allAnswerList[$i]['correction_status'];
                                if(isset($allAnswerList[$i]['workarea']) && $allAnswerList[$i]['workarea'] != ''){
                                    $workarea = $this->common_model->annotation($allAnswerList[$i]['workarea']);
                                    $tempSubQuestionsArray[$subQ]['workarea'] = json_decode($workarea);
                                } else {
                                    $tempSubQuestionsArray[$subQ]['workarea'] = [];
                                }
                                if(is_null($tempSubQuestionsArray[$subQ]['workarea'])) {
                                    $tempSubQuestionsArray[$subQ]['workarea'] = [];
                                }
                            }
                            $tempSubQuestionsArray[$subQ]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                        } else {
                            $noSubQuestion = 1;
                            $tempSubQuestionsArray[$subQ]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer_id'] = $allAnswerList[$i]['answer_id'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['question'] = $allAnswerList[$i]['question'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['options'] = $allAnswerList[$i]['options'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['array'] = json_decode($allAnswerList[$i]['array']);
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['mob_options'] = $allAnswerList[$i]['mob_options'] != '' ? json_decode($allAnswerList[$i]['mob_options']) : [];
                            if($allAnswerList[$i]['question_type_id'] == 54) {
                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['mob_answer'] = $allAnswerList[$i]['answer'] != '' ? json_decode($allAnswerList[$i]['answer']) : [];
                            } else {
                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['mob_answer'] = [];
                            }
                            if ($allAnswerList[$i]['question_type_id'] == 40) {
                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                if ($params['platform'] != 'ios') {
                                    $tempSubQuestionsArray[$subQ]['sub_questions'][0]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                                }
                            } else {
                              //  $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'] = $allAnswerList[$i]['answer'];
                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                if ($params['platform'] == 'ios') {
                                    if (in_array($allAnswerList[$i]['student_answer'], $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'])) {
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'] = $allAnswerList[$i]['student_answer'];
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'] = $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'][0];
                                    }
                                }
                            }
                            if ($allAnswerList[$i]['question_type_id'] == 54) {
                                if ($params['platform'] == 'web') {
                                    $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                } else {
                                    $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer'] = '';
                                }
                            }
//                            if ($params['platform'] != 'ios') {
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['answer_explanation'] = $allAnswerList[$i]['answer_explanation'];
//                            }
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['auto_grade'] = $allAnswerList[$i]['auto_grade'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['points'] = $allAnswerList[$i]['points'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['given_points'] = $allAnswerList[$i]['earned_points'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['feedback'] = $allAnswerList[$i]['feedback'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['difficulty'] = $allAnswerList[$i]['difficulty'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['allow_exact_match'] = $allAnswerList[$i]['allow_exact_match'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['allow_any_text'] = $allAnswerList[$i]['allow_any_text'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['match_case'] = $allAnswerList[$i]['match_case'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['minimum_line'] = $allAnswerList[$i]['minimum_line'];
                            if($allAnswerList[$i]['question_type_id'] == 40 || $allAnswerList[$i]['question_type_id'] == 54) {
                                if ($params['platform'] == 'web') {
                                    if ($allAnswerList[$i]['student_answer'] != '' || $allAnswerList[$i]['editor_answer'] != '') {
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_answer'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_answer'] = [];
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['editor_answer'] = '';
                                    }
                                } else {
                                    $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                                    if ($allAnswerList[$i]['question_type_id'] == 54 && $allAnswerList[$i]['student_answer'] != '') {
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['mob_options'] = (json_decode($allAnswerList[$i]['student_answer'], true) == NULL) ? json_decode(stripslashes($allAnswerList[$i]['student_answer'])) : json_decode($allAnswerList[$i]['student_answer'], true);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['sub_questions'][0]['mob_options'] = [];
                                    }
                                }
                            } else {
                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_answer'] = $allAnswerList[$i]['student_answer'];
                            }
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_roughwork'] = $allAnswerList[$i]['student_roughwork'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['rough_image_thumb_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                            if ($params['platform'] == 'web') {
                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                                $tempSubQuestionsArray[$subQ]['sub_questions'][0]['correction_status'] = $allAnswerList[$i]['correction_status'];
                                if(isset($allAnswerList[$i]['workarea']) && $allAnswerList[$i]['workarea'] != ''){
                                    $workarea = $this->common_model->annotation($allAnswerList[$i]['workarea']);
                                    $tempSubQuestionsArray[$subQ]['sub_questions'][0]['workarea'] = json_decode($workarea);
                                } else {
                                    $tempSubQuestionsArray[$subQ]['sub_questions'][0]['workarea'] = [];
                                }
                                if(is_null($tempSubQuestionsArray[$subQ]['sub_questions'][0]['workarea'])) {
                                    $tempSubQuestionsArray[$subQ]['sub_questions'][0]['workarea'] = [];
                                }
                            }
                            $tempSubQuestionsArray[$subQ]['sub_questions'][0]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                        }
                        if (count($tempSubQuestionsArray) > 0) {
                            if ($subQuestion > 0) {
                                $check = array_search($allAnswerList[$i]['answer_id'], $answerList[$c-1]['section'][$l]['sub_questions'][$m]);
                                if (!$check) {
                                    array_push($answerList[$c-1]['section'][$l]['sub_questions'], $tempSubQuestionsArray[0]);
                                }
                            } elseif ($noSubQuestion > 0) {
                                $check = array_search($allAnswerList[$i]['answer_id'], $answerList[$c-1]['section'][$l]['sub_questions'][$m]);
                                if (!$check) {
                                    array_push($answerList[$c-1]['section'], $tempSubQuestionsArray[0]);
                                }
                            }
                        }
                    }
                }
            }
        } else if($params['content_format'] == 3) {
            for ($i = 0; $i < count($allAnswerList); $i++) {
                $dataAvailable = false;
                for ($j = 0; $j < count($answerList); $j++) {
                    for ($l = 0; $l < count($answerList[$j]['questions']); $l++) {
                        if ($answerList[$j]['questions'][$l]['content_id'] == $allAnswerList[$i]['content_id']) {
                            $dataAvailable = true;
                        }
                    }
                }
                if (!$dataAvailable) {
                    $c = count($answerList);
                    if ($allAnswerList[$i]['question_type_id'] != 24) {
                        $answerList[$c]['questions'][0]['question_id'] = $allAnswerList[$i]['question_id'];
                        $answerList[$c]['questions'][0]['content_id'] = $allAnswerList[$i]['content_id'];
                        $answerList[$c]['questions'][0]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                        $answerList[$c]['questions'][0]['editor_context'] = $allAnswerList[$i]['editor_context'];
                        $answerList[$c]['questions'][0]['editor_type'] = $allAnswerList[$i]['editor_type'];
                        $answerList[$c]['questions'][0]['question'] = $allAnswerList[$i]['question'];
                        $answerList[$c]['questions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                        $answerList[$c]['questions'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                        $answerList[$c]['questions'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                        $answerList[$c]['questions'][0]['options'] = json_decode($allAnswerList[$i]['options']);
                        $answerList[$c]['questions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                        if ($allAnswerList[$i]['question_type_id'] == 5 || $allAnswerList[$i]['question_type_id'] == 7) {
                            $answerList[$c]['questions'][0]['heading_option'] = json_decode($allAnswerList[$i]['heading_option']);
                        } else {
                            $answerList[$c]['questions'][0]['heading_option'] = '';
                        }
                        $answerList[$c]['questions'][0]['multiple_response'] = $allAnswerList[$i]['multiple_response'];
                        $answerList[$c]['questions'][0]['audo_grade'] = $allAnswerList[$i]['audo_grade'];
                        $answerList[$c]['questions'][0]['points'] = $allAnswerList[$i]['points'];
                        $answerList[$c]['questions'][0]['exact_match'] = $allAnswerList[$i]['exact_match'];
                        if ($allAnswerList[$i]['hint'] != 0) {
                            $answerList[$c]['questions'][0]['hint'] = json_decode($allAnswerList[$i]['hint']);
                        } else {
                            $answerList[$c]['questions'][0]['hint'] = [];
                        }
                        $answerList[$c]['questions'][0]['given_points'] = $allAnswerList[$i]['earned_points'];
                        $answerList[$c]['questions'][0]['feedback'] = $allAnswerList[$i]['feedback'];
                        $answerList[$c]['questions'][0]['explanation'] = $allAnswerList[$i]['explanation'];
                        $answerList[$c]['questions'][0]['word_limit'] = $allAnswerList[$i]['word_limit'];
                        $answerList[$c]['questions'][0]['scoring_instruction'] = $allAnswerList[$i]['scoring_instruction'];
                        $answerList[$c]['questions'][0]['source'] = $allAnswerList[$i]['source'];
                        $answerList[$c]['questions'][0]['target'] = $allAnswerList[$i]['target'];
                        if ($allAnswerList[$i]['student_answer'] == "") {
                            $answerList[$c]['questions'][0]['student_answer'] = [];
                        } else {
                            $answerList[$c]['questions'][0]['student_answer'] = json_decode($allAnswerList[$i]['student_answer']);
                        }
                        $answerList[$c]['questions'][0]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                        $answerList[$c]['questions'][0]['student_editor_answer'] = $allAnswerList[$i]['editor_answer'];
                        $answerList[$c]['questions'][0]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                        $answerList[$c]['questions'][0]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                        $answerList[$c]['questions'][0]['rough_thumb_image_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                        $answerList[$c]['questions'][0]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                        $answerList[$c]['questions'][0]['jiixdata'] =  $allAnswerList[$i]['jiixdata'];
                        $answerList[$c]['questions'][0]['roughdata'] = $allAnswerList[$i]['roughdata'];
                        if ($params['platform'] == 'web') {
                            $answerList[$c]['questions'][0]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                            $answerList[$c]['questions'][0]['correction_status'] = $allAnswerList[$i]['correction_status'];
                        }
                        if ($params['platform'] == 'ios') {
                            $answerList[$c]['questions'][0]['optionsCopy'] = json_decode($allAnswerList[$i]['optionsCopy']);
                        }
                    } else {
                        $answerList[$c]['questions'][0]['content_id'] = $allAnswerList[$i]['content_id'];
                        $answerList[$c]['questions'][0]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                        $answerList[$c]['questions'][0]['editor_context'] = $allAnswerList[$i]['editor_context'];
                        $answerList[$c]['questions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                        if ($params['platform'] == 'web') {
                            $answerList[$c]['questions'][0]['points'] = $allAnswerList[$i]['total_points'];
                            $answerList[$c]['questions'][0]['given_points'] = $allAnswerList[$i]['total_given_points'];
                        }
                        $answerList[$c]['questions'][0]['subQuestions'][0]['question_id'] = $allAnswerList[$i]['question_id'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['question_type_id'] = $allAnswerList[$i]['sub_question_type_id'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['question_no'] = $allAnswerList[$i]['question_no'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['question'] = $allAnswerList[$i]['question'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['editor_type'] = $allAnswerList[$i]['editor_type'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['options'] = json_decode($allAnswerList[$i]['options']);
                        $answerList[$c]['questions'][0]['subQuestions'][0]['answer'] = json_decode($allAnswerList[$i]['answer']);
                        if ($allAnswerList[$i]['sub_question_type_id'] == 5 || $allAnswerList[$i]['sub_question_type_id'] == 7) {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['heading_option'] = json_decode($allAnswerList[$i]['heading_option']);
                        } else {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['heading_option'] = '';
                        }
                        $answerList[$c]['questions'][0]['subQuestions'][0]['multiple_response'] = $allAnswerList[$i]['multiple_response'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['audo_grade'] = $allAnswerList[$i]['audo_grade'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['points'] = $allAnswerList[$i]['points'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['exact_match'] = $allAnswerList[$i]['exact_match'];
                        if ($allAnswerList[$i]['hint'] != 0) {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['hint'] = json_decode($allAnswerList[$i]['hint']);
                        } else {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['hint'] = [];
                        }
                        $answerList[$c]['questions'][0]['subQuestions'][0]['given_points'] = $allAnswerList[$i]['earned_points'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['feedback'] = $allAnswerList[$i]['feedback'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['explanation'] = $allAnswerList[$i]['explanation'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['word_limit'] = $allAnswerList[$i]['word_limit'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['scoring_instruction'] = $allAnswerList[$i]['scoring_instruction'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['source'] = $allAnswerList[$i]['source'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['target'] = $allAnswerList[$i]['target'];
                        if ($allAnswerList[$i]['student_answer'] == "") {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['student_answer'] = [];
                        } else {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['student_answer'] = json_decode($allAnswerList[$i]['student_answer']);
                        }
                        $answerList[$c]['questions'][0]['subQuestions'][0]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['student_editor_answer'] = $allAnswerList[$i]['editor_answer'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['rough_thumb_image_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['jiixdata'] = $allAnswerList[$i]['jiixdata'];
                        $answerList[$c]['questions'][0]['subQuestions'][0]['roughdata'] = $allAnswerList[$i]['roughdata'];
                        if ($params['platform'] == 'web') {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                            $answerList[$c]['questions'][0]['subQuestions'][0]['correction_status'] = $allAnswerList[$i]['correction_status'];
                        }
                        if ($params['platform'] == 'ios') {
                            $answerList[$c]['questions'][0]['subQuestions'][0]['optionsCopy'] = json_decode($allAnswerList[$i]['optionsCopy']);
                        }
                    }
                } else {
                    $tempSubQuestionsArray = [];
                    $tempSubQuestionsArray1 = [];
                    for ($k = 0; $k < count($answerList); $k++) {
                        $subQ = 0;
                        $count = 0;
                        for ($m = 0; $m < count($answerList[$k]['questions']); $m++) {
                            if ($answerList[$k]['questions'][$m]['content_id'] == $allAnswerList[$i]['content_id']) {
                                if ($allAnswerList[$i]['question_type_id'] != 24) {
                                    $tempSubQuestionsArray[$subQ]['question_id'] = $allAnswerList[$i]['question_id'];
                                    $tempSubQuestionsArray[$subQ]['content_id'] = $allAnswerList[$i]['content_id'];
                                    $tempSubQuestionsArray[$subQ]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                                    $tempSubQuestionsArray[$subQ]['editor_context'] = $allAnswerList[$i]['editor_context'];
                                    $tempSubQuestionsArray[$subQ]['editor_type'] = $allAnswerList[$i]['editor_type'];
                                    $tempSubQuestionsArray[$subQ]['question'] = $allAnswerList[$i]['question'];
                                    $tempSubQuestionsArray[$subQ]['question_no'] = $allAnswerList[$i]['question_no'];
                                    $tempSubQuestionsArray[$subQ]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                    $tempSubQuestionsArray[$subQ]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                                    $tempSubQuestionsArray[$subQ]['options'] = json_decode($allAnswerList[$i]['options']);
                                    $tempSubQuestionsArray[$subQ]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    if ($allAnswerList[$i]['question_type_id'] == 5 || $allAnswerList[$i]['question_type_id'] == 7) {
                                        $tempSubQuestionsArray[$subQ]['heading_option'] = json_decode($allAnswerList[$i]['heading_option']);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['heading_option'] = '';
                                    }
                                    $tempSubQuestionsArray[$subQ]['multiple_response'] = $allAnswerList[$i]['multiple_response'];
                                    $tempSubQuestionsArray[$subQ]['audo_grade'] = $allAnswerList[$i]['audo_grade'];
                                    $tempSubQuestionsArray[$subQ]['points'] = $allAnswerList[$i]['points'];
                                    $tempSubQuestionsArray[$subQ]['exact_match'] = $allAnswerList[$i]['exact_match'];
                                    if ($allAnswerList[$i]['hint'] != []) {
                                        $tempSubQuestionsArray[$subQ]['hint'] = json_decode($allAnswerList[$i]['hint']);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['hint'] = [];
                                    }
                                    $tempSubQuestionsArray[$subQ]['given_points'] = $allAnswerList[$i]['earned_points'];
                                    $tempSubQuestionsArray[$subQ]['feedback'] = $allAnswerList[$i]['feedback'];
                                    $tempSubQuestionsArray[$subQ]['explanation'] = $allAnswerList[$i]['explanation'];
                                    $tempSubQuestionsArray[$subQ]['word_limit'] = $allAnswerList[$i]['word_limit'];
                                    $tempSubQuestionsArray[$subQ]['scoring_instruction'] = $allAnswerList[$i]['scoring_instruction'];
                                    $tempSubQuestionsArray[$subQ]['source'] = $allAnswerList[$i]['source'];
                                    $tempSubQuestionsArray[$subQ]['target'] = $allAnswerList[$i]['target'];
                                    if ($allAnswerList[$i]['student_answer'] == "") {
                                        $tempSubQuestionsArray[$subQ]['student_answer'] = [];
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['student_answer'] = json_decode($allAnswerList[$i]['student_answer']);
                                    }
                                    $tempSubQuestionsArray[$subQ]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                                    $tempSubQuestionsArray[$subQ]['student_editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                    $tempSubQuestionsArray[$subQ]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                                    $tempSubQuestionsArray[$subQ]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                                    $tempSubQuestionsArray[$subQ]['rough_thumb_image_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                                    $tempSubQuestionsArray[$subQ]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                                    $tempSubQuestionsArray[$subQ]['jiixdata'] = $allAnswerList[$i]['jiixdata'];
                                    $tempSubQuestionsArray[$subQ]['roughdata'] = $allAnswerList[$i]['roughdata'];
                                    if ($params['platform'] == 'web') {
                                        $tempSubQuestionsArray[$subQ]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                                        $tempSubQuestionsArray[$subQ]['correction_status'] = $allAnswerList[$i]['correction_status'];
                                    }
                                    if ($params['platform'] == 'ios') {
                                        $tempSubQuestionsArray[$subQ]['optionsCopy'] = json_decode($allAnswerList[$i]['optionsCopy']);
                                    }
                                } else {
                                    $tempSubQuestionsArray[$subQ]['content_id'] = $allAnswerList[$i]['content_id'];
                                    $tempSubQuestionsArray[$subQ]['editor_context'] = $allAnswerList[$i]['editor_context'];
                                    $tempSubQuestionsArray[$subQ]['question_type_id'] = $allAnswerList[$i]['question_type_id'];
                                    $tempSubQuestionsArray[$subQ]['question_no'] = $allAnswerList[$i]['question_no'];
                                    if ($params['platform'] == 'web') {
                                        $tempSubQuestionsArray[$subQ]['points'] = $allAnswerList[$i]['total_points'];
                                        $tempSubQuestionsArray[$subQ]['given_points'] = $allAnswerList[$i]['total_given_points'];
                                    }
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['question_id'] = $allAnswerList[$i]['question_id'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['question_type_id'] = $allAnswerList[$i]['sub_question_type_id'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['question_no'] = $allAnswerList[$i]['question_no'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['sub_question_no'] = $allAnswerList[$i]['sub_question_no'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['has_sub_question'] = $allAnswerList[$i]['has_sub_question'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['question'] = $allAnswerList[$i]['question'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['editor_type'] = $allAnswerList[$i]['editor_type'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['options'] = json_decode($allAnswerList[$i]['options']);
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['answer'] = json_decode($allAnswerList[$i]['answer']);
                                    if ($allAnswerList[$i]['sub_question_type_id'] == 5 || $allAnswerList[$i]['sub_question_type_id'] == 7) {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['heading_option'] = json_decode($allAnswerList[$i]['heading_option']);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['heading_option'] = '';
                                    }
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['multiple_response'] = $allAnswerList[$i]['multiple_response'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['audo_grade'] = $allAnswerList[$i]['audo_grade'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['points'] = $allAnswerList[$i]['points'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['exact_match'] = $allAnswerList[$i]['exact_match'];
                                    if ($allAnswerList[$i]['hint'] != []) {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['hint'] = json_decode($allAnswerList[$i]['hint']);
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['hint'] = [];
                                    }
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['given_points'] = $allAnswerList[$i]['earned_points'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['feedback'] = $allAnswerList[$i]['feedback'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['explanation'] = $allAnswerList[$i]['explanation'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['word_limit'] = $allAnswerList[$i]['word_limit'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['scoring_instruction'] = $allAnswerList[$i]['scoring_instruction'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['source'] = $allAnswerList[$i]['source'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['target'] = $allAnswerList[$i]['target'];
                                    if ($allAnswerList[$i]['student_answer'] == "") {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['student_answer'] = [];
                                    } else {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['student_answer'] = json_decode($allAnswerList[$i]['student_answer']);
                                    }
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['student_feedback'] = $allAnswerList[$i]['student_feedback'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['student_editor_answer'] = $allAnswerList[$i]['editor_answer'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['question_editor_answer'] = $allAnswerList[$i]['question_editor_answer'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['rough_image_url'] = $allAnswerList[$i]['rough_image_url'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['rough_thumb_image_url'] = $allAnswerList[$i]['rough_image_thumb_url'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['student_answer_image'] = $allAnswerList[$i]['student_answer_image'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['jiixdata'] = $allAnswerList[$i]['jiixdata'];
                                    $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['roughdata'] = $allAnswerList[$i]['roughdata'];
                                    if ($params['platform'] == 'web') {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['student_roughdata'] = $allAnswerList[$i]['student_roughdata'];
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['correction_status'] = $allAnswerList[$i]['correction_status'];
                                    }
                                    if ($params['platform'] == 'ios') {
                                        $tempSubQuestionsArray[$subQ]['subQuestions'][$count]['optionsCopy'] = json_decode($allAnswerList[$i]['optionsCopy']);
                                    }

                                    $count++;
                                }
                                array_push($tempSubQuestionsArray1, $tempSubQuestionsArray[0]);
                            }
                        }
                        if (count($tempSubQuestionsArray) > 0) {
                            array_push($answerList[$k]['questions'], $tempSubQuestionsArray1[0]);
                        }
                    }
                }
            }
            $temp = [];
            if (count($answerList) > 0) {
                foreach ($answerList[0]['questions'] as $key => $value) {
                    if ($value['question_type_id'] == 24) {
                        array_push($temp, $value);
                        unset($answerList[0]['questions'][$key]);
                    }
                }
                $tempList = [];
                foreach ($temp as $key => $value) {
                    $data = false;
                    foreach ($tempList as $key1 => $value1) {
                        if ($value1['question_no'] == $value['question_no']) {
                            $data = true;
                        }
                    }
                    if (!$data) {
                        $tempList[$key] = $value;
                    } else {
                        foreach ($tempList as $key1 => $value1) {
                            if ($value1['question_no'] == $value['question_no']) {
                                array_push($tempList[$key1]['subQuestions'], $value['subQuestions'][0]);
                            }
                        }
                    }
                }
                foreach ($tempList as $key => $value) {
                    array_push($answerList[0]['questions'], $tempList[$key]);
                }
                usort($answerList[0]['questions'], function ($a, $b) {
                    return $a['question_no'] <=> $b['question_no'];
                });
            }
        }
        return $answerList;
    }

    public function group_by($key, $data) {
        $result = array();
        $finalData = array();
        foreach($data as $val) {
            if(array_key_exists($key, $val)){
                $result[$val[$key]][] = $val;
            } else {
                $result[""][] = $val;
            }
        }
        foreach ($result as $value) {
            for($i = 0; $i < count($value); $i++) {
                array_push($finalData,$value[$i]);
            }
        }
        return $finalData;
    }

    public function studentContentStatusChange_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Class Id should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Student Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Content Id should not be empty";
        } elseif(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/studentContentStatusChange','only request','studentContentStatusChange');
            if(isset($params['reset_answer']) && $params['reset_answer'] == 1) {
                $resetData = array('status' => 1,
                                   'redo_test' => 2,
                                   'release_score' => 0,
                                   'annotation' => '[]',
                                   'teacher_annotation' => '[]',
                                   'answer_sheet_annotation' => '[]',
                                   'earned_points' => 0,
                                   'feedback' => '',
                                   'student_feedback' => '',
                                   'upload_answer' => '',
                                   'modified_by' => $params['user_id'],
                                   'modified_date' => date('Y-m-d H:i:s'));
                $resetCondition = array('content_id' => $params['content_id'],
                                        'class_id' => $params['class_id'],
                                        'student_id' => $params['student_id']);
                $studentContentCondition = array('id' => $params['student_content_id']);
                $deleteAnswerCondition = array('student_content_id' => $params['student_content_id']);
                $update = $this->common_model->update('student_content',$resetData, $studentContentCondition);
                $deleteAnswers = $this->common_model->delete('student_answers', $deleteAnswerCondition);
                $deleteFeedback = $this->common_model->delete('student_suggestions',$resetCondition);
                $resetStudentWork = array('student_content_status' => 1,
                                          'score_released' => 0,
                                          'obtained_score' => 0,
                                          'modified_by' => $params['user_id'],
                                          'modified_date' => date('Y-m-d H:i:s'));
                $this->common_model->update('student_work',$resetStudentWork, $deleteAnswerCondition);
            } else {
                $studentContentcondition = array('id' => $params['student_content_id']);
                $studentWorkcondition = array('student_content_id' => $params['student_content_id']);
                $data = array('status' => 2, 'release_score' => 0, 'feedback' => $params['teacher_feedback'], 'redo_test' => 1);
                $update = $this->common_model->update('student_content', $data, $studentContentcondition);
                $work = array(
                    'student_content_status' => 2,
                    'score_released' => 0
                );
                $studentworkupdated = $this->common_model->update('student_work', $work, $studentWorkcondition);
            }
            //inactive student essay feedback
            $condition = "WHERE student_content_id = {$params['student_content_id']}";
            $getStudentEssay = $this->student_model->getStudentEssay($condition);
            if(count($getStudentEssay) > 0){
                $updateStudentEssay = array('status' => 0);
                $condition = array('student_content_id' => $params['student_content_id']);
                $this->common_model->update('student_essays', $updateStudentEssay, $condition);
            }
            
            if ($update) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Status changed to Inprogress";
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ResponseObject'] = "Can't change the status";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/studentContentStatusChange',$this->jsonarr,'studentContentStatusChange');
        return $this->printjson($this->jsonarr);
    }

    public function saveAnnotation_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Class Id should not be empty";
        } elseif ($params['teacher_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Student Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Content Id should not be empty";
        } elseif(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/saveAnnotation','only request','saveAnnotation');
            $folder = "../uploads/teacherAnnotation/";
            if (isset($params['type']) && $params['type'] == 1) {
                $checkAnnotateExists = $this->teacher_model->checkAnnotateExists($params);
                if (count($checkAnnotateExists) == 0) {
                    $data = [];
                    $data['teacher_id'] = $params['teacher_id'];
                    $data['class_id'] = $params['class_id'];
                    $data['content_id'] = $params['content_id'];
                    $data['school_id'] = $params['school_id'];
                    $data['created_by'] = $params['user_id'];
                    $data['created_date'] = date('Y-m-d H:i:s');
                    $id = $this->common_model->insert('teacher_class_annotation', $data);
                    $fileName = "teacher-classAnnotation-".$id.$params['teacher_id'].$params['class_id'].$params['content_id'].'.json';
                    $createAnnotationFile = $this->common_model->createFlatFile($folder,$fileName,$params['annotation']);
                    $path = "uploads/teacherClassAnnotation/".$fileName;
                    $data = array('annotation' => $path);
                    $condition = array('id' => $id);
                    $this->common_model->update('teacher_class_annotation', $data, $condition);
                } else {
                    $fileName = "teacher-classAnnotation-".$checkAnnotateExists[0]['id'].$params['teacher_id'].$params['class_id'].$params['content_id'].'.json';
                    $createAnnotationFile = $this->common_model->createFlatFile($folder,$fileName,$params['annotation']);
                    $path = "uploads/teacherClassAnnotation/".$fileName;
                    $data = array('annotation' => $path,
                        'modified_by' => $params['user_id'],
                        'modified_date' => date('Y-m-d H:i:s'));
                    $condition = array('id' => $checkAnnotateExists[0]['id']);
                    $this->common_model->update('teacher_class_annotation', $data, $condition);
                }
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Annotation Saved";
            } else {
                $getTeacherAnnotation = $this->teacher_model->getTeacherAnnotation($params);
                $this->jsonarr['IsSuccess'] = true;
                if (count($getTeacherAnnotation) > 0) {
                    if($getTeacherAnnotation[0]['teacher_preview_annotation'] != '' && $getTeacherAnnotation[0]['teacher_preview_annotation'] != ''){
                        $teacherClassAnnotation = $this->common_model->annotation($getTeacherAnnotation[0]['teacher_preview_annotation']);
                        $this->jsonarr['ResponseObject'] = json_decode($teacherClassAnnotation);
                    } else {
                        $this->jsonarr['ResponseObject'] = [];
                    }
                }
            }
        }
        $this->common_model->createLog($params,'v1/teacher/saveAnnotation',$this->jsonarr,'saveAnnotation');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function teacherCorrectionAnnotation_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'),true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if($params['platform'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Platform Should not be Empty";
        } elseif($params['user_id'] == " ") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif($params['class_id'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Class Id Should not be Empty";
        } elseif ($params['student_id'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Student Id Should not be Empty";
        } elseif($params['content_id'] == " ") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Content Id Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/teacher/teacherCorrectionAnnotation','only request','teacherCorrectionAnnotation');
            if ($params['type'] == 1) {
                $folder = "../uploads/studentTeacherAnnotation/";
              //  $getStudentContentId = $this->student_model->getStudentContent($params);
                $fileName = "teacher-annotation".$params['student_content_id'].$params['class_id'].$params['content_id'].'.json';
                $createAnnotationFile = $this->common_model->createFlatFile($folder,$fileName,$params['annotation']);
                $path = "uploads/studentTeacherAnnotation/".$fileName;
                $updateData = array('teacher_annotation' => $path);
                $condition = array('id' => $params['student_content_id']);
                $update = $this->common_model->update('student_content', $updateData, $condition);
                if ($update) {
                    $this->jsonarr["IsSuccess"] = true;
                    $this->jsonarr["ResponseObject"] = "Annotation Saved";
                }
            } elseif ($params['type'] == 2) {
                $annotationList = $this->teacher_model->getAnnotationList($params);
                $this->jsonarr['IsSuccess'] = true;
                if (count($annotationList) > 0) {
                    foreach($annotationList as $key => $value) {
                        $teacherAnnotation = $this->common_model->annotation($value['annotation']);
                        $annotationList[$key]["annotation"] =  json_decode($teacherAnnotation);
                    }
                    $this->jsonarr["ResponseObject"]["Annotation"] = $annotationList;

                } else {
                    $this->jsonarr["ResponseObject"] = [];
                }
            }
        }
        $this->common_model->createLog($params,'v1/teacher/teacherCorrectionAnnotation',$this->jsonarr,'teacherCorrectionAnnotation');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function saveAnswerSheetAnnotation_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'),true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if($params['platform'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Platform Should not be Empty";
        } elseif($params['user_id'] == " ") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif($params['class_id'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Class Id Should not be Empty";
        } elseif ($params['student_id'] == " "){
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Student Id Should not be Empty";
        } elseif($params['content_id'] == " ") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Content Id Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/teacher/saveAnswerSheetAnnotation','only request','saveAnswerSheetAnnotation');
            $folder = "../uploads/answerAnnotation/";
            //$getStudentContentId = $this->student_model->getStudentContent($params);
            $fileName = "answer-annotation".$params['student_content_id'].$params['class_id'].$params['content_id'].'.json';
            $createAnnotationFile = $this->common_model->createFlatFile($folder,$fileName,$params['answer_sheet_annotation']);
            $path = "uploads/answerAnnotation/".$fileName;
            $updateData = array('answer_sheet_annotation' => $path);
            $condition = array('id' => $params['student_content_id']);
            $update = $this->common_model->update('student_content', $updateData, $condition);
            if ($update) {
                $this->jsonarr["IsSuccess"] = true;
                $this->jsonarr["ResponseObject"] = "Annotation Saved";
            }
        }
        $this->common_model->createLog($params,'v1/teacher/teacherCorrectionAnnotation',$this->jsonarr,'teacherCorrectionAnnotation');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function studentAssessment_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id should not be empty";
        } elseif ($params['content_type'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Type should not be Empty";
        } elseif ($params['type'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Type should not be Empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Status should not be Empty";
        } elseif(count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/studentAssessment','only request','studentAssessment');
            if ($this->config->item('student_work') == true) {
                $studentAssesmentList = $this->teacher_model->studentAssessment($params,$params['content_type'],1);
            } else {
                $studentAssesmentList = $this->teacher_model->studentAssessmentList($params, $params['content_type'], 1);
            }
            $data = array();
            $i = 0;
            foreach ($studentAssesmentList as $key => $value) {
                if ($value['status'] == 2) {
                    unset($studentAssesmentList[$key]['answer_completed_date']);
                }
            }
            if($params['status'] == 4) {
                foreach($studentAssesmentList as $key => $value){
                    if($value['overDue'] != 0 || $value['overDue'] != '0'){
                        $data[$i] = $value;
                        $i++;
                    }
                }
            }
            $studentAssesmentList = array_values(array_map("unserialize", array_unique(array_map("serialize", $studentAssesmentList))));

            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $params['status'] != 4 ? $studentAssesmentList : $data;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/studentAssessment',$this->jsonarr,'studentAssessment');
        return $this->printjson($this->jsonarr);
    }

    public function individualTeacherAdd_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Email should not be empty";
        } elseif ($params['mobile'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "mobile should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Status should not be empty";
        } elseif ($params['permission'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Permission should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/teacher/individualTeacherAdd','only request','individualTeacherAdd');
            if(isset($params['institution'])) {
                $userExists = $this->teacher_model->checkIndividualTeacher($params,'add','');
            } else {
                $userExists = $this->teacher_model->user($params, 'add', '');
            }
            if (count($userExists) == 0) {
                $checkSchool = $this->teacher_model->checkSchool($params);
                if (count($checkSchool) == 0) {
                    if(isset($params['institution'])){
                        $schoolAdd = array(
                            'name' => $params['institution'] != '' ? $params['institution'] : $params['first_name'],
                            'address1' => $params['address1'],
                            'address2' => $params['address2'],
                            'city' => $params['city'],
                            'state' => $params['state'],
                            'country' => $params['country'],
                            'postal_code' => $params['postal_code'],
                            'status' => $params['status'],
                            'institution_type' => 2,
                            'has_branch' => 0,
                            'branch_name' => '',
                            'profile_url' => $params['profile_url'],
                            'profile_thumb_url' => $params['profile_thumb_url'],
                            'trial' => isset($params['trial']) ? $params['trial'] : 0,
                            'validity' => isset($params['validity']) ? $params['validity'] : '',
                            'created_by' => isset($params['user_id']) ? $params['user_id'] : 0,
                            'created_date' => date('Y-m-d H:i:s')
                        );
                        $params['school_id'] = $this->common_model->insert('school', $schoolAdd);
                        $schoolId = $params['school_id'];
                        $setting[0] = array(
                            'name' => 'teacher_activity_email',
                            'description' => 'Activity Notification "To" Email ID',
                            'value' => $params['email_id'],
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[1] = array(
                            'name' => 'teacher_notify_email_admin',
                            'description' => 'Activity Notification "CC" Email ID',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[2] = array(
                            'name' => 'allow_autograde_settings',
                            'description' => '',
                            'value' => '0',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[3] = array(
                           'name' => 'allow_autoassign_student_for_class',
                           'description' => '',
                           'value' => '1',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[4] = array(
                            'name' => 'answer_key_upload',
                            'description' => '',
                            'value' => '1',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[5] = array(
                            'name' => 'file_size_restriction',
                            'description' => '',
                            'value' => '5',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[6] = array(
                            'name' => 'support_email',
                            'description' => '',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[7] = array(
                            'name' => 'support_email_password',
                            'description' => '',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[8] = array(
                            'name' => 'below_score_cutoff_email',
                            'description' => '',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[9] = array(
                            'name' => 'zoom_apikey',
                            'description' => '',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[10] = array(
                            'name' => 'zoom_secretkey',
                            'description' => '',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[11] = array(
                            'name' => 'zoom_user_email',
                            'description' => '',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[12] = array(
                            'name' => 'allow_zoom_api',
                            'description' => '',
                            'value' => '',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[13] = array(
                            'name' => 'timezone',
                            'description' => '',
                            'value' => '251',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[14] = array(
                            'name' => 'date_format',
                            'description' => '',
                            'value' => '7',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[15] = array(
                            'name' => 'teacher_zoom_view',
                            'description' => '0 -> In App, 1 -> External Tab, 2 -> Both',
                            'value' => '1',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $setting[16] = array(
                            'name' => 'student_zoom_view',
                            'description' => '0 -> In App, 1 -> External Tab, 2 -> Both',
                            'value' => '1',
                            'school_id' => $schoolId,
                            'settings' => '2',
                            'status' => '1'
                        );
                        $this->common_model->bulkInsert('admin_settings_school', $setting);
                    }
                    $user = [];
                    $user['role_id'] = 4;
                    if(isset($params['institution'])) {
                        $user['individual_teacher'] = 1;
                    }
                    $user['school_id'] = $params['school_id'];
                    $user['status'] = $params['status'];
                    $user['login_type'] = 'WEB';
                    $user['created_by'] = isset($params['user_id']) ? $params['user_id'] : 0;
                    $user['created_date'] = date('Y-m-d H:i:s');
                    $user['email_id'] = $params['email_id'];
                    $user['mobile'] = $params['mobile'];
                    $id = $this->common_model->insert('user', $user);
                    if($id > 0) {
                        $userPermission = [];
                        $c = 0;
                        for ($i = 0; $i < count($params['permission']); $i++) {
                            for ($j = 0; $j < count($params['permission'][$i]['permission']); $j++) {
                                if ($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                    $userPermission[$c]['user_id'] = $id;
                                    $userPermission[$c]['role_id'] = 4;
                                    $userPermission[$c]['school_id'] = $params['school_id'];
                                    $userPermission[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                    $c++;
                                }
                            }
                        }
                        if (count($userPermission) > 0) {
                            $this->common_model->bulkInsert('user_role_permission', $userPermission);
                        }
                        $userProfile = [];
                        $userProfile['user_id'] = $id;
                        $userProfile['first_name'] = $params['first_name'];
                        $userProfile['last_name'] = $params['last_name'];
                        $userProfile['profile_url'] = $params['profile_url'];
                        $userProfile['gender'] = $params['gender'];
                        $userProfile['birthday'] = $params['birthday'];
                        $userProfile['created_by'] = isset($params['user_id']) ? $params['user_id'] : 0;
                        $userProfile['created_date'] = date('Y-m-d H:i:s');
                        if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                            $userProfile['profile_url'] = $params['profile_url'];
                            $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                        }
                        $profileId = $this->common_model->insert('user_profile', $userProfile);
                        if($profileId > 0) {
                            $userProfileDetails = [];
                            $userProfileDetails['user_id'] = $id;
                            $userProfileDetails['doj'] = $params['doj'];
                            if(isset($params['institution'])) {
                                $userProfileDetails['individual_teacher'] = 1;
                            }
                            $userProfileDetails['school_id'] = $params['school_id'];
                            if(isset($params['designation'])){
                                $userProfileDetails['designation'] = $params['designation'];
                            }
                            if(isset($params['institution'])) {
                                $userProfileDetails['school_idno'] = 0;
                                $userProfileDetails['individual_role'] = $params['individual_role'];
                            } else {
                                $userProfileDetails['grade_id'] = is_array($params['grade']) ? implode(',', $params['grade']) : '';
                                $userProfileDetails['subject'] = is_array($params['subject']) ? implode(',',$params['subject']) : '';
                                $userProfileDetails['school_idno'] = $params['school_idno'];
                            }
                            $userProfileDetails['created_by'] = isset($params['user_id']) ? $params['user_id'] : 0;
                            $userProfileDetails['created_date'] = date('Y-m-d H:i:s');
                            $profileDetailId = $this->common_model->insert('user_profile_details', $userProfileDetails);
                            if($profileDetailId > 0) {
                                $userAddress = [];
                                $userAddress['address_type'] = 1;
                                $userAddress['user_id'] = $id;
                                $userAddress['name'] = $params['last_name'];
                                $userAddress['address1'] = $params['address1'];
                                $userAddress['address2'] = $params['address2'];
                                $userAddress['city'] = $params['city'];
                                $userAddress['state'] = $params['state'];
                                $userAddress['country'] = $params['country'];
                                $userAddress['postal_code'] = $params['postal_code'];
                                $userAddress['created_date'] = date('Y-m-d H:i:s');
                                $address_id = $this->common_model->insert('user_address', $userAddress);
                                if($address_id > 0) {
                                    $messageTemplates = $this->common_model->smsEmailTemplate('password_generate_link', 'email');
                                    $emailMsg = $messageTemplates['template'];
                                    $userLink = base64_encode($id);
                                    $userLink = base64_encode($userLink);
                                    $this->load->library('bitly');
                                    $url = $this->config->item('user_password_url') . '/' . $userLink;
                                  //  $urlLink = $this->bitly->shorten($url);
                                    //$emailMsg = str_replace('%PASSWORD%', $this->config->item('password'), $message);
                                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                                    if ($this->config->item('user_send_email') == true) {
                                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '', '');
                                    }
//                                    else {
//                                        $mailSent = true;
//                                    }
//                                    if ($mailSent == true) {
                                    $this->jsonarr["IsSuccess"] = true;
                                    if ($params['individual_role'] == 0) {
                                        $this->jsonarr["ResponseObject"] = "Teacher Registered successfully";
                                    } else {
                                        $this->jsonarr["ResponseObject"] = "Parent Registered successfully";
                                    }
//                                    } else {
//                                            $this->jsonarr['IsSuccess'] = false;
//                                            $this->jsonarr['ErrorObject'] = "Failed to send mail";
//                                    }
                                } else {
                                    $this->jsonarr['IsSuccess'] = false;
                                    $this->jsonarr['ErrorObject'] = "Teacher Address not added";
                                }
                            } else {
                                $this->jsonarr['IsSuccess'] = false;
                                $this->jsonarr['ErrorObject'] = "Teacher Profile Details not added";
                            }
                        } else {
                            $this->jsonarr['IsSuccess'] = false;
                            $this->jsonarr['ErrorObject'] = "Teacher Profile not added";
                        }
                    } else {
                        $this->jsonarr['IsSuccess'] = false;
                        $this->jsonarr['ErrorObject'] = "Teacher not added";
                    }
                } elseif (count($checkSchool) > 0) {
                    if(isset($params['institution'])) {
                        $schoolAdd = array(
                            'name' => $params['institution'] != '' ? $params['institution'] : $params['first_name'],
                            'address1' => $params['address1'],
                            'address2' => $params['address2'],
                            'city' => $params['city'],
                            'state' => $params['state'],
                            'country' => $params['country'],
                            'postal_code' => $params['postal_code'],
                            'status' => $params['status'],
                            'institution_type' => 2,
                            'has_branch' => 0,
                            'branch_name' => '',
                            'profile_url' => $params['profile_url'],
                            'profile_thumb_url' => $params['profile_thumb_url'],
                            'created_by' => isset($params['user_id']) ? $params['user_id'] : 0,
                            'created_date' => date('Y-m-d H:i:s')
                        );
                        $params['school_id'] = $this->common_model->insert('school', $schoolAdd);
                    }
                    $condition = array('user_id' => $checkSchool[0]['user_id']);
                    $school = array();
                    if(isset($params['institution'])) {
                        $data = array('individual_teacher' => 1);
                        $this->common_model->update('user',$data, $condition);
                    }
                    $schoolIds = explode(",", $checkSchool[0]['school_id']);
                    array_push($schoolIds, $params['school_id']);
                    $school['school_id'] = implode(",", $schoolIds);
                    $this->common_model->update('user', $school, $condition);
                    $userProfileDetail = [];
                    $userProfileDetail['user_id'] = $checkSchool[0]['user_id'];
                    $userProfileDetail['doj'] = $params['doj'];
                    if(isset($params['institution'])) {
                        $userProfileDetail['individual_teacher'] = 1;
                    }
                    $userProfileDetail['school_id'] = $params['school_id'];
                    if(isset($params['designation'])) {
                        $userProfileDetail['designation'] = $params['designation'];
                    }
                    if(isset($params['institution'])) {
                        $userProfileDetail['school_idno'] = 0;
                        $userProfileDetails['individual_role'] = $params['individual_role'];
                    } else {
                        $userProfileDetails['grade_id'] = is_array($params['grade']) ? implode(',', $params['grade']) : '';
                        $userProfileDetails['subject'] = is_array($params['subject']) ? implode(',', $params['subject']) : '';
                        $userProfileDetails['school_idno'] = $params['school_idno'];
                    }
                    $userProfileDetail['created_by'] = isset($params['user_id']) ? $params['user_id'] : 0;
                    $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                    $update2 = $this->common_model->insert('user_profile_details', $userProfileDetail);
                    $userPermission1 = [];
                    $c = 0;
                    for ($i = 0; $i < count($params['permission']); $i++) {
                        for ($j = 0; $j < count($params['permission'][$i]['permission']); $j++) {
                            if ($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                $userPermission1[$c]['user_id'] = $checkSchool[0]['user_id'];
                                $userPermission1[$c]['role_id'] = 4;
                                $userPermission1[$c]['school_id'] = $params['school_id'];
                                $userPermission1[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                $c++;
                            }
                        }
                    }
                    if (count($userPermission1) > 0) {
                        $this->common_model->bulkInsert('user_role_permission', $userPermission1);
                    }
                    $messageTemplates = $this->common_model->smsEmailTemplate('existing_user', 'email');
                    $schoolName = $this->common_model->schoolName($params['school_id']);
                    $emailMsg = $messageTemplates['template'];
                    $this->load->library('bitly');
                    $url = $this->config->item('teacher_login_url');
                   // $urlLink = $this->bitly->shorten($url);
                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                    $emailMsg = str_replace('%SCHOOL%', $schoolName['name'], $emailMsg);
                    if ($this->config->item('user_send_email') == true) {
                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '', '');
                    }
                    if ($update2) {
                        $this->jsonarr["IsSuccess"] = True;
                        if ($params['individual_role'] == 0) {
                            $this->jsonarr["ResponseObject"] = "Teacher Registered successfully";
                        } else {
                            $this->jsonarr["ResponseObject"] = "Parent Registered successfully";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        if ($params['individual_role'] == 0) {
                            $this->jsonarr["ErrorObject"] = "Failed to Register Teacher";
                        } else {
                            $this->jsonarr["ErrorObject"] = "Failed to Register Parent";
                        }
                    }
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Email-Id already exists";
            }
        }
        $this->common_model->createLog($params,'v1/teacher/individualTeacherAdd',$this->jsonarr,'individualTeacherAdd');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function studentCorrectionList_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'),true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Status Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/teacher/studentCorrectionList','only request','studentCorrectionList');
            $classList = $this->teacher_model->correctionClass($params,$params['content_type']);
            $input = array_map("unserialize", array_unique(array_map("serialize", $classList)));
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $input;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/teacher/studentCorrectionList',$this->jsonarr,'studentCorrectionList');
        return $this->printjson($this->jsonarr);
    }

    public function notifyParents_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should Not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should Not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should Not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should Not be Empty";
        } elseif ($params['notify'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Notify Should Not be Empty";
        } else {
            $this->common_model->createLog($params, 'v1/teacher/notifyParents', 'only request', 'notifyParents');
            $schoolId = $params['school_id'];
            foreach ($params['notify'] as $key => $value) {
                $studentIds = $value['student_id'];
                $contentIds = $value['content_id'];
                $classIds = $value['class_id'];
                $studentDetail = array(
                    'school_id' => $schoolId,
                    'student_content_id' => $value['student_content_id'],
                    'student_id' => $value['student_id'],
                    'class_id' => $value['class_id'],
                    'content_id' => $value['content_id'],
                    'status' => 0,
                    'created_by' => $params['user_id'],
                    'created_date' => date('Y-m-d H:i:s')
                );
                $insert = $this->common_model->insert('notify_parents_requests', $studentDetail);
                $studentDetails = $this->teacher_model->studentName($value['student_content_id']);
                $toMail = $this->teacher_model->emailIds($studentIds);
                $toMailArray = array();
                foreach ($toMail as $key1 => $value1) {
                    if (($value1['email_ids'] != '' && $value1['email_ids'] != ',') || ($value1['email_id'] != '')) {
                        $data = explode(',', $value1['email_ids']);
                        $data1 = array($value1['email_id']);
                        $toMailArray = array_merge($toMailArray, $data, $data1);
                    }
                }
                $toMailArray = array_values(array_filter(array_unique($toMailArray)));
                if (!empty($toMailArray)) {
                    $toMailArray = implode(',', $toMailArray);
                    $messageTemplates = $this->common_model->smsEmailTemplate('parent_notify', 'email');
                    $emailMsg = $messageTemplates['template'];
                    $subject = str_replace('%SCHOOL%', $studentDetails['school_name'], $messageTemplates['subject']);
                    $emailMsg = str_replace('%STUDENTNAME%', $studentDetails['student_name'], $emailMsg);
                    $emailMsg = str_replace('%TYPE%', $studentDetails['content_type'] == 2 ? "Assignments" : "Assessments", $emailMsg);
                    $emailMsg = str_replace('%CLASSNAME%', $studentDetails['class_name'], $emailMsg);
                    $emailMsg = str_replace('%RECORDS%', $studentDetails['content_name'], $emailMsg);
                    $emailMsg = str_replace('%DATE%', $studentDetails['start_date'] . ' to ' . $studentDetails['end_date'], $emailMsg);
                    $sendMail = $this->common_model->sendEmail($subject, $toMailArray, $emailMsg, '', '');
                    if ($sendMail) {
                        $data = array('parents_notify_count' => $studentDetails['parents_notify_count'] + 1);
                        $condition = array('id' => $value['student_content_id']);
                        $condition1 = array('student_content_id' => $value['student_content_id']);
                        $this->common_model->update('student_content', $data, $condition);
                        $update = array('status' => 1);
                        $this->common_model->update('notify_parents_requests',  $update, $condition1);
                    }
                    if ($sendMail) {
                        $this->jsonarr["IsSuccess"] = true;
                        $this->jsonarr["ResponseObject"] = "Mail Sent Successfully";
                    } else {
                        $this->jsonarr["IsSuccess"] = true;
                        $this->jsonarr["ResponseObject"] = "Unable to send Mail";
                    }
                } /*else {
               $this->jsonarr["IsSuccess"] = false;
               $this->jsonarr["ErrorObject"] = "There is no Parent Mail Id to Send Notification";
               }*/
            }
        }
        $this->common_model->createLog($params, 'v1/teacher/notifyParents', $this->jsonarr, 'notifyParents');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function notifyAllStudentParents_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should Not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should Not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should Not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should Not be Empty";
        } else {
            $this->common_model->createLog($params, 'v1/teacher/notifyAllStudentParents', 'only request', 'notifyAllStudentParents');
            $students = $this->getOverDueStudents($params, $params['content_type']);
            $data = array();
            foreach ($students as $key => $value) {
                $exists = $this->teacher_model->getAlreadyExists($value);
                if (!$exists) {
                    $data[] = array(
                        'school_id' => $params['school_id'],
                        'student_content_id' => $value['student_content_id'],
                        'student_id' => $value['student_id'],
                        'class_id' => $value['class_id'],
                        'content_id' => $value['content_id'],
                        'created_by' => $params['user_id'],
                        'created_date' => date('Y-m-d H:i:s')
                    );
                } else {
                    $updateData = array('status' => 0);
                    $condition = array('student_content_id' => $value['student_content_id']);
                    $this->common_model->update('notify_parents_requests', $updateData, $condition);
                }
            }
            if (count($data) > 0) {
                $this->common_model->bulkInsert('notify_parents_requests', $data);
            }
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = "Mail will be sent within 24 Hours";
        }
        $this->common_model->createLog($params, 'v1/teacher/notifyAllStudentParents', $this->jsonarr, 'notifyAllStudentParents');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function getOverDueStudents($params,$contentType) {
        if ($this->config->item('student_work') == true) {
            $studentAssesmentList = $this->teacher_model->studentAssessment($params,$params['content_type'],1);
        } else {
            $studentAssesmentList = $this->teacher_model->studentAssessmentList($params, $contentType, 2);
        }
        $data = array();
        $i = 0;
        foreach($studentAssesmentList as $key => $value){
            if($value['overDue'] != 0 || $value['overDue'] != '0'){
                $data[$i] = $value;
                $i++;
            }
        }
        return $data;
    }

    public function studentCorrectionInfo_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should Not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should Not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should Not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should Not be Empty";
        } else {
            $getStudentWorkInfo = $this->teacher_model->getStudentWorkInfo($params);
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $getStudentWorkInfo;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }
    public function addAcademyTeacher_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
       // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Email should not be empty";
        } elseif ($params['mobile'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "mobile should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "school id should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Status should not be empty";
        } elseif ($params['permission'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Permission should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params, 'v1/teacher/add', 'only request', 'add');
            $userExists = $this->teacher_model->user($params, 'add', '');
            if (count($userExists) == 0) {
                $checkSchool = $this->teacher_model->checkSchool($params);
                if (count($checkSchool) == 0) {
                    $user = [];
                    $user['role_id'] = 4;
                    $user['school_id'] = $params['school_id'];
                    $user['status'] = $params['status'];
                    $user['login_type'] = 'WEB';
                    $user['created_by'] = $params['user_id'];
                    $user['created_date'] = date('Y-m-d H:i:s');
                    $user['email_id'] = $params['email_id'];
                    $user['mobile'] = $params['mobile'];
                    $user['academy_user_id'] = isset($params['academy_teacher_id']) ? $params['academy_teacher_id'] : 0;
                    if (isset($params['password']) && $params['password'] != '') {
                        $salt = $this->config->item('salt');
                        $password = md5($salt . $params['password'] . $salt);
                        $user['password'] = $password;
                    }
                    $id = $this->common_model->insert('user', $user);
                    if ($id > 0) {
                        $userPermission = [];
                        $c = 0;
                        for ($i = 0; $i < count($params['permission']); $i++) {
                            for ($j = 0; $j < count($params['permission'][$i]['permission']); $j++) {
                                if ($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                    $userPermission[$c]['user_id'] = $id;
                                    $userPermission[$c]['role_id'] = 4;
                                    $userPermission[$c]['school_id'] = $params['school_id'];
                                    $userPermission[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                    $c++;
                                }
                            }
                        }
                        if (count($userPermission) > 0) {
                            $this->common_model->bulkInsert('user_role_permission', $userPermission);
                        }
                        $userProfile = [];
                        $userProfile['user_id'] = $id;
                        $userProfile['first_name'] = $params['first_name'];
                        $userProfile['last_name'] = $params['last_name'];
                        $userProfile['profile_url'] = $params['profile_url'];
                        $userProfile['gender'] = $params['gender'];
                        $userProfile['birthday'] = $params['birthday'];
                        $userProfile['created_by'] = $params['user_id'];
                        $userProfile['created_date'] = date('Y-m-d H:i:s');
                        if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                            $userProfile['profile_url'] = $params['profile_url'];
                            $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                        }
                        $profileId = $this->common_model->insert('user_profile', $userProfile);
                        if ($profileId > 0) {
                            $userProfileDetails = [];
                            $userProfileDetails['user_id'] = $id;
                            $userProfileDetails['school_id'] = $params['school_id'];
                            $userProfileDetails['doj'] = $params['doj'];
                            $userProfileDetails['grade_id'] = is_array($params['grade']) ? implode(',', $params['grade']) : '';
                            $userProfileDetails['subject'] = is_array($params['subject']) ? implode(',', $params['subject']) : '';
                            $userProfileDetails['designation'] = $params['designation'];
                            $userProfileDetails['school_idno'] = $params['school_idno'];
                            $userProfileDetails['created_by'] = $params['user_id'];
                            $userProfileDetails['created_date'] = date('Y-m-d H:i:s');
                            $profileDetailId = $this->common_model->insert('user_profile_details', $userProfileDetails);
                            if ($profileDetailId > 0) {
                                $userAddress = [];
                                $userAddress['address_type'] = 1;
                                $userAddress['user_id'] = $id;
                                $userAddress['name'] = $params['last_name'];
                                $userAddress['address1'] = $params['address1'];
                                $userAddress['address2'] = $params['address2'];
                                $userAddress['city'] = $params['city'];
                                $userAddress['state'] = $params['state'];
                                $userAddress['country'] = $params['country'];
                                $userAddress['postal_code'] = $params['postal_code'];
                                $userAddress['created_date'] = date('Y-m-d H:i:s');
                                $address_id = $this->common_model->insert('user_address', $userAddress);
                                if ($address_id > 0) {
                                    $messageTemplates = $this->common_model->smsEmailTemplate('password_generate_link', 'email');
                                    $emailMsg = $messageTemplates['template'];
                                    $userLink = base64_encode($id);
                                    $userLink = base64_encode($userLink);
                                    $this->load->library('bitly');
                                    $url = $this->config->item('user_password_url') . '/' . $userLink;
                                    // $urlLink = $this->bitly->shorten($url);
                                    //$emailMsg = str_replace('%PASSWORD%', $this->config->item('password'), $message);
                                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                                    if ($this->config->item('user_send_email') == true) {
                                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '', '');
                                    }
                                    //                                        else {
                                    //                                            $mailSent = true;
                                    //                                        }
                                    //                                        if ($mailSent == true) {
                                    $this->jsonarr["IsSuccess"] = true;
                                    $this->jsonarr["ResponseObject"] = "Teacher added successfully";
                                    $this->jsonarr["Link"] = $url;
                                    $this->jsonarr["teacher_id"] = $id;
                                    //                                        } else {
                                    //                                            $this->jsonarr['IsSuccess'] = false;
                                    //                                            $this->jsonarr['ErrorObject'] = "Failed to send mail";
                                    //                                        }
                                } else {
                                    $this->jsonarr["IsSuccess"] = false;
                                    $this->jsonarr["ErrorObject"] = "Failed to Add Teacher Address";
                                }
                            } else {
                                $this->jsonarr["IsSuccess"] = false;
                                $this->jsonarr["ErrorObject"] = "Failed to Add Teacher Profile details";
                            }
                        } else {
                            $this->jsonarr["IsSuccess"] = false;
                            $this->jsonarr["ErrorObject"] = "Failed to Add Teacher Profile";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Failed to Add Teacher";
                    }
                } elseif (count($checkSchool) > 0) {
                    $condition = array('user_id' => $checkSchool[0]['user_id']);
                    $school = array();
                    $schoolIds = explode(",", $checkSchool[0]['school_id']);
                    array_push($schoolIds, $params['school_id']);
                    $school['school_id'] = implode(",", $schoolIds);
                    $school['academy_user_id'] = isset($params['academy_teacher_id']) ? $params['academy_teacher_id'] : 0;
                    $userProfileDetail = [];
                    $userProfileDetail['user_id'] = $checkSchool[0]['user_id'];
                    $userProfileDetail['school_id'] = $params['school_id'];
                    $userProfileDetail['grade_id'] = is_array($params['grade']) ? implode(',', $params['grade']) : '';
                    $userProfileDetail['subject'] = is_array($params['subject']) ? implode(',', $params['subject']) : '';
                    $userProfileDetail['doj'] = $params['doj'];
                    $userProfileDetail['designation'] = $params['designation'];
                    $userProfileDetail['school_idno'] = $params['school_idno'];
                    $userProfileDetail['created_by'] = $params['user_id'];
                    $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                    $userPermission = [];
                    $c = 0;
                    for ($i = 0; $i < count($params['permission']); $i++) {
                        for ($j = 0; $j < count($params['permission'][$i]['permission']); $j++) {
                            if ($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                $userPermission[$c]['user_id'] = $checkSchool[0]['user_id'];
                                $userPermission[$c]['role_id'] = 4;
                                $userPermission[$c]['school_id'] = $params['school_id'];
                                $userPermission[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                $c++;
                            }
                        }
                    }
                    if (count($userPermission) > 0) {
                        $this->common_model->bulkInsert('user_role_permission', $userPermission);
                    }
                    $update1 = $this->common_model->update('user', $school, $condition);
                    $update2 = $this->common_model->insert('user_profile_details', $userProfileDetail);
                    $messageTemplates = $this->common_model->smsEmailTemplate('existing_user', 'email');
                    $schoolName = $this->common_model->schoolName($params['school_id']);
                    $emailMsg = $messageTemplates['template'];
                    $this->load->library('bitly');
                    $url = $this->config->item('teacher_login_url');
                    // $urlLink = $this->bitly->shorten($url);
                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                    $emailMsg = str_replace('%SCHOOL%', $schoolName['name'], $emailMsg);
                    if ($this->config->item('user_send_email') == true) {
                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '', '');
                    }
                    if ($update1 && $update2) {
                        $this->jsonarr["IsSuccess"] = True;
                        $this->jsonarr["ErrorObject"] = "Teacher Added Successfully";
                        $this->jsonarr["teacher_id"] = $checkSchool[0]['user_id'];
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Failed to add Teacher";
                    }
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Email-Id already exists";
            }
        }
        $this->common_model->createLog($params, 'v1/teacher/add', $this->jsonarr, 'add');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function editAcademyTeacher_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
      //  $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Email should not be empty";
        } elseif ($params['mobile'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "mobile should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "status should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "school_idno should not be empty";
        } else if ($params['permission'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Permission should not be empty";
        } else {
            $this->common_model->createLog($params, 'v1/teacher/edit', 'only request', 'edit');
            if (count($this->jsonarr) == 0) {
                $userExists = $this->teacher_model->checkemail($params, $params['selected_user_id']);
                if (count($userExists) == 0) {
                    $checkPermission = $this->teacher_model->checkPermission($params['selected_user_id']);
                    if (count($checkPermission) > 0) {
                        $this->teacher_model->deletePermission($params['selected_user_id'], $params['school_id']);
                    }
                    $userPermission = [];
                    $c = 0;
                    for ($i = 0; $i < count($params['permission']); $i++) {
                        for ($j = 0; $j < count($params['permission'][$i]['permission']); $j++) {
                            if ($params['permission'][$i]['permission'][$j]['status'] == 1) {
                                $userPermission[$c]['user_id'] = $params['selected_user_id'];
                                $userPermission[$c]['role_id'] = 4;
                                $userPermission[$c]['school_id'] = $params['school_id'];
                                $userPermission[$c]['user_permission_id'] = $params['permission'][$i]['permission'][$j]['id'];
                                $c++;
                            }
                        }
                    }
                    if (count($userPermission) > 0) {
                        $this->common_model->bulkInsert('user_role_permission', $userPermission);
                    }
                    $condition = array("user_id" => $params['selected_user_id']);
                    $user = [];
                    $user['mobile'] = $params['mobile'];
                    $user['modified_by'] = $params['user_id'];
                    $user['status'] = $params['status'];
                    $user['email_id'] = $params['email_id'];
                    $userUpdate = $this->common_model->update('user', $user, $condition);
                    if ($userUpdate) {
                        $this->jsonarr['IsSuccess'] = true;
                        $this->jsonarr['ResponseObject'] = "User updated successfully";
                        $userProfile = [];
                        $userProfile['first_name'] = $params['first_name'];
                        $userProfile['last_name'] = $params['last_name'];
                        $userProfile['profile_url'] = $params['profile_url'];
                        $userProfile['gender'] = $params['gender'];
                        $userProfile['birthday'] = $params['birthday'];
                        $userProfile['modified_by'] = $params['role_id'];
                        $userProfile['modified_date'] = date('Y-m-d H:i:s');
                        if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                            $userProfile['profile_url'] = $params['profile_url'];
                            $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                        }
                        $userProfileUpdate = $this->common_model->update('user_profile', $userProfile, $condition);
                        if ($userProfileUpdate) {
                            $getUserId = $this->common_model->getUserId($params['selected_user_id'], $params['school_id']);
                            $userCondition = "user_details_id = {$getUserId['user_details_id']} AND school_id = {$params['school_id']}";
                            $userProfileDetails = [];
                            $userProfileDetails['doj'] = $params['doj'];
                            $userProfileDetails['status'] = $params['status'];
                            $userProfileDetails['designation'] = $params['designation'];
                            $userProfileDetails['school_idno'] = $params['school_idno'];
                            $userProfileDetails['grade_id'] = is_array($params['grade']) ? implode(',', $params['grade']) : '';
                            $userProfileDetails['subject'] = is_array($params['subject']) ? implode(',', $params['subject']) : '';
                            $userProfileDetailUpdate = $this->common_model->update('user_profile_details', $userProfileDetails, $userCondition);
                            if ($userProfileDetailUpdate) {
                                $userAddress = [];
                                $userAddress['name'] = $params['last_name'];
                                $userAddress['address1'] = $params['address1'];
                                $userAddress['address2'] = $params['address2'];
                                $userAddress['city'] = $params['city'];
                                $userAddress['state'] = $params['state'];
                                $userAddress['country'] = $params['country'];
                                $userAddress['postal_code'] = $params['postal_code'];
                                $userAddress['modified_date'] = date('Y-m-d H:i:s');
                                $userAddressUpdate = $this->common_model->update('user_address', $userAddress, $condition);
                                if ($userAddressUpdate) {
                                    $this->jsonarr['IsSuccess'] = true;
                                    $this->jsonarr['ResponseObject'] = "Teacher updated successfully";
                                } else {
                                    $this->jsonarr['IsSuccess'] = false;
                                    $this->jsonarr['ErrorObject'] = "Failed to update address";
                                }
                            } else {
                                $this->jsonarr['IsSuccess'] = false;
                                $this->jsonarr['ErrorObject'] = "Failed to update user profile detail";
                            }
                        } else {
                            $this->jsonarr['IsSuccess'] = false;
                            $this->jsonarr['ErrorObject'] = "Failed to update user profile";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Failed to update User";
                    }
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "EmailId already exists";
                }
            }
        }
        $this->common_model->createLog($params, 'v1/teacher/edit', $this->jsonarr, 'edit');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

}



