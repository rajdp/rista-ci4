<?php
defined('BASEPATH') OR exit('No direct script access allowed');
header('Access-Control-Allow-Origin: *');
header("Access-Control-Allow-Headers: AccessToken");
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');

require APPPATH . '/libraries/REST_Controller.php';
require 'vendor/autoload.php';
class Student extends REST_Controller
{
    protected $jsonarr = array();
    protected $headers;
    protected $urlAuth;
    protected $controller;

    function __construct()
    {
        parent::__construct();
        $this->load->model("student_model");
        $this->load->model("classes_model");
        $this->load->model("common_model");
        $this->load->model("user_model");
        $this->load->model("zoom_model");
        $this->load->model("mailbox_model");

        header("Access-Control-Allow-Origin: *");
        $this->controller = uri_string();
        $urlAuth = $this->verifyAuthUrl();
        $headers = $this->input->request_headers();
        if ($urlAuth) {
            $excludeurl = $this->excludefunction();
            if ($excludeurl != 'true') {
                if (isset($headers['Accesstoken'])) {
                    $this->output->set_status_header(200);
                    $headers['Accesstoken'];
                } else {
                    $this->jsonarr['ErrorObject'] = "Unauthorized User";
                    $this->jsonarr['IsSuccess'] = false;
                    $this->printjson($this->jsonarr);
                    $this->output->set_status_header(401);
                    exit();
                }

            } else {
                $this->output->set_status_header(200);
                return true;
            }
        } else {
            $this->output->set_status_header(200);
            $this->jsonarr['ErrorObject'] = "The requested url is not found.";
            $this->jsonarr['IsSuccess'] = false;
            $this->printjson($this->jsonarr);
            exit();
        }
    }

    public function verifyAuthUrl()
    {
        $this->allowedRoutes = array(
            'v1/student/add',
            'v1/student/edit',
            'v1/student/list',
            'v1/student/detail',
            'v1/student/classList',
            'v1/student/assignmentList',
            'v1/student/assessmentList',
            'v1/student/resourcesList',
            'v1/student/curriculumList',
            'v1/student/dashboard',
            'v1/student/classDetail',
            'v1/student/contentStudentList',
            'v1/student/saveAnnotation',
            'v1/student/studentPaperList',
            'v1/student/studentQuestionList',
            'v1/student/graphAnswer',
            'v1/student/addStudentQuery',
            'v1/student/studentClassList',
            'v1/student/studentAllClassList',
            'v1/student/viewScratchQuestions',
            'v1/student/checkContentTime',
            'v1/student/studentClassShift',
            'v1/student/studentClassShifts',
            'v1/student/StudentFromClassList',
            'v1/student/uploadAnswerList',
            'v1/student/studentClassShiftNew',
            'v1/student/answerKeyRequest',
            'v1/student/myProfile',
            'v1/student/futureClassShift',
            'v1/student/ClassRecording',
            'v1/student/deleteAnnotation',
            'v1/student/getZoomLink',
            'v1/student/addRepository',
            'v1/student/editRepository',
            'v1/student/repositoryList',
            'v1/student/addContentFolder',
            'v1/student/editContentFolder',
            'v1/student/contentFolderList',
            'v1/student/register',
            'v1/student/googleRegister',
            'v1/student/answerDetails',
            'v1/student/attendanceDetail',
            'v1/student/addAcademyStudent',
            'v1/student/addStudentClass',
            'v1/student/updateNotifyStatus',
            'v1/student/getOpenAiFeedback',
            'v1/student/getOpenAiFeedbackCount',
            'v1/student/makeUpClass'
        );
        foreach ($this->allowedRoutes as $routeString) {
            if ($this->controller == $routeString) {
                return true;
            }
        }
        return false;
    }

    public function excludefunction()
    {
        $this->excludeRoutes = array(
            'v1/student/graphAnswer',
            'v1/student/viewScratchQuestions',
            'v1/student/googleRegister',
        );
        foreach ($this->excludeRoutes as $routeString) {
            if ($this->controller == $routeString) {
                return true;
            }
        }
    }

    private function printjson($jsonarr)
    {
        echo json_encode($jsonarr);
    }

    public function add_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "First_name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Last_name should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "status should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School id should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/add','only request','add');
            $userExists = $this->student_model->user($params, 'add', '');
            if (count($userExists) == 0) {
                $checkSchool = $this->student_model->checkSchool($params);
                if (count($checkSchool) == 0) {
                    $user = [];
                    $user['role_id'] = 5;
                    $user['status'] = $params['status'];
                    $user['login_type'] = 'WEB';
                    $user['created_by'] = $params['user_id'];
                    $user['created_date'] = date('Y-m-d H:i:s');
                    $user['email_id'] = $params['email_id'];
                    if (count($params['mobile']) > 0) {
                        $user['mobile'] = implode(",", $params['mobile']);
                    }
                    $user['school_id'] = $params['school_id'];
                    $id = $this->common_model->insert('user', $user);
                    if ($id > 0) {
                        $upgradeDetails = [];
                        $upgradeDetails['school_id'] = $params['school_id'];
                        $upgradeDetails['student_id'] = $id;
                        $upgradeDetails['grade_id'] = $params['grade_id'];
                        $upgradeDetails['active_date'] = date('Y-m-d H:i:s');
                        $upgradeDetails['created_by'] = $params['user_id'];
                        $upgradeDetails['created_date'] = date('Y-m-d H:i:s');
                        $this->common_model->insert('upgrade', $upgradeDetails);
                        $userProfile = [];
                        $userProfile['user_id'] = $id;
                        $userProfile['first_name'] = $params['first_name'];
                        $userProfile['last_name'] = $params['last_name'];
                        $userProfile['gender'] = $params['gender'];
                        $userProfile['birthday'] = $params['birthday'];
                        $userProfile['created_by'] = $params['user_id'];
                        $userProfile['created_date'] = date('Y-m-d H:i:s');
                        if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                            $userProfile['profile_url'] = $params['profile_url'];
                            $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                        }
                        $profileId = $this->common_model->insert('user_profile', $userProfile);
                        if ($profileId > 0) {
                            $userProfileDetail = [];
                            $userProfileDetail['user_id'] = $id;
                            $userProfileDetail['doj'] = $params['registration_date'];
                            $userProfileDetail['dropped_date'] = $params['dropped_date'];
                            $userProfileDetail['school_idno'] = $params['school_idno'];
                            $userProfileDetail['school_id'] = $params['school_id'];
                            if ($params['grade_id'] != 0) {
                                $userProfileDetail['grade_id'] = $params['grade_id'];
                            } else {
                                $userProfileDetail['grade_id'] = 0;
                            }
                            $userProfileDetail['batch_id'] = $params['batch_id'];
                            $userProfileDetail['created_by'] = $params['user_id'];
                            $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                            $profileDetailId = $this->common_model->insert('user_profile_details', $userProfileDetail);
                            if ($profileDetailId > 0) {
                                $parent1Address = [];
                                $parent1Address['address_type'] = $params['address'][0]['address_type'];
                                $parent1Address['user_id'] = $id;
                                if ($params['parent1_firstname'] != "") {
                                    $firstName = trim($params['parent1_firstname']);
                                    $lastName = trim($params['parent1_lastname']);
                                    $parent1Address['name'] = $firstName . "," . $lastName;
                                }
                                $parent1Address['address1'] = $params['address'][0]['address1'];
                                $parent1Address['address2'] = $params['address'][0]['address2'];
                                if (count($params['parent1_email_ids']) > 0) {
                                    $parent1Address['email_ids'] = implode(",", $params['parent1_email_ids']);
                                }
                                $parent1Address['city'] = $params['address'][0]['city'];
                                $parent1Address['state'] = ($params['address'][0]['state'] == NULL) ? 0 : $params['address'][0]['state'];
                                $parent1Address['country'] = $params['address'][0]['country'];
                                $parent1Address['postal_code'] = $params['address'][0]['postal_code'];
                                $parent2Address = [];
                                $parent2Address['address_type'] = $params['address'][1]['address_type'];
                                $parent2Address['user_id'] = $id;
                                if ($params['parent2_firstname'] != "") {
                                    $firstName1 = trim($params['parent2_firstname']);
                                    $lastName1 = trim($params['parent2_lastname']);
                                    $parent2Address['name'] = $firstName1 . "," . $lastName1;
                                }
                                $parent2Address['address1'] = $params['address'][1]['address1'];
                                $parent2Address['address2'] = $params['address'][1]['address2'];
                                if (count($params['parent2_email_ids']) > 0) {
                                    $parent2Address['email_ids'] = implode(",", $params['parent2_email_ids']);
                                }
                                $parent2Address['city'] = $params['address'][1]['city'];
                                $parent2Address['state'] = ($params['address'][1]['state'] == NULL) ? 0 : $params['address'][1]['state'];
                                $parent2Address['country'] = $params['address'][1]['country'];
                                $parent2Address['postal_code'] = $params['address'][1]['postal_code'];
                                $parent1 = $this->common_model->insert('user_address', $parent1Address);
                                $parent2 = $this->common_model->insert('user_address', $parent2Address);
                                if ($parent1 > 0 && $parent2 > 0) {
                                    $messageTemplates = $this->common_model->smsEmailTemplate('password_generate_link', 'email');
                                    $emailMsg = $messageTemplates['template'];
                                    $userLink = base64_encode($id);
                                    $userLink = base64_encode($userLink);
                                    $this->load->library('bitly');
                                    $url = $this->config->item('user_password_url') . '/' . $userLink;
                                  //  $urlLink = $this->bitly->shorten($url);
                                    //$emailMsg = str_replace('%PASSWORD%', $this->config->item('password'), $message);
                                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                                    if ($this->config->item('user_send_email') == true) {
                                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '','');
                                    }
//                                    else {
//                                        $mailSent = true;
//                                    }
//                                    if ($mailSent == true) {
                                    $this->jsonarr["IsSuccess"] = true;
                                    $this->jsonarr["ResponseObject"] = "Student added successfully";
//                                    } else {
//                                        $this->jsonarr['IsSuccess'] = false;
//                                        $this->jsonarr['ErrorObject'] = "Failed to send mail";
//                                    }
                                } else {
                                    $this->jsonarr["IsSuccess"] = false;
                                    $this->jsonarr["ErrorObject"] = "Student address not added";
                                }
                            } else {
                                $this->jsonarr["IsSuccess"] = false;
                                $this->jsonarr["ErrorObject"] = "Student profile detail not added";
                            }
                        } else {
                            $this->jsonarr["IsSuccess"] = false;
                            $this->jsonarr["ErrorObject"] = "Student profile not added";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Student not added";
                    }
                } elseif (count($checkSchool) > 0) {
                    $condition = array('user_id' => $checkSchool[0]['user_id']);
                    $school = array();
                    $schoolIds = explode(",", $checkSchool[0]['school_id']);
                    array_push($schoolIds, $params['school_id']);
                    $school['school_id'] = implode(",", $schoolIds);
                    $userProfileDetail = [];
                    $userProfileDetail['user_id'] = $checkSchool[0]['user_id'];
                    $userProfileDetail['doj'] = $params['registration_date'];
                    $userProfileDetail['dropped_date'] = $params['dropped_date'];
                    $userProfileDetail['school_id'] = $params['school_id'];
                    if ($params['grade_id'] != 0) {
                        $userProfileDetail['grade_id'] = $params['grade_id'];
                    } else {
                        $userProfileDetail['grade_id'] = 0;
                    }
                    $userProfileDetail['batch_id'] = $params['batch_id'];
                    $userProfileDetail['school_idno'] = $params['school_idno'];
                    $userProfileDetail['created_by'] = $params['user_id'];
                    $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                    $update1 = $this->common_model->update('user', $school, $condition);
                    $update2 = $this->common_model->insert('user_profile_details', $userProfileDetail);
                    $upgradeDetails = [];
                    $upgradeDetails['school_id'] = $params['school_id'];
                    $upgradeDetails['student_id'] = $checkSchool[0]['user_id'];
                    $upgradeDetails['grade_id'] = $params['grade_id'];
                    $upgradeDetails['active_date'] = date('Y-m-d H:i:s');
                    $upgradeDetails['created_by'] = $params['user_id'];
                    $upgradeDetails['created_date'] = date('Y-m-d H:i:s');
                    $this->common_model->insert('upgrade', $upgradeDetails);
                    $messageTemplates = $this->common_model->smsEmailTemplate('existing_user', 'email');
                    $schoolName = $this->common_model->schoolName($params['school_id']);
                    $emailMsg = $messageTemplates['template'];
                    $this->load->library('bitly');
                    $url = $this->config->item('student_login_url');
                  //  $urlLink = $this->bitly->shorten($url);
                    $emailMsg = str_replace('%URL%', $url, $emailMsg);
                    $emailMsg = str_replace('%USER%', $params['first_name'] . ' ' . $params['last_name'], $emailMsg);
                    $emailMsg = str_replace('%SCHOOL%', $schoolName['name'], $emailMsg);
                    if ($this->config->item('user_send_email') == true) {
                        $mailSent = $this->common_model->sendEmail($messageTemplates['subject'], $params['email_id'], $emailMsg, '','');
                    }
                    if ($update1 && $update2) {
                        $this->jsonarr["IsSuccess"] = True;
                        $this->jsonarr["ResponseObject"] = "Students Added Successfully";
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Failed to add Students";
                    }
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Email-Id already exists";
            }
        }
        $this->common_model->createLog($params,'v1/student/add',$this->jsonarr,'add');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function list_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/student/list','only request','list');
            $studentList = [];
            $allStudentList = $this->student_model->studentList($params);
            for ($i = 0; $i < count($allStudentList); $i++) {
                $dataAvailable = false;
                for ($j = 0; $j < count($studentList); $j++) {
                    if ($studentList[$j]['user_id'] == $allStudentList[$i]['user_id']) {
                        $dataAvailable = true;
                    }
                }
                if (!$dataAvailable) {
                    $c = count($studentList);
                    $studentList[$c]['user_id'] = $allStudentList[$i]['user_id'];
                    $studentList[$c]['role_id'] = $allStudentList[$i]['role_id'];
                    $studentList[$c]['email_id'] = $allStudentList[$i]['email_id'];
                    if ($allStudentList[$i]['mobile'] != "") {
                        $studentList[$c]['mobile'] = explode(",", $allStudentList[$i]['mobile']);
                    } else {
                        $studentList[$c]['mobile'] = [];
                    }
                    $studentList[$c]['status'] = $allStudentList[$i]['status'];
                    $studentList[$c]['school_id'] = $allStudentList[$i]['school_id'];
                    $studentList[$c]['school_name'] = $allStudentList[$i]['school_name'];
                    $studentList[$c]['login_type'] = $allStudentList[$i]['login_type'];
                    $studentList[$c]['created_by'] = $allStudentList[$i]['created_by'];
                    $studentList[$c]['created_date'] = $allStudentList[$i]['created_date'];
                    $studentList[$c]['modified_by'] = $allStudentList[$i]['modified_by'];
                    $studentList[$c]['modified_date'] = $allStudentList[$i]['modified_date'];
                    $studentList[$c]['first_name'] = $allStudentList[$i]['first_name'];
                    $studentList[$c]['last_name'] = $allStudentList[$i]['last_name'];
                    $studentList[$c]['school_idno'] = $allStudentList[$i]['school_idno'];
                    $studentList[$c]['profile_url'] = $allStudentList[$i]['profile_url'];
                    $studentList[$c]['profile_thumb_url'] = $allStudentList[$i]['profile_thumb_url'];
                    $studentList[$c]['gender'] = $allStudentList[$i]['gender'];
                    $studentList[$c]['birthday'] = $allStudentList[$i]['birthday'];
                    $studentList[$c]['registration_date'] = $allStudentList[$i]['doj'];
                    $studentList[$c]['dropped_date'] = $allStudentList[$i]['dropped_date'];
                    $studentList[$c]['currency'] = $allStudentList[$i]['currency'];
                    $studentList[$c]['subject'] = $allStudentList[$i]['subject'];
                    $studentList[$c]['grade_id'] = $allStudentList[$i]['grade_id'];
                    $studentList[$c]['grade_name'] = $allStudentList[$i]['grade_name'];
                    $studentList[$c]['upgrade_date'] = ($allStudentList[$i]['upgrade_date'] == '00-00-0000') ? $allStudentList[$i]['graded_date'] : $allStudentList[$i]['upgrade_date'];
                    $studentList[$c]['batch_id'] = $allStudentList[$i]['batch_id'];
                    $studentList[$c]['batch_name'] = $allStudentList[$i]['batch_name'];
                    if ($allStudentList[$i]['name'] != "") {
                        $parentNames = explode(",", $allStudentList[$i]['name']);
                        if (count($parentNames) > 1) {
                            $studentList[$c]['parent1_firstname'] = $parentNames[0];
                            $studentList[$c]['parent1_lastname'] = $parentNames[1];
                        } else {
                            $studentList[$c]['parent1_firstname'] = $parentNames[0];
                            $studentList[$c]['parent1_lastname'] = '';
                        }
                    } else {
                        $studentList[$c]['parent1_firstname'] = '';
                        $studentList[$c]['parent1_lastname'] = '';
                    }
                    $studentList[$c]['parent2_firstname'] = '';
                    $studentList[$c]['parent2_lastname'] = '';
                    $studentList[$c]['address'][0]['address1'] = $allStudentList[$i]['address1'];
                    $studentList[$c]['address'][0]['address2'] = $allStudentList[$i]['address2'];
                    if ($allStudentList[$i]['email_ids'] != "") {
                        $emails = explode(",", $allStudentList[$i]['email_ids']);
                        $studentList[$c]['parent1_email_ids'] = $emails;
                    } else {
                        $studentList[$c]['parent1_email_ids'] = [];
                    }
                    $studentList[$c]['parent2_email_ids'] = [];
                    $studentList[$c]['address'][0]['city'] = $allStudentList[$i]['city'];
                    $studentList[$c]['address'][0]['state_id'] = $allStudentList[$i]['state'];
                    $studentList[$c]['address'][0]['state_name'] = $allStudentList[$i]['state_name'];
                    $studentList[$c]['address'][0]['country_id'] = $allStudentList[$i]['country'];
                    $studentList[$c]['address'][0]['country_name'] = $allStudentList[$i]['country_name'];
                    $studentList[$c]['address'][0]['postal_code'] = $allStudentList[$i]['postal_code'];
                    $studentList[$c]['address'][0]['address_type'] = $allStudentList[$i]['address_type'];
                } else {
                    for ($k = 0; $k < count($studentList); $k++) {
                        if ($studentList[$k]['user_id'] == $allStudentList[$i]['user_id']) {
                            $cnt = count($studentList[$k]['address']);
                            //$studentList[$k]['address'][$cnt]['name'] = $allStudentList[$i]['name'];
                            if ($allStudentList[$i]['name'] != "") {
                                $parentNames = explode(",", $allStudentList[$i]['name']);
                                if (count($parentNames) > 1) {
                                    $studentList[$k]['parent2_firstname'] = $parentNames[0];
                                    $studentList[$k]['parent2_lastname'] = $parentNames[1];
                                } else {
                                    $studentList[$k]['parent2_firstname'] = $parentNames[0];
                                    $studentList[$k]['parent2_lastname'] = '';
                                }
                            } else {
                                $studentList[$k]['parent2_firstname'] = '';
                                $studentList[$k]['parent2_lastname'] = '';
                            }
                            $studentList[$k]['address'][$cnt]['address1'] = $allStudentList[$i]['address1'];
                            $studentList[$k]['address'][$cnt]['address2'] = $allStudentList[$i]['address2'];
                            if ($allStudentList[$i]['email_ids'] != "") {
                                $emails = explode(",", $allStudentList[$i]['email_ids']);
                                $studentList[$k]['parent2_email_ids'] = $emails;
                            } else {
                                $studentList[$k]['parent2_email_ids'] = [];
                            }
                            $studentList[$k]['address'][$cnt]['city'] = $allStudentList[$i]['city'];
                            $studentList[$k]['address'][$cnt]['state_id'] = $allStudentList[$i]['state'];
                            $studentList[$k]['address'][$cnt]['state_name'] = $allStudentList[$i]['state_name'];
                            $studentList[$k]['address'][$cnt]['country_id'] = $allStudentList[$i]['country'];
                            $studentList[$k]['address'][$cnt]['country_name'] = $allStudentList[$i]['country_name'];
                            $studentList[$k]['address'][$cnt]['postal_code'] = $allStudentList[$i]['postal_code'];
                            $studentList[$k]['address'][$cnt]['address_type'] = $allStudentList[$i]['address_type'];
                        }
                    }
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $studentList;
//            $studentscount = $this->students_model->listcount();
//            $this->jsonarr["IsSuccess"] = true;
//            $this->jsonarr["ResponseObject"]['data'] = $studentsList;
//            $this->jsonarr["ResponseObject"]['total'] = $studentscount[0]['total_count'];
        }
        $this->common_model->createLog($params,'v1/student/list',$this->jsonarr,'list');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function edit_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['selected_user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Selected User Id should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "First_name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Last_name should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "status should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params, 'v1/student/edit', 'only request', 'edit');
            $userExists = $this->student_model->checkemail($params, $params['selected_user_id']);
            if (count($userExists) == 0) {
                $condition = array("user_id" => $params['selected_user_id']);
                $user = [];
                if (count($params['mobile']) > 0) {
                    $user['mobile'] = implode(",", $params['mobile']);
                }
                $user['modified_by'] = $params['user_id'];
                $user['status'] = $params['status'];
                $user['email_id'] = $params['email_id'];
                $userUpdate = $this->common_model->update('user', $user, $condition);
                if ($userUpdate) {
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = "User updated successfully";
                    $userProfile = [];
                    $userProfile['first_name'] = $params['first_name'];
                    $userProfile['last_name'] = $params['last_name'];
                    $userProfile['gender'] = $params['gender'];
                    $userProfile['birthday'] = $params['birthday'];
                    $userProfile['modified_by'] = $params['user_id'];
                    if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                        $userProfile['profile_url'] = $params['profile_url'];
                        $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                    }
                    $userProfileUpdate = $this->common_model->update('user_profile', $userProfile, $condition);
                    if ($userProfileUpdate) {
                        $getUserId = $this->common_model->getUserId($params['selected_user_id'], $params['school_id']);
                        $userCondition = "user_details_id = {$getUserId['user_details_id']} AND school_id = {$params['school_id']}";
                        $userProfileDetails = [];
                        $userProfileDetails['doj'] = $params['registration_date'];
                        $userProfileDetails['status'] = $params['status'];
                        $userProfileDetails['dropped_date'] = $params['dropped_date'];
                        $userProfileDetails['school_idno'] = $params['school_idno'];
                        $userProfileDetails['batch_id'] = $params['batch_id'];
                        if ($params['grade_id'] != '') {
                            $userProfileDetails['grade_id'] = $params['grade_id'];
                        } else {
                            $userProfileDetails['grade_id'] = 0;
                        }
                        $userProfileDetailUpdate = $this->common_model->update('user_profile_details', $userProfileDetails, $userCondition);
                        if ($userProfileDetailUpdate) {
                            $parent1Address = [];
                            $condition1 = array('address_type' => 2, 'user_id' => $params['selected_user_id']);
                            if ($params['parent1_firstname'] != "") {
                                $parent1Address['name'] = $params['parent1_firstname'] . "," . $params['parent1_lastname'];
                            }
                            $parent1Address['address1'] = $params['address'][0]['address1'];
                            $parent1Address['address2'] = $params['address'][0]['address2'];
                            if (count($params['parent1_email_ids']) > 0) {
                                $parent1Address['email_ids'] = implode(",", $params['parent1_email_ids']);
                            }
                            $parent1Address['city'] = $params['address'][0]['city'];
                            $parent1Address['state'] = $params['address'][0]['state'];
                            $parent1Address['country'] = $params['address'][0]['country'];
                            $parent1Address['postal_code'] = $params['address'][0]['postal_code'];
                            $parent2Address = [];
                            $condition2 = array('address_type' => 3, 'user_id' => $params['selected_user_id']);
                            $parent2Address['address_type'] = $params['address'][1]['address_type'];
                            if ($params['parent2_firstname'] != "") {
                                $parent2Address['name'] = $params['parent2_firstname'] . "," . $params['parent2_lastname'];
                            }
                            $parent2Address['address1'] = $params['address'][1]['address1'];
                            $parent2Address['address2'] = $params['address'][1]['address2'];
                            if (count($params['parent2_email_ids']) > 0) {
                                $parent2Address['email_ids'] = implode(",", $params['parent2_email_ids']);
                            }
                            $parent2Address['city'] = $params['address'][1]['city'];
                            $parent2Address['state'] = $params['address'][1]['state'];
                            $parent2Address['country'] = $params['address'][1]['country'];
                            $parent2Address['postal_code'] = $params['address'][1]['postal_code'];
                            $parent1 = $this->common_model->update('user_address', $parent1Address, $condition1);
                            $parent2 = $this->common_model->update('user_address', $parent2Address, $condition2);
                            if ($parent1 == true || ($parent1 == true && $parent2 == true)) {
                                $this->jsonarr["IsSuccess"] = true;
                                $this->jsonarr["ResponseObject"] = "Student updated successfully";
                            } else {
                                $this->jsonarr["IsSuccess"] = false;
                                $this->jsonarr["ErrorObject"] = "Student address not updated";
                            }
                        } else {
                            $this->jsonarr['IsSuccess'] = false;
                            $this->jsonarr['ErrorObject'] = "Failed to update user profile detail";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Student profile not updated";
                    }
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "Student not updated";
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Emailid already exists";
            }
        }
        $this->common_model->createLog($params,'v1/student/edit',$this->jsonarr,'edit');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function detail_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['selected_user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Selected User Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/student/detail','only request','detail');
            $studentDetail = [];
            $allStudentDetail = $this->student_model->studentDetail($params);
            for ($i = 0; $i < count($allStudentDetail); $i++) {
                $dataAvailable = false;
                for ($j = 0; $j < count($studentDetail); $j++) {
                    if ($studentDetail[$j]['user_id'] == $allStudentDetail[$i]['user_id']) {
                        $dataAvailable = true;
                    }
                }
                if (!$dataAvailable) {
                    $c = count($studentDetail);
                    $studentDetail[$c]['user_id'] = $allStudentDetail[$i]['user_id'];
                    $studentDetail[$c]['role_id'] = $allStudentDetail[$i]['role_id'];
                    $studentDetail[$c]['email_id'] = $allStudentDetail[$i]['email_id'];
                    $studentDetail[$c]['mobile'] = $allStudentDetail[$i]['mobile'];
                    $studentDetail[$c]['status'] = $allStudentDetail[$i]['status'];
                    $studentDetail[$c]['school_id'] = $allStudentDetail[$i]['school_id'];
                    $studentDetail[$c]['school_name'] = $allStudentDetail[$i]['school_name'];
                    $studentDetail[$c]['login_type'] = $allStudentDetail[$i]['login_type'];
                    $studentDetail[$c]['created_by'] = $allStudentDetail[$i]['created_by'];
                    $studentDetail[$c]['created_date'] = $allStudentDetail[$i]['created_date'];
                    $studentDetail[$c]['modified_by'] = $allStudentDetail[$i]['modified_by'];
                    $studentDetail[$c]['modified_date'] = $allStudentDetail[$i]['modified_date'];
                    $studentDetail[$c]['first_name'] = $allStudentDetail[$i]['first_name'];
                    $studentDetail[$c]['last_name'] = $allStudentDetail[$i]['last_name'];
                    $studentDetail[$c]['school_idno'] = $allStudentDetail[$i]['school_idno'];
                    $studentDetail[$c]['profile_url'] = $allStudentDetail[$i]['profile_url'];
                    $studentDetail[$c]['profile_thumb_url'] = $allStudentDetail[$i]['profile_thumb_url'];
                    $studentDetail[$c]['gender'] = $allStudentDetail[$i]['gender'];
                    $studentDetail[$c]['birthday'] = $allStudentDetail[$i]['birthday'];
                    $studentDetail[$c]['doj'] = $allStudentDetail[$i]['doj'];
                    $studentDetail[$c]['subject'] = $allStudentDetail[$i]['subject'];
                    $studentDetail[$c]['grade_id'] = $allStudentDetail[$i]['grade_id'];
                    $studentDetail[$c]['grade_name'] = $allStudentDetail[$i]['grade_name'];
                    $studentDetail[$c]['batch_id'] = $allStudentDetail[$i]['batch_id'];
                    $studentDetail[$c]['batch_name'] = $allStudentDetail[$i]['batch_name'];
                    $studentDetail[$c]['parent1_name'] = $allStudentDetail[$i]['name'];
                    $studentDetail[$c]['parent2_name'] = '';
                    $studentDetail[$c]['address'][0]['address1'] = $allStudentDetail[$i]['address1'];
                    $studentDetail[$c]['address'][0]['address2'] = $allStudentDetail[$i]['address2'];
                    $studentDetail[$c]['address'][0]['city'] = $allStudentDetail[$i]['city'];
                    $studentDetail[$c]['address'][0]['state_id'] = $allStudentDetail[$i]['state'];
                    $studentDetail[$c]['address'][0]['state_name'] = $allStudentDetail[$i]['state_name'];
                    $studentDetail[$c]['address'][0]['country_id'] = $allStudentDetail[$i]['country'];
                    $studentDetail[$c]['address'][0]['country_name'] = $allStudentDetail[$i]['country_name'];
                    $studentDetail[$c]['address'][0]['postal_code'] = $allStudentDetail[$i]['postal_code'];
                    $studentDetail[$c]['address'][0]['address_type'] = $allStudentDetail[$i]['address_type'];
                } else {
                    for ($k = 0; $k < count($studentDetail); $k++) {
                        if ($studentDetail[$k]['user_id'] == $allStudentDetail[$i]['user_id']) {
                            $cnt = count($studentDetail[$k]['address']);
                            $studentDetail[$k]['parent2_name'] = $allStudentDetail[$i]['name'];
                            $studentDetail[$k]['address'][$cnt]['address1'] = $allStudentDetail[$i]['address1'];
                            $studentDetail[$k]['address'][$cnt]['address2'] = $allStudentDetail[$i]['address2'];
                            $studentDetail[$k]['address'][$cnt]['city'] = $allStudentDetail[$i]['city'];
                            $studentDetail[$k]['address'][$cnt]['state_id'] = $allStudentDetail[$i]['state'];
                            $studentDetail[$k]['address'][$cnt]['state_name'] = $allStudentDetail[$i]['state_name'];
                            $studentDetail[$k]['address'][$cnt]['country_id'] = $allStudentDetail[$i]['country'];
                            $studentDetail[$k]['address'][$cnt]['country_name'] = $allStudentDetail[$i]['country_name'];
                            $studentDetail[$k]['address'][$cnt]['postal_code'] = $allStudentDetail[$i]['postal_code'];
                            $studentDetail[$k]['address'][$cnt]['address_type'] = $allStudentDetail[$i]['address_type'];
                        }
                    }
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $studentDetail;
        }
        $this->common_model->createLog($params, 'v1/student/detail', $this->jsonarr, 'detail');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function classList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $startDate = '';
            $endDate = '';
            $class_ids = [];
            if (isset($params['grade_id']) && $params['grade_id'] != '') {
                $getStudentGrade = $this->student_model->getStudentGrade($params);
                foreach ($getStudentGrade as $key => $value) {
                    if ($value['grade_id'] == $params['grade_id']) {
                        $startDate = $value['active_date'];
                    }
                    if ($value['grade_id'] > $params['grade_id']) {
                        $endDate = $value['active_date'];
                    }
                }
            }
            $day = date('N');
            $classList = $this->student_model->classList($params, $startDate, $endDate, $day);
            $this->common_model->createLog($params, 'v1/student/classList', 'only request', 'classList');
            usort($classList, function ($a, $b) {
                return $a['dateDifference'] <=> $b['dateDifference'];
            });
            foreach ($classList as $key => $value) {
                array_push($class_ids,$value['class_id']);
                unset($classList[$key]['dateDifference']);
                if ($value['video_link'] != '') {
                    $classList[$key]['video_link'] = json_decode($value['video_link'], true);
                } else {
                    $classList[$key]['video_link'] = [];
                }
                $value['role_id'] = $params['role_id'];
                $classSchedule = $this->classes_model->getClassSchedule($value);
                foreach ($classSchedule as $key1 => $value1) {
                    if ($params['role_id'] == 2 || $params['role_id'] == 6) {
                        $classSchedule[$key1]['shechdule_id'] = $value1['shechdule_id'];
                        $teacherName = $this->classes_model->getTeacherName($classSchedule[$key1]['teacher_id']);
                        $teacher_id = explode(',', $value1['teacher_id']);
                        $teacherId = explode(',', $teacherName['teacher_id']);
                        $teacher_name = explode(',', $teacherName['teacher_name']);
                        for ($z = 0; $z < count($teacher_id); $z++) {
                            for ($y = 0; $y < count($teacherId); $y++) {
                                if ($teacher_id[$z] == $teacherId[$y]) {
                                    array_push($teacher, $teacher_name[$y]);
                                    array_push($teacherid, $teacherId[$y]);
                                }
                            }
                        }
                        $classSchedule[$key1]['teacher_name'] = array_unique($teacher);
                        $classSchedule[$key1]['teacher_id'] = array_unique($teacherid);
                        $teacher = $teacherid = [];
                    } else {
                        $classSchedule[$key1]['teacher_name'] = explode(',', $value1['teacher_name']);
                        $classSchedule[$key1]['teacher_id'] = explode(',', $value1['teacher_id']);
                    }
                    if ($classSchedule[$key1]['meeting_link'] == '') {
                        $classSchedule[$key1]['meeting_link'] = $value['meeting_link'];
                    }
                    if ($classSchedule[$key1]['meeting_id'] == '') {
                        $classSchedule[$key1]['meeting_id'] = $value['meeting_id'];
                    }
                    if ($classSchedule[$key1]['passcode'] == '') {
                        $classSchedule[$key1]['passcode'] = $value['passcode'];
                    }
                    if ($classSchedule[$key1]['telephone_number'] == '') {
                        $classSchedule[$key1]['telephone_number'] = '';
                    }
                }
                $classList[$key]['availabilityDate'] = $classSchedule;
            }

            if (isset($params['response_type']) && $params['response_type'] == 'SSE') {
                $class_ids = array_unique($class_ids);
                if(count($class_ids) > 0){
                    $classId = implode(',', $class_ids);
                    $classNotes = $this->classes_model->getClassNotes($classId);
                    $condition = "WHERE m.class_id IN ({$classId}) AND md.user_id = {$params['user_id']} AND md.is_read = 0";
                    $getMessageCount = $this->mailbox_model->getMailBox($condition);
                }
                $data = [];
                $data['classList'] = array_values(array_map("unserialize", array_unique(array_map("serialize", $classList))));
                foreach ($data['classList'] as $key => $classId) {
                    $data['classList'][$key]['announcement_count'] = 0;
                    $data['classList'][$key]['inbox_count'] = 0;
                    $data['classList'][$key]['announcement_message'] = [];
                    $data['classList'][$key]['inbox_message'] = [];
                    foreach ($classNotes as $key1 => $value) {
                        if ($value['class_id'] == $classId['class_id']) {
                            $data['classList'][$key]['announcement_message'][] = $value;
                           // $data['classList'][$key]['announcement_count']++;
                        }
                    }
                    foreach ($getMessageCount as $key1 => $value) {
                        if ($value['class_id'] == $classId['class_id']) {
                            $data['classList'][$key]['inbox_message'][] = $value;
                            $data['classList'][$key]['inbox_count']++;
                        }
                    }                    
                }
                echo 'data:' . json_encode($data);
                exit;
            } else {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = array_values(array_map("unserialize", array_unique(array_map("serialize", $classList))));
            }    
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params, 'v1/student/classList', $this->jsonarr, 'classList');
        return $this->printjson($this->jsonarr);
    }

    public function assignmentList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params, 'v1/student/assignmentList', 'only request', 'assignmentList');
            $startDate = '';
            $endDate = '';
            if (isset($params['grade_id']) && $params['grade_id'] != '') {
                $getStudentGrade = $this->student_model->getStudentGrade($params);
                foreach ($getStudentGrade as $key => $value) {
                    if ($value['grade_id'] == $params['grade_id']) {
                        $startDate = $value['active_date'];
                    }
                    if ($value['grade_id'] > $params['grade_id']) {
                        $endDate = $value['active_date'];
                    }
                }
            }
            $assignmentList = $this->student_model->assignmentList($params, $startDate, $endDate);
            if(isset($params['sort']) && ($params['sort'] == 1 || $params['sort'] == 0)){
                usort($assignmentList, function ($a, $b) {
                    return $a['dateDifference'] <=> $b['dateDifference'];
                });
            }
            foreach ($assignmentList as $key => $value) {
                unset($assignmentList[$key]['dateDifference']);
                if ($assignmentList[$key]['links'] != '') {
                    $assignmentList[$key]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                } else {
                    $assignmentList[$key]['links'] = [];
                }
                if ($value['file_path'] != '') {
                    if ($this->config->item('filePathBase64') == true && $params['platform'] != 'ios') {
                        $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode($value['file_path']))));
                    } else {
                        $base64FilePath = json_decode($value['file_path'],true);
                        if (!isset($base64FilePath[0]['original_image_url']) && count($base64FilePath) > 0) {
                            $base64FilePath[0]['original_image_url'] = '';
                            $base64FilePath[0]['image'] = '';
                            $base64FilePath[0]['size'] = 0;
                        }
                    }
                    $assignmentList[$key]['file_path'] = $base64FilePath;
                } else {
                    $assignmentList[$key]['file_path'] = [];
                }
                if ($value['file_path'] != '') {
                    $pdfContent = 0;
                    $file_path = json_decode($value['file_path'], true);
                    if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                        $pdfContent = 1;
                    }
                    $assignmentList[$key]['is_pdf_content'] = $pdfContent;
                } else {
                    $assignmentList[$key]['is_pdf_content'] = 0;
                }
                if ($value['answerkey_path'] != '' && $value['answerkey_path'] != '[]') {
                    if ($this->config->item('filePathBase64') == true && $params['platform'] != 'ios') {
                        $base64answerkey = base64_encode(base64_encode(base64_encode(base64_encode($value['answerkey_path']))));
                    } else {
                        $base64answerkey = json_decode($value['answerkey_path']);
                    }
                    $assignmentList[$key]['answerkey_path'] = $base64answerkey;
                } else {
                    $assignmentList[$key]['answerkey_path'] = [];
                }
                if ($assignmentList[$key]['end_date'] < date('Y-m-d')
                    && $assignmentList[$key]['end_date'] != '0000-00-00'
                    && $assignmentList[$key]['student_content_status'] < 3) {
                    $difference = strtotime(date('Y-m-d')) - strtotime($assignmentList[$key]['end_date']);
                    $days = ceil(abs($difference / 86400));
                    $assignmentList[$key]['overdue'] = -$days;
                } else if ($assignmentList[$key]['end_date'] > date('Y-m-d')
                    && $assignmentList[$key]['end_date'] != '0000-00-00'
                    && $assignmentList[$key]['student_content_status'] < 3) {
                    $difference = strtotime(date('Y-m-d')) - strtotime($assignmentList[$key]['end_date']);
                    $days = ceil(abs($difference / 86400));
                    $assignmentList[$key]['overdue'] = $days;
                } else {
                    $assignmentList[$key]['overdue'] = 0;
                }
            }
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $assignmentList;
        }
        $this->common_model->createLog($params, 'v1/student/assignmentList', $this->jsonarr, 'assignmentList');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function assessmentList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params, 'v1/student/assessmentList', 'only request', 'assessmentList');
            $startDate = '';
            $endDate = '';
            if (isset($params['grade_id']) && $params['grade_id'] != '') {
                $getStudentGrade = $this->student_model->getStudentGrade($params);
                foreach ($getStudentGrade as $key => $value) {
                    if ($value['grade_id'] == $params['grade_id']) {
                        $startDate = $value['active_date'];
                    }
                    if ($value['grade_id'] > $params['grade_id']) {
                        $endDate = $value['active_date'];
                    }
                }
            }
            $assessmentList = $this->student_model->assessmentList($params,$startDate,$endDate);
            usort($assessmentList, function ($a, $b) {
                return $a['dateDifference'] <=> $b['dateDifference'];
            });
            foreach ($assessmentList as $key => $value) {
                unset($assessmentList[$key]['dateDifference']);
                if ($assessmentList[$key]['links'] != '') {
                    $assessmentList[$key]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                } else {
                    $assessmentList[$key]['links'] = [];
                }
                if ($value['file_path'] != '') {
                    if ($this->config->item('filePathBase64') == true && $params['platform'] != 'ios') {
                        $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode($value['file_path']))));
                    } else {
                        $base64FilePath = json_decode($value['file_path'],true);
                        if (!isset($base64FilePath[0]['original_image_url']) && count($base64FilePath) > 0) {
                            $base64FilePath[0]['original_image_url'] = '';
                            $base64FilePath[0]['image'] = '';
                            $base64FilePath[0]['size'] = 0;
                        }
                    }
                    $assessmentList[$key]['file_path'] = $base64FilePath;
                } else {
                    $assessmentList[$key]['file_path'] = [];
                }
                if ($value['file_path'] != '') {
                    $pdfContent = 0;
                    $file_path = json_decode($value['file_path'], true);
                    if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                        $pdfContent = 1;
                    }
                    $assessmentList[$key]['is_pdf_content'] = $pdfContent;
                } else {
                    $assessmentList[$key]['is_pdf_content'] = 0;
                }
                if ($value['answerkey_path'] != '' && $value['answerkey_path'] != '[]') {
                    if ($this->config->item('filePathBase64') == true && $params['platform'] != 'ios') {
                        $base64answerkey = base64_encode(base64_encode(base64_encode(base64_encode($value['answerkey_path']))));
                    } else {
                        $base64answerkey = json_decode($value['answerkey_path']);
                    }
                    $assessmentList[$key]['answerkey_path'] = $base64answerkey;
                } else {
                    $assessmentList[$key]['answerkey_path'] = [];
                }
                if ($assessmentList[$key]['end_date'] < date('Y-m-d')
                    && $assessmentList[$key]['end_date'] != '0000-00-00'
                    && $assessmentList[$key]['student_content_status'] < 3) {
                    $difference = strtotime(date('Y-m-d')) - strtotime($assessmentList[$key]['end_date']);
                    $days = ceil(abs($difference / 86400));
                    $assessmentList[$key]['overdue'] = -$days;
                } else if ($assessmentList[$key]['end_date'] > date('Y-m-d')
                    && $assessmentList[$key]['end_date'] != '0000-00-00'
                    && $assessmentList[$key]['student_content_status'] < 3) {
                    $difference = strtotime(date('Y-m-d')) - strtotime($assessmentList[$key]['end_date']);
                    $days = ceil(abs($difference / 86400));
                    $assessmentList[$key]['overdue'] = $days;
                } else {
                    $assessmentList[$key]['overdue'] = 0;
                }
            }
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $assessmentList;
        }
        $this->common_model->createLog($params, 'v1/student/assessmentList', $this->jsonarr, 'assessmentList');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function resourcesList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id Should not be Empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/resourcesList','only request','resourcesList');
            $startDate = '';
            $endDate = '';
            if(isset($params['grade_id']) && $params['grade_id'] != '') {
                $getStudentGrade = $this->student_model->getStudentGrade($params);
                foreach ($getStudentGrade as $key => $value){
                    if($value['grade_id'] == $params['grade_id']) {
                        $startDate = $value['active_date'];
                    }
                    if($value['grade_id'] > $params['grade_id']){
                        $endDate = $value['active_date'];
                    }
                }
            }
            $resourcesList = $this->student_model->Resourcelist($params,$startDate,$endDate);
            foreach ($resourcesList as $key => $value) {
                if ($resourcesList[$key]['links'] != '') {
                    $resourcesList[$key]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                } else {
                    $resourcesList[$key]['links'] = [];
                }
                if ($value['file_path'] != '') {
                    if ($this->config->item('filePathBase64') == true && $params['platform'] != 'ios') {
                        $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode($value['file_path']))));
                    } else {
                        $base64FilePath = json_decode($value['file_path'],true);
                        if (!isset($base64FilePath[0]['original_image_url']) && count($base64FilePath) > 0) {
                            $base64FilePath[0]['original_image_url'] = '';
                            $base64FilePath[0]['image'] = '';
                            $base64FilePath[0]['size'] = 0;
                        }
                    }
                    $resourcesList[$key]['file_path'] = $base64FilePath;
                } else {
                    $resourcesList[$key]['file_path'] = [];
                }
                if ($value['file_path'] != '') {
                    $pdfContent = 0;
                    $file_path = json_decode($value['file_path'], true);
                    if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                        $pdfContent = 1;
                    }
                    $resourcesList[$key]['is_pdf_content'] = $pdfContent;
                } else {
                    $resourcesList[$key]['is_pdf_content'] = 0;
                }
                if ($value['annotation'] != '') {
                    $annotation = $this->common_model->annotation($value['annotation']);
                    $resourcesList[$key]['annotation'] = $params['platform'] == 'ios' ? $annotation : json_decode($annotation);
                } else {
                    $resourcesList[$key]['annotation'] = $params['platform'] == 'ios' ? '' : [];
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $resourcesList;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/resourcesList',$this->jsonarr,'resourcesList');
        return $this->printjson($this->jsonarr);
    }

    public function curriculumList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        //$this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params, 'v1/student/curriculumList', 'only request', 'curriculumList');
            $startDate = '';
            $endDate = '';
            if (isset($params['grade_id']) && $params['grade_id'] != '') {
                $getStudentGrade = $this->student_model->getStudentGrade($params);
                foreach ($getStudentGrade as $key => $value) {
                    if ($value['grade_id'] == $params['grade_id']) {
                        $startDate = $value['active_date'];
                    }
                    if ($value['grade_id'] > $params['grade_id']) {
                        $endDate = $value['active_date'];
                    }
                }
            }
            $curriculumList = $this->student_model->curriculumList($params, $startDate, $endDate);
            if (isset($params['sort']) && ($params['sort'] == 1 || $params['sort'] == 0)) {
                usort($curriculumList, function ($a, $b) {
                    return $a['dateDifference'] <=> $b['dateDifference'];
                });
            }
            foreach ($curriculumList as $key => $value) {
                if($value['student_content_status'] == 3 || ($curriculumList[$key]['end_date'] < date('Y-m-d')
                    && $curriculumList[$key]['end_date'] != '0000-00-00'
                    && $curriculumList[$key]['student_content_status'] < 3)){
                    unset($curriculumList[$key]['dateDifference']);
                    if ($curriculumList[$key]['links'] != '') {
                        $curriculumList[$key]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                    } else {
                        $curriculumList[$key]['links'] = [];
                    }
                    if ($value['file_path'] != '') {
                        if ($this->config->item('filePathBase64') == true && $params['platform'] != 'ios') {
                            $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode($value['file_path']))));
                        } else {
                            $base64FilePath = json_decode($value['file_path'], true);
                            if (!isset($base64FilePath[0]['original_image_url']) && count($base64FilePath) > 0) {
                                $base64FilePath[0]['original_image_url'] = '';
                                $base64FilePath[0]['image'] = '';
                                $base64FilePath[0]['size'] = 0;
                            }
                        }
                        $curriculumList[$key]['file_path'] = $base64FilePath;
                    } else {
                        $curriculumList[$key]['file_path'] = [];
                    }
                    if ($value['file_path'] != '') {
                        $pdfContent = 0;
                        $file_path = json_decode($value['file_path'], true);
                        if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                            $pdfContent = 1;
                        }
                        $curriculumList[$key]['is_pdf_content'] = $pdfContent;
                    } else {
                        $curriculumList[$key]['is_pdf_content'] = 0;
                    }
                    if ($value['answerkey_path'] != '' && $value['answerkey_path'] != '[]') {
                        if ($this->config->item('filePathBase64') == true && $params['platform'] != 'ios') {
                            $base64answerkey = base64_encode(base64_encode(base64_encode(base64_encode($value['answerkey_path']))));
                        } else {
                            $base64answerkey = json_decode($value['answerkey_path']);
                        }
                        $curriculumList[$key]['answerkey_path'] = $base64answerkey;
                    } else {
                        $curriculumList[$key]['answerkey_path'] = [];
                    }
                    if (
                        $curriculumList[$key]['end_date'] < date('Y-m-d')
                        && $curriculumList[$key]['end_date'] != '0000-00-00'
                        && $curriculumList[$key]['student_content_status'] < 3
                    ) {
                        $difference = strtotime(date('Y-m-d')) - strtotime($curriculumList[$key]['end_date']);
                        $days = ceil(abs($difference / 86400));
                        $curriculumList[$key]['overdue'] = -$days;
                    } else if (
                        $curriculumList[$key]['end_date'] > date('Y-m-d')
                        && $curriculumList[$key]['end_date'] != '0000-00-00'
                        && $curriculumList[$key]['student_content_status'] < 3
                    ) {
                        $difference = strtotime(date('Y-m-d')) - strtotime($curriculumList[$key]['end_date']);
                        $days = ceil(abs($difference / 86400));
                        $curriculumList[$key]['overdue'] = $days;
                    } else {
                        $curriculumList[$key]['overdue'] = 0;
                    }
                    } else {
                        unset($curriculumList[$key]);
                    }
                
            }
            if (isset($params['response_type']) && $params['response_type'] == 'SSE') {
                $getLatestCurriculum = $this->student_model->getLatestCurriculum($params);
                $data = [];
                $data['curriculumList'] = array_values($curriculumList);
                $data['LatestCurriculum'] =  $getLatestCurriculum;
                echo 'data:' . json_encode($data);
                exit;
            } else {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = $curriculumList;
            }
  
        }
        $this->common_model->createLog($params, 'v1/student/curriculumList', $this->jsonarr, 'curriculumList');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function dashboard_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Teacher Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/student/dashboard','only request','dashboard');
            $dashboard = [];
            //$dashboard = $this->student_model->dashboardList($params);
            $classList = $this->student_model->classList($params);
            $assignmentList = $this->student_model->assignmentList($params);
            $assessmentList = $this->student_model->assessmentList($params);
            $dashboard['classes'] = $classList;
            $dashboard['assignments'] = $assignmentList;
            $dashboard['assesments'] = $assessmentList;
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $dashboard;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/dashboard',$this->jsonarr,'dashboard');
        return $this->printjson($this->jsonarr);

    }

    public function classDetail_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Teacher Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/classDetail','only request','classDetail');
            $classDetail = $this->student_model->classDetail($params);
            $classNotes = $this->student_model->classNotes($params);
            $classDetail[0]['notes'] = $classNotes;
            foreach ($classDetail as $key => $value) {
                if ($classDetail[$key]['video_link'] != '') {
                    $classDetail[$key]['video_link'] = json_decode($value['video_link'], true);
                } else {
                    $classDetail[$key]['video_link'] = [];
                }
                $day = date('N');
                //$time = date('h:i A');
                $zoomInstance = [];
                $zoomApi = $this->student_model->getZoomApi($params);
                if (isset($params['schedule_id']) && $params['schedule_id'] != '' && $params['schedule_id'] != "null") {
                    $getClassMeeting = $this->student_model->getClassMeeting($params);
                    if (count($getClassMeeting) > 0) {
                        if ($getClassMeeting[0]['meeting_link'] != '') {
                            $classDetail[$key]['student_link'] = $getClassMeeting[0]['student_link'];
                            $classDetail[$key]['meeting_link'] = $getClassMeeting[0]['meeting_link'];
                            $classDetail[$key]['meeting_id'] = $getClassMeeting[0]['meeting_id'];
                            $classDetail[$key]['passcode'] = $getClassMeeting[0]['passcode'];
                            $classDetail[$key]['schedule_id'] = $params['schedule_id'];
                        }

                        $getZoomkeys = $this->common_model->getZoomKeys($params['school_id']);
                        $classDetail[$key]['schedule_id'] = $params['schedule_id'];
                        $classDetail[$key]['teacher_id'] = $getClassMeeting[0]['teacher_id'] != '' ? explode(',', $getClassMeeting[0]['teacher_id']):[];
                        $zoomArray = [];
                        foreach ($getZoomkeys as $key1 => $value) {
                            if ($value['name'] == 'zoom_secretkey' || $value['name'] == 'zoom_apikey') {
                                $zoomArray[$value['name']] = $value['value'];
                            }
                        }
                        function generate_signature($api_key, $api_secret, $meeting_number, $role)
                        {
                            //Set the timezone to UTC
                            date_default_timezone_set("UTC");
                            $time = time() * 1000 - 30000;//time in milliseconds (or close enough)
                            $data = base64_encode($api_key . $meeting_number . $time . $role);
                            $hash = hash_hmac('sha256', $data, $api_secret, true);
                            $_sig = $api_key . "." . $meeting_number . "." . $time . "." . $role . "." . base64_encode($hash);
                            //return signature, url safe base64 encoded
                            return rtrim(strtr(base64_encode($_sig), '+/', '-_'), '=');
                        }

                        $meetingId = str_replace(' ', '', $getClassMeeting[0]['meeting_id']);
                        $zoomSignature = generate_signature($zoomArray['zoom_apikey'], $zoomArray['zoom_secretkey'], $meetingId, 0);
                        $classDetail[$key]['allow_zoom_api'] = $zoomApi;
                        $classDetail[$key]['zoomSignature'] = $zoomSignature;
                        $classDetail[$key]['zoom_apiKey'] = $zoomArray['zoom_apikey'];
                        $classDetail[$key]['zoom_apiSecret'] = $zoomArray['zoom_secretkey'];
                    } else {
                        $classDetail[$key]['student_link'] = "";
                        $classDetail[$key]['meeting_link'] = $classDetail[0]['meeting_link'];
                        $classDetail[$key]['meeting_id'] = $classDetail[0]['meeting_id'];
                        $classDetail[$key]['passcode'] = $classDetail[0]['passcode'];
                        $classDetail[$key]['allow_zoom_api'] = $zoomApi;
                    }
                } else {
                    $getClassMeeting = $this->student_model->getClassMeetingId($params,$day);
                    if($getClassMeeting) {
                        $classDetail[$key]['meeting_link'] = $getClassMeeting[0]['meeting_link'];
                        $classDetail[$key]['meeting_id'] = $getClassMeeting[0]['meeting_id'];
                        $classDetail[$key]['passcode'] = $getClassMeeting[0]['passcode'];
                    } else {
                        $classDetail[$key]['meeting_link'] = $classDetail[0]['meeting_link'];
                        $classDetail[$key]['meeting_id'] = $classDetail[0]['meeting_id'];
                        $classDetail[$key]['passcode'] = $classDetail[0]['passcode'];
                    }
                    $classDetail[$key]['student_link'] = '';
                    $classDetail[$key]['schedule_id'] = '';
                    $classDetail[$key]['allow_zoom_api'] = $zoomApi;
                }
                //makeup class
                if (isset($value['student_class_type']) && $value['student_class_type'] == 2) {
                    $class_ids = [];
                    array_push($class_ids, $value['from_class']);
                    array_push($class_ids, $params['class_id']);
                    $params['class_id'] = implode(',', $class_ids);
                }
            }
            $resourceDetail = $this->student_model->resourceDetail($params);
            $i = 0;
            foreach ($resourceDetail as $value) {
                if ($params['platform'] == 'web' && $value['file_path'] != '') {
                    if ($this->config->item('filePathBase64') == true) {
                        $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode(($value['file_path'])))));
                    }
                    if ($this->config->item('filePathBase64') == true) {
                        $resourceDetail[$i]['file_path'] = $base64FilePath;
                    } else {
                        if ($resourceDetail[$i]['file_path'] != '') {
                            $resourceDetail[$i]['file_path'] = json_decode($resourceDetail[$i]['file_path']);
                        } else {
                            $resourceDetail[$i]['file_path'] = [];
                        }
                    }
                    //$resourceDetail[$i]['file_path'] = $this->config->item('filePathBase64') == true ? $base64FilePath : json_decode($value['file_path']) != '' ? json_decode($value['file_path']) : [];
                } elseif ($params['platform'] == 'ios') {
                    if ($resourceDetail[$i]['file_path'] != '') {
                        $resourceDetail[$i]['file_path'] = json_decode($value['file_path'], true);
                        if (!isset($resourceDetail[$i]['file_path'][0]['original_image_url'])) {
                            $resourceDetail[$i]['file_path'][0]['original_image_url'] = '';
                            $resourceDetail[$i]['file_path'][0]['image'] = '';
                            $resourceDetail[$i]['file_path'][0]['size'] = 0;
                            $resourceDetail[$i]['file_path'][0]['type'] = '';
                        }
                    } else {
                        $resourceDetail[$i]['file_path'] = [];
                    }
                }
                if ($value['file_path'] != '') {
                    $pdfContent = 0;
                    $file_path = json_decode($value['file_path'], true);
                    if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                        $pdfContent = 1;
                    }
                    $resourceDetail[$i]['is_pdf_content'] = $pdfContent;
                } else {
                    $resourceDetail[$i]['is_pdf_content'] = 0;
                }
                if ($resourceDetail[$i]['links'] != '') {
                    $resourceDetail[$i]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                } else {
                    $resourceDetail[$i]['links'] = [];
                }
                $i++;
            }
            $assignmentDetail = $this->student_model->assignmentDetail($params);
            $j = 0;
            foreach ($assignmentDetail as $value) {
                if ($params['platform'] == 'web') {
                    if ($this->config->item('filePathBase64') == true) {
                        $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode(($value['file_path'])))));
                    }
                    if ($this->config->item('filePathBase64') == true) {
                        $assignmentDetail[$j]['file_path'] = $base64FilePath;
                    } else {
                        if ($assignmentDetail[$j]['file_path'] != '') {
                            $assignmentDetail[$j]['file_path'] = json_decode($assignmentDetail[$j]['file_path']);
                        } else {
                            $assignmentDetail[$j]['file_path'] = [];
                        }
                    }
                    //$assignmentDetail[$j]['file_path'] = $this->config->item('filePathBase64') == true ? $base64FilePath : json_decode($value['file_path']) != '' ? json_decode($value['file_path']) : [];
                } elseif ($params['platform'] == 'ios') {
                    if ($assignmentDetail[$j]['file_path'] != '') {
                        $assignmentDetail[$j]['file_path'] = json_decode($value['file_path'],true);
                        if (!isset($assignmentDetail[$j]['file_path'][0]['original_image_url'])) {
                            $assignmentDetail[$j]['file_path'][0]['original_image_url'] = '';
                            $assignmentDetail[$j]['file_path'][0]['image'] = '';
                            $assignmentDetail[$j]['file_path'][0]['size'] = 0;
                            $assignmentDetail[$j]['file_path'][0]['type'] = '';
                        }
                    } else {
                        $assignmentDetail[$j]['file_path'] = [];
                    }
                }
                if ($value['file_path'] != '') {
                    $pdfContent = 0;
                    $file_path = json_decode($value['file_path'], true);
                    if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                        $pdfContent = 1;
                    }
                    $assignmentDetail[$j]['is_pdf_content'] = $pdfContent;
                } else {
                    $assignmentDetail[$j]['is_pdf_content'] = 0;
                }
                if ($assignmentDetail[$j]['links'] != '') {
                    $assignmentDetail[$j]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                } else {
                    $assignmentDetail[$j]['links'] = [];
                }
                if ($assignmentDetail[$j]['end_date'] < date('Y-m-d')
                    && $assignmentDetail[$j]['end_date'] != '0000-00-00'
                    && $assignmentDetail[$j]['student_content_status'] < 3) {
                    $difference = strtotime(date('Y-m-d')) - strtotime($assignmentDetail[$key]['end_date']);
                    $days = ceil(abs($difference / 86400));
                    $assignmentDetail[$j]['overdue'] = $days . " Days";
                } else {
                    $assignmentDetail[$j]['overdue'] = 0 . " Days";
                }
                $j++;
            }
            $assessmentDetail = $this->student_model->assessmentDetail($params);
            $k = 0;
            foreach ($assessmentDetail as $value) {
                if ($params['platform'] == 'web') {
                    if ($this->config->item('filePathBase64') == true) {
                        $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode(($value['file_path'])))));
                    }
                    if ($this->config->item('filePathBase64') == true) {
                        $assessmentDetail[$k]['file_path'] = $base64FilePath;
                    } else {
                        if ($assessmentDetail[$k]['file_path'] != '') {
                            $assessmentDetail[$k]['file_path'] = json_decode($assessmentDetail[$k]['file_path']);
                        } else {
                            $assessmentDetail[$k]['file_path'] = [];
                        }
                    }
                    //$assessmentDetail[$k]['file_path'] = $this->config->item('filePathBase64') == true ? $base64FilePath : json_decode($value['file_path']) != '' ? json_decode($value['file_path']) : [];
                } elseif ($params['platform'] == 'ios') {
                    if ($assessmentDetail[$k]['file_path'] != '') {
                        $assessmentDetail[$k]['file_path'] = json_decode($value['file_path'],true);
                        if (!isset($assessmentDetail[$k]['file_path'][0]['original_image_url'])) {
                            $assessmentDetail[$k]['file_path'][0]['original_image_url'] = '';
                            $assessmentDetail[$k]['file_path'][0]['image'] = '';
                            $assessmentDetail[$k]['file_path'][0]['size'] = 0;
                            $assessmentDetail[$k]['file_path'][0]['type'] = '';
                        }
                    } else {
                        $assessmentDetail[$k]['file_path'] = [];
                    }
                }
                if ($value['file_path'] != '') {
                    $pdfContent = 0;
                    $file_path = json_decode($value['file_path'], true);
                    if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                        $pdfContent = 1;
                    }
                    $assessmentDetail[$k]['is_pdf_content'] = $pdfContent;
                } else {
                    $assessmentDetail[$k]['is_pdf_content'] = 0;
                }
                if ($assessmentDetail[$k]['links'] != '') {
                    $assessmentDetail[$k]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                } else {
                    $assessmentDetail[$k]['links'] = [];
                }
                $k++;
            }
            if($params['platform'] == 'web'){
                $curriculumDetail = $this->student_model->curriculumDetail($params);
                $k = 0;
                foreach ($curriculumDetail as $value) {
                    if ($params['platform'] == 'web') {
                        if ($this->config->item('filePathBase64') == true) {
                            $base64FilePath = base64_encode(base64_encode(base64_encode(base64_encode(($value['file_path'])))));
                        }
                        if ($this->config->item('filePathBase64') == true) {
                            $curriculumDetail[$k]['file_path'] = $base64FilePath;
                        } else {
                            if ($curriculumDetail[$k]['file_path'] != '') {
                                $curriculumDetail[$k]['file_path'] = json_decode($curriculumDetail[$k]['file_path']);
                            } else {
                                $curriculumDetail[$k]['file_path'] = [];
                            }
                        }
                    } elseif ($params['platform'] == 'ios') {
                        if ($curriculumDetail[$k]['file_path'] != '') {
                            $curriculumDetail[$k]['file_path'] = json_decode($value['file_path'], true);
                            if (!isset($curriculumDetail[$k]['file_path'][0]['original_image_url'])) {
                                $curriculumDetail[$k]['file_path'][0]['original_image_url'] = '';
                                $curriculumDetail[$k]['file_path'][0]['image'] = '';
                                $curriculumDetail[$k]['file_path'][0]['size'] = 0;
                                $curriculumDetail[$k]['file_path'][0]['type'] = '';
                            }
                        } else {
                            $curriculumDetail[$k]['file_path'] = [];
                        }
                    }
                    if ($value['file_path'] != '') {
                        $pdfContent = 0;
                        $file_path = json_decode($value['file_path'], true);
                        if (isset($file_path[0]['original_image_url']) && $file_path[0]['original_image_url'] != '') {
                            $pdfContent = 1;
                        }
                        $curriculumDetail[$k]['is_pdf_content'] = $pdfContent;
                    } else {
                        $curriculumDetail[$k]['is_pdf_content'] = 0;
                    }
                    if ($curriculumDetail[$k]['links'] != '') {
                        $curriculumDetail[$k]['links'] = (json_decode($value['links'], true) == NULL) ? explode(",", $value['links']) : json_decode($value['links']);
                    } else {
                        $curriculumDetail[$k]['links'] = [];
                    }
                    $k++;
                }
            }
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject']['class_detail'] = $classDetail;
            $this->jsonarr['ResponseObject']['resource_detail'] = $resourceDetail;
            $this->jsonarr['ResponseObject']['assignment_detail'] = $assignmentDetail;
            $this->jsonarr['ResponseObject']['assessment_detail'] = $assessmentDetail;
            if($params['platform'] == 'web'){
                $this->jsonarr['ResponseObject']['curriculum_detail'] = $curriculumDetail;
            }
        }
        $this->common_model->createLog($params,'v1/student/classDetail',$this->jsonarr,'classDetail');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function contentStudentList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/contentStudentList','only request','contentStudentList');
            $list = $this->student_model->contentStudentList($params);
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $list;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/contentStudentList',$this->jsonarr,'contentStudentList');
        return $this->printjson($this->jsonarr);
    }

    public function saveAnnotation_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['annotation'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Annotation should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/student/saveAnnotation','only request','saveAnnotation');
            $folder = "../uploads/studentAnnotation/";
           // $getStudentContentId = $this->student_model->getStudentContent($params);
            $fileName = "student-annotation".$params['student_content_id'].$params['class_id'].$params['content_id'].'.json';
            $createAnnotationFile = $this->common_model->createFlatFile($folder,$fileName,$params['annotation']);
            $path = "uploads/studentAnnotation/".$fileName;
            $data = array('annotation' => $path);
            $condition = array(
                'id' => $params['student_content_id']
            );
            $update = $this->common_model->update('student_content', $data, $condition);
            if ($update) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Annotation updated";
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ErrorObject'] = "Annotation Not Updated";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/saveAnnotation',$this->jsonarr,'saveAnnotation');
        return $this->printjson($this->jsonarr);
    }
    public function deleteAnnotation_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } else {
            $this->common_model->createLog($params,'v1/student/deleteAnnotation','only request','deleteAnnotation');
            $folder = "../uploads/studentAnnotation/";
          //  $getStudentContentId = $this->student_model->getStudentContent($params);
            $fileName = "student-annotation". $params['student_content_id'].$params['class_id'].$params['content_id'].'.json';
            $createAnnotationFile = $this->common_model->createFlatFile($folder,$fileName,$params['annotation']);
            $path = "uploads/studentAnnotation/".$fileName;
            $data = array('annotation' => $path);
            $deleteCondition = array(
                'id' => $params['student_content_id']
            );
            $delete = $this->common_model->update('student_content', $data, $deleteCondition);
            if ($delete) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Annotation Deleted";
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ErrorObject'] = "Annotation Not Deleted";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/deleteAnnotation',$this->jsonarr,'deleteAnnotation');
        return $this->printjson($this->jsonarr);
    }


    public function studentQuestionList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif ($params['content_format'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content format should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/studentQuestionList','only request','studentQuestionList');
            $question = $this->student_model->getquestions($params);
            $student = [];
            $student['content_id'] = $question[0]['content_id'];
            $student['student_id'] = $question[0]['student_id'];
            $student['overallQuestions'] = $question[0]['overallQuestions'];
            $student['actual_points'] = $question[0]['actual_points'];
            $student['total_points'] = $question[0]['total_points'];
            $student['answer_id'] = $question;
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $student;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/studentQuestionList',$this->jsonarr,'studentQuestionList');
        return $this->printjson($this->jsonarr);
    }

    public function studentPaperList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['answer_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/studentPaperList','only request','studentPaperList');
            $list = $this->student_model->studentpaperList($params);
            $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $list;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/studentPaperList',$this->jsonarr,'studentPaperList');
        return $this->printjson($this->jsonarr);
    }

    public function graphAnswer_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif ($params['question_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Question Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/graphAnswer','only request','graphAnswer');
            if ($params['type'] == 1) {
                $getQuestion = $this->student_model->getQuestionId($params);
                $checkGraphExists = $this->student_model->checkGraphExists($params);
                if (count($checkGraphExists) == 0) {
                    $answer = [];
                    $answer['answer_id'] = $params['question_id'];
                    $answer['question_no'] = $getQuestion['question_no'];
                    $answer['content_id'] = $getQuestion['content_id'];
                    $answer['class_id'] = $params['class_id'];
                    $answer['student_id'] = $params['student_id'];
                    $answer['student_content_id'] = $params['student_content_id'];
                    $answer['student_answer'] = json_encode($params['answer']);
                    $answer['editor_answer'] = isset($params['editor_answer']) ? $params['editor_answer'] : '';
                    $answer['correct_answer'] = $getQuestion['answer'];
                    $answer['options'] = $getQuestion['options'];
                    $answer['actual_points'] = $getQuestion['points'];
                    $answer['answer_status'] = 4;
                    $answer['created_by'] = $params['student_id'];
                    $answer['created_date'] = date('Y-m-d H:i:s');
                    $this->common_model->insert('student_answers', $answer);
                } else {
                    $data = array('student_answer' => json_encode($params['answer']), 'editor_answer' => isset($params['editor_answer']) ? $params['editor_answer'] : '');
                    $condition = array('id' => $checkGraphExists[0]['id']);
                    $this->common_model->update('student_answers', $data, $condition);
                }
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Answer Updated";
            } else {
                $getStudentAnswer = $this->student_model->getStudentAnswer($params);
                if (count($getStudentAnswer) != 0) {
                    foreach ($getStudentAnswer as $key => $value) {
                        $getStudentAnswer[$key]['student_answer'] = $getStudentAnswer[$key]['student_answer'] != '' ? json_decode($getStudentAnswer[$key]['student_answer']) : [];
                        $getStudentAnswer[$key]['editor_answer'] = $getStudentAnswer[$key]['editor_answer'];
                        $getStudentAnswer[$key]['correct_answer'] = json_decode($getStudentAnswer[$key]['correct_answer']);
                    }
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = $getStudentAnswer;
                } else {
                    $question = $this->student_model->getQuestion($params);
                    $params['question'] = $question['question'];
                    $params['student_answer'] = [];
                    $params['editor_answer'] = "";
                    unset($params['platform']);
                    unset($params['type']);
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = array($params);
                }
            }
        }
        $this->common_model->createLog($params,'v1/student/graphAnswer',$this->jsonarr,'graphAnswer');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function viewScratchQuestions_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif ($params['question_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Question Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/viewScratchQuestions','only request','viewScratchQuestions');
            // $params['type']=1 then  insert, type2-> list
            if ($params['type'] == 1) {
                $getQuestion = $this->student_model->getQuestionId($params);
                $checkGraphExists = $this->student_model->checkGraphExists($params);
                if (count($checkGraphExists) == 0) {
                    $answer = [];
                    $answer['answer_id'] = $params['question_id'];
                    $answer['question_no'] = $getQuestion['question_no'];
                    $answer['content_id'] = $getQuestion['content_id'];
                    $answer['class_id'] = $params['class_id'];
                    $answer['student_id'] = $params['student_id'];
                    $answer['student_answer'] = json_encode($params['student_answer']);
                    $answer['editor_answer'] = isset($params['editor_answer']) ? $params['editor_answer'] : '';
                    $answer['correct_answer'] = $getQuestion['answer'];
                    $answer['options'] = $getQuestion['options'];
                    $answer['actual_points'] = $getQuestion['points'];
                    $answer['answer_status'] = 5;
                    $answer['created_by'] = $params['student_id'];
                    $answer['created_date'] = date('Y-m-d H:i:s');
                    $this->common_model->insert('student_answers', $answer);
                } else {
                    $data = array('student_answer' => json_encode($params['student_answer']), 'editor_answer' => isset($params['editor_answer']) ? $params['editor_answer'] : '');
                    $condition = array('id' => $checkGraphExists[0]['id']);
                    $this->common_model->update('student_answers', $data, $condition);
                }
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Answer Updated";
            } else {
                $getStudentAnswer = $this->student_model->getStudentAnswer($params);
                $question1 = $this->student_model->getQuestion($params);
                if (count($getStudentAnswer) != 0) {
                    foreach ($getStudentAnswer as $key => $value) {
                        $getStudentAnswer[$key]['student_answer'] = $value['student_answer'] != '' ? json_decode($value['student_answer']) : json_decode($value['options']);
                        $getStudentAnswer[$key]['editor_answer'] = $value['editor_answer'];
                        $getStudentAnswer[$key]['correct_answer'] = json_decode($value['correct_answer']);
                        $getStudentAnswer[$key]['options'] = json_decode($value['options']);
                        $getStudentAnswer[$key]['heading_option'] = isset($question1['heading_option']) && $question1['heading_option'] != " " ? json_decode($question1['heading_option']) : [];
                    }
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = $getStudentAnswer;
                } else {
                    $question = $this->student_model->getQuestion($params);
                    $params['question'] = $question['question'];
                    $params['correct_answer'] = json_decode($question['answer']);
                    $params['options'] = json_decode($question['options']);
                    $params['heading_option'] = isset($question1['heading_option']) && $question1['heading_option'] != " " ? json_decode($question1['heading_option']) : [];
                    $params['student_answer'] = count($params['options']) > 0 ? $params['options'] : array((object)array('isSelected' => ''));
                    $params['editor_answer'] = "";
                    unset($params['platform']);
                    unset($params['type']);
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = array($params);
                }
            }
        }
        $this->common_model->createLog($params,'v1/student/viewScratchQuestions',$this->jsonarr,'viewScratchQuestions');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function addStudentQuery_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Content Id should not be empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params,'v1/student/addStudentQuery','only request','addStudentQuery');
            $checkSuggestions = $this->student_model->checkSuggestions($params);
            if ($checkSuggestions > 0) {
                $data = array('suggestion_query' => $params['suggestion_query']);
                $condition = array('id' => $checkSuggestions['id']);
                $update = $this->common_model->update('student_suggestions', $data, $condition);
                if ($update) {
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = "Feedback Added";
                } else {
                    $this->jsonarr['IsSuccess'] = false;
                    $this->jsonarr['ErrorObject'] = "Feedback not Added";
                }
            } else {
                $data = array(
                    'student_id' => $params['student_id'],
                    'content_id' => $params['content_id'],
                    'class_id' => $params['class_id'],
                    'answer_id' => $params['answer_id'],
                    'suggestion_query' => $params['suggestion_query'],
            'school_id' => $params['school_id'],
                    'created_by' => $params['student_id'],
                    'created_date' => date('Y-m-d H:i:s')
                );
                $insertSuggestions = $this->common_model->insert('student_suggestions', $data);
                if ($insertSuggestions > 0) {
                    $this->jsonarr['IsSuccess'] = true;
                    $this->jsonarr['ResponseObject'] = "Feedback Added";
                } else {
                    $this->jsonarr['IsSuccess'] = false;
                    $this->jsonarr['ErrorObject'] = "Feedback not Added";
                }
            }
        }
        $this->common_model->createLog($params,'v1/student/addStudentQuery',$this->jsonarr,'addStudentQuery');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function studentClassList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Student Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/student/studentClassList','only request','studentClassList');
            $gradeStartDate = '';
            $gradeEndDate = '';
            if(isset($params['grade_id']) && $params['grade_id'] != '') {
                $getStudentGrade = $this->student_model->getStudentGrade($params);
                foreach ($getStudentGrade as $key => $value){
                    if($value['grade_id'] == $params['grade_id']) {
                        $gradeStartDate = $value['active_date'];
                    }
                    if($value['grade_id'] > $params['grade_id']){
                        $gradeEndDate = $value['active_date'];
                        break;
                    }
                }
            }
            $params['grade_start_date'] = $gradeStartDate;
            $params['grade_end_date'] = $gradeEndDate;
            $getstudentclasslist = $this->student_model->studentclasslist($params);
            foreach ($getstudentclasslist as $key => $value) {
                if($value['from_class'] == 0){
                    $getstudentclasslist[$key]['transferred_date'] = '';
                }
                $teacherId = explode(',', $value['teacher_id']);
                $teacherId = array_unique($teacherId);
                foreach ($teacherId as $key1 => $id) {
                    $getteacherName = $this->student_model->getTeacherName($id);
                    $teacherName[$key1] = $getteacherName['teacher_name'];
                }
                $getstudentclasslist[$key]['teacher_name'] = implode(',', $teacherName);
                unset($teacherName);
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $getstudentclasslist;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/studentClassList',$this->jsonarr,'studentClassList');
        return $this->printjson($this->jsonarr);
    }

    public function studentAllClassList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Student Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/student/studentAllClassList','only request','studentAllClassList');
            $gradeStartDate = '';
            $gradeEndDate = '';
            if(isset($params['grade_id']) && $params['grade_id'] != '') {
                $getStudentGrade = $this->student_model->getStudentGrade($params);
                foreach ($getStudentGrade as $key => $value){
                    if($value['grade_id'] == $params['grade_id']) {
                        $gradeStartDate = $value['active_date'];
                    }
                    if($value['grade_id'] > $params['grade_id']){
                        $gradeEndDate = $value['active_date'];
                        break;
                    }
                }
            }
            $params['grade_start_date'] = $gradeStartDate;
            $params['grade_end_date'] = $gradeEndDate;
            $params['type'] = "all";
            $getallstudentclasslist = $this->student_model->studentclasslist($params);
            foreach ($getallstudentclasslist as $key => $value) {
                if($value['from_class'] == 0){
                    $getallstudentclasslist[$key]['transferred_date'] = '';
                }
                $teacherId = explode(',', $value['teacher_id']);
                $teacherId = array_unique($teacherId);
                foreach ($teacherId as $key1 => $id) {
                    $getteacherName = $this->student_model->getTeacherName($id);
                    $teacherName[$key1] = $getteacherName['teacher_name'];
                }
                $getallstudentclasslist[$key]['teacher_name'] = implode(',', $teacherName);
                unset($teacherName);
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $getallstudentclasslist;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/studentAllClassList',$this->jsonarr,'studentAllClassList');
        return $this->printjson($this->jsonarr);
    }

    public function checkContentTime_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should not be Empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/student/checkContentTime','only request','checkContentTime');
            $message = '';
            $status = '';
            $checkTime = $this->student_model->checkContentTime($params);
            if ($checkTime['content_type'] == 3) {
                if ($checkTime['start_date'] != '0000-00-00' && $checkTime['end_date'] != '0000-00-00') {
                    if ($checkTime['start_date'] <= date('Y-m-d') && $checkTime['end_date'] >= date('Y-m-d')) {
                        if ($checkTime['start_time'] != '00:00:00' && $checkTime['end_time'] != '00:00:00') {
                            if ($checkTime['start_time'] <= date('H:i:s') && $checkTime['end_time'] >= date('H:i:s')) {
                                $status = 1;
                                $time = strtotime($checkTime['end_time']) - strtotime($checkTime['start_time']);
                                $time = $time / 60;
                                $message = $checkTime['name'] . " " . "started at " . " " . date('m-d-Y', strtotime($checkTime['start_date']));
                            } elseif ($checkTime['start_time'] > date('H:i:s')) {
                                $message = $checkTime['name'] . " " . "starts only by " . " " . date('m-d-Y', strtotime($checkTime['start_date'])) . " " . date('h:i A', strtotime($checkTime['start_time']));
                                $status = 0;
                            } elseif ($checkTime['end_time'] < date('H:i:s')) {
                                $message = $checkTime['name'] . " " . "ended at " . " " . date('m-d-Y', strtotime($checkTime['start_date'])) . " " . date('h:i A', strtotime($checkTime['end_time']));
                                $status = 0;
                            }
                        } elseif ($checkTime['start_time'] != '00:00:00') {
                            if ($checkTime['start_time'] <= date('H:i:s')) {
                                $status = 1;
                                $message = $checkTime['name'] . " " . "started at " . date('m-d-Y', strtotime($checkTime['start_date']));
                            } else {
                                $message = $checkTime['name'] . " " . "starts only by " . " " . date('m-d-Y', strtotime($checkTime['start_date'])) . " " . date('h:i A', strtotime($checkTime['start_time']));
                                $status = 0;
                            }
                        } elseif ($checkTime['start_time'] == '00:00:00' && $checkTime['end_time'] != '00:00:00') {
                            if ($checkTime['end_time'] <= date('H:i:s')) {
                                $message = $checkTime['name'] . " ended at " . " " . date('m-d-Y', strtotime($checkTime['end_date'])) . " " . date('h:i A', strtotime($checkTime['end_time']));
                                $status = 0;
                            } else {
                                $message = $checkTime['name'] . " Started at " . " " . date('m-d-Y', strtotime($checkTime['start_date'])) . " " . date('h:i A', strtotime($checkTime['start_time']));
                                $status = 1;
                            }
                        } else {
                            $message = $checkTime['name'] . " " . "Started at " . date('m-d-Y', strtotime($checkTime['start_date']));
                            $status = 1;
                        }
                    } else {
                        $message = $checkTime['name'] . " " . "ended at " . " " . date('m-d-Y', strtotime($checkTime['end_date'])) . " " . date('h:i A', strtotime($checkTime['end_time']));
                        $status = 0;
                    }
                } elseif ($checkTime['start_date'] != '0000-00-00' && $checkTime['end_date'] == '0000-00-00') {
                    if ($checkTime['start_date'] == date('Y-m-d')) {
                        if ($checkTime['start_time'] != '00:00:00' && $checkTime['end_time'] != '00:00:00') {
                            if ($checkTime['start_time'] <= date('H:i:s') && $checkTime['end_time'] >= date('H:i:s')) {
                                $status = 1;
                                $time = strtotime($checkTime['end_time']) - strtotime($checkTime['start_time']);
                                $time = $time / 60;
                                $message = $checkTime['name'] . " " . "started at " . " " . date('m-d-Y', strtotime($checkTime['start_date']));
                            } elseif ($checkTime['start_time'] > date('H:i:s')) {
                                $message = $checkTime['name'] . " " . "starts only by " . " " . date('m-d-Y', strtotime($checkTime['start_date'])) . " " . date('h:i A', strtotime($checkTime['start_time']));
                                $status = 0;
                            }
                        } elseif ($checkTime['start_time'] != '00:00:00' && $checkTime['end_time'] == '00:00:00') {
                            if ($checkTime['start_time'] <= date('H:i:s')) {
                                $status = 1;
                                $message = $checkTime['name'] . " " . "started at" . date('m-d-Y', strtotime($checkTime['start_date']));
                            } elseif ($checkTime['start_time'] > date('H:i:s')) {
                                $message = $checkTime['name'] . " " . "starts only by " . " " . date('m-d-Y', strtotime($checkTime['start_date'])) . " " . date('h:i A', strtotime($checkTime['start_time']));
                                $status = 0;
                            } else {
                                $message = $checkTime['name'] . " " . "Started at " . " " . date('m-d-Y', strtotime($checkTime['start_date']));
                                $status = 1;
                            }
                        } else {
                            $message = $checkTime['name'] . " " . "Started at " . " " . date('m-d-Y', strtotime($checkTime['start_date']));
                            $status = 1;
                        }
                    } elseif ($checkTime['start_date'] < date('Y-m-d')) {
                        //                        if ($checkTime['start_time'] != '00:00:00' && $checkTime['end_time'] != '00:00:00') {
                        //                            if ($checkTime['start_time'] <= date('H:i:s') && $checkTime['end_time'] >= date('H:i:s')) {
                        //                                $status = 1;
                        //                                $time = strtotime($checkTime['end_time']) - strtotime($checkTime['start_time']);
                        //                                $time = $time / 60;
                        //                                $message = $checkTime['name']." "."started at ".date('m-d-Y',strtotime($checkTime['start_date']));
                        //                            } elseif ($checkTime['start_time'] > date('H:i:s')) {
                        //                                $message = $checkTime['name']." "."starts only by "." ".date('m-d-Y',strtotime($checkTime['start_date']))." ".date('h:i A', strtotime($checkTime['start_time']));
                        //                                $status = 0;
                        //                            } elseif ($checkTime['end_time'] < date('H:i:s')) {
                        //                                $message = $checkTime['name']." "."ended at "." ".date('h:i A', strtotime($checkTime['end_time']));
                        //                                $status = 0;
                        //                            }
                        //                        } elseif ($checkTime['start_time'] != '00:00:00' && $checkTime['end_time'] == '00:00:00') {
                        //                            if ($checkTime['start_time'] <= date('H:i:s')) {
                        //                                $status = 1;
                        //                                $message = $checkTime['name']." "."started at".date('m-d-Y',strtotime($checkTime['start_date']));
                        //                            } elseif ($checkTime['start_time'] > date('H:i:s')) {
                        //                                $message = $checkTime['name']." "."starts only by "." ".date('m-d-Y',strtotime($checkTime['start_date']))." ".date('h:i A', strtotime($checkTime['start_time']));
                        //                                $status = 0;
                        //                            } else {
                        //                                $message = $checkTime['name']." "."Started at ".date('m-d-Y',strtotime($checkTime['start_date']));
                        //                                $status = 1;
                        //                            }
                        //                        } else {
                        $message = $checkTime['name'] . " " . "Started at " . date('m-d-Y', strtotime($checkTime['start_date']));
                        $status = 1;

                    } else {
                        $message = $checkTime['name'] . " " . "ended at " . " " . date('h:i A', strtotime($checkTime['end_time']));
                        $status = 0;
                    }
                } else {
                    $message = $checkTime['name'] . " " . "Started at " . " " . date('m-d-Y', strtotime($checkTime['start_date']));
                    $status = 1;
                }
            } elseif ($checkTime['content_type'] == 2) {
                if ($checkTime['start_date'] != '0000-00-00') {
                    if ($checkTime['start_date'] <= date('Y-m-d')) {
                        $status = 1;
                        $message = $checkTime['name'] . " " . "started at " . " " . date('m-d-Y', strtotime($checkTime['start_date']));
                    } else {
                        $message = $checkTime['name'] . " " . "starts only by " . " " . date('m-d-Y', strtotime($checkTime['start_date'])) . " " . date('h:i A', strtotime($checkTime['start_time']));
                        $status = 1;
                    }
                }
            }
            // $status = 1;
            if ($status) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = $message;
                $this->jsonarr['Time'] = isset($time) ? $time : 0;
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ResponseObject'] = $message;
            }
        }
        $this->common_model->createLog($params,'v1/student/checkContentTime',$this->jsonarr,'checkContentTime');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function studentClassShifts_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['to_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Shifted Class Should not be Empty";
        } elseif ($params['from_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Current Class Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/student/studentClassShifts','only request','studentClassShifts');
            if ($this->config->item('class_shift') == true) {
                $condition = [];
                $shiftedContents = [];
                $data = [];
                $answers = [];
                $data = array(
                    'status' => 3,
                    'drafted_date' => date('Y-m-d H:i:s'),
                    'modified_by' => $params['user_id'],
                    'modified_date' => date('Y-m-d H:i:s')
                );
                $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class']);
                $studentStatusUpdate = $this->common_model->update('student_class', $data, $condition);
                $studentCurrentContent = $this->student_model->classContent($params['from_class'], 'remove', $params);

                if (count($studentCurrentContent) > 0) {
                    foreach ($studentCurrentContent as $key => $value) {
                        $scoreReleasedContents = $this->student_model->checkContent($params, $value['content_id'], 'from_class');
                        print_r($scoreReleasedContents);
                        print_r("  ");
                        if ($scoreReleasedContents[0]['status'] != 3) {
                            $data = array(
                                'class_id' => $params['from_class'],
                                'student_id' => $params['student_id'],
                                'content_id' => $value['content_id'],
                                'draft_status' => 1,
                                'drafted_date' => date('Y-m-d H:i:s'),
                                'modified_by' => $params['user_id'],
                                'modified_date' => date('Y-m-d H:i:s')
                            );
                            $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class'], 'content_id' => $value['content_id']);
                            $this->common_model->update('student_content', $data, $condition);
                            $name = $this->student_model->name($value['content_id'], $params['student_id'], $params['from_class']);
                            $work = array(
                                'class_id' => $params['from_class'],
                                'class_name' => $name['class_name'],
                                'student_id' => $params['student_id'],
                                'student_name' => $name['student_name'],
                                'content_id' => $value['content_id'],
                                'content_name' => $name['content_name'],
                                'draft_status' => 1
                            );
                            $this->common_model->update('student_work', $work, $condition);
                        }
                    }
                }
                $checkStudentExists = $this->student_model->checkStudent($params);
                if (count($checkStudentExists) == 0) {
                    $studentClassInsert = array(
                        'class_id' => $params['to_class'],
                        'student_id' => $params['student_id'],
                        'validity' => $params['end_date'],
                        'status' => $params['status'],
                        'created_by' => $params['user_id'],
                        'created_date' => date('Y-m-d H:i:s'),
                        'joining_date' => $params['joining_date'],
                        'class_type' => 1
                    );
                    $this->common_model->insert('student_class', $studentClassInsert);
                } else {
                    if ($checkStudentExists[0]['status'] == 3 || $checkStudentExists[0]['status'] == 0) {
                        $data = array(
            'status' => 1,
                            'modified_by' => $params['user_id'],
                            'modified_date' => date('Y-m-d H:i:s')
                        );
                        $condition = array('class_id' => $checkStudentExists[0]['class_id'], 'student_id' => $params['student_id']);
                        $this->common_model->update('student_class', $data, $condition);
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Student already added";
                        return $this->printjson($this->jsonarr);
                        exit();
                    }
                }
                $shiftedClassContent = $this->student_model->classContent($params['to_class'], 'add', $params);
                if (count($shiftedClassContent) > 0) {
                    $fromClassContent = $this->student_model->classContent($params['from_class'], 'content', $params);
                    //$fromClassContent = array_unique(array_merge($fromClassContent,$getInprogressContent), SORT_REGULAR);
                    //$shiftedClassContent = $this->student_model->classContent($params['to_class'], 'add', $params);
                    if ((count($fromClassContent) > 0 && (count($shiftedClassContent) > 0)) || count($shiftedClassContent) > 0) {
                        for ($i = 0; $i < count($fromClassContent); $i++) {
                            for ($j = 0; $j < count($shiftedClassContent); $j++) {
                                if ($fromClassContent[$i]['content_id'] == $shiftedClassContent[$j]['content_id']) {
                                    print_r("as   ");
                                    print_r($shiftedClassContent[$j]['content_id']);
                                    $studentContentExists = $this->student_model->checkContent($params, $shiftedClassContent[$j]['content_id'], 'to_class');
                                    if (count($studentContentExists) > 0 && $studentContentExists[0]['status'] != 3) {
                                        print_r($shiftedClassContent[$j]['content_id']);
                                        print_r("   ");
                                        $shiftedContents[] = array("content_id" => $shiftedClassContent[$j]['content_id']);
                                        $data = array(
                                            'draft_status' => 1,
                                            'modified_by' => $params['user_id'],
                                            'modified_date' => date('Y-m-d H:i:s')
                                        );
                                        $condition = array('student_id' => $params['student_id'], 'content_id' => $studentContentExists[0]['content_id'], 'class_id' => $params['to_class']);
                                        $this->common_model->update('student_content', $data, $condition);
                                        $checkStudentAnswer = $this->student_model->getStudentAnswerList($fromClassContent[$i]['content_id'], $params['from_class'], $params['student_id']);
                                        $toClassAnswer = $this->student_model->getStudentAnswerList($shiftedClassContent[$j]['content_id'], $params['to_class'], $params['student_id']);
//                                    if (count($toClassAnswer) > 0) {
//                                        for ($x = 0; $x < count($toClassAnswer); $x++) {
//                                            $condition = array('student_id' => $params['student_id'], 'content_id' => $toClassAnswer[$x]['content_id'], 'class_id' => $params['to_class']);
//                                            $this->common_model->delete('student_answers', $condition);
//                                        }
//                                    }
                                        if (count($checkStudentAnswer) > 0) {
                                            $z = 0;
                                            for ($k = 0; $k < count($checkStudentAnswer); $k++) {
                                                $answers[$z]['answer_id'] = $checkStudentAnswer[$k]['answer_id'];
                                                $answers[$z]['question_no'] = $checkStudentAnswer[$k]['question_no'];
//                                            $answers[$z]['content_id'] = $checkStudentAnswer[$k]['content_id'];
//                                            $answers[$z]['class_id'] = $params['to_class'];
//                                            $answers[$z]['student_id'] = $params['student_id'];
                                                $answers[$z]['correct_answer'] = $checkStudentAnswer[$k]['correct_answer'];
                                                $answers[$z]['student_answer'] = $checkStudentAnswer[$k]['student_answer'];
                                                $answers[$z]['editor_answer'] = $checkStudentAnswer[$k]['editor_answer'];
                                                $answers[$z]['student_answer_image'] = $checkStudentAnswer[$k]['student_answer_image'];
                                                $answers[$z]['options'] = $checkStudentAnswer[$k]['options'];
                                                $answers[$z]['optionsCopy'] = $checkStudentAnswer[$k]['optionsCopy'];
                                                $answers[$z]['actual_points'] = $checkStudentAnswer[$k]['actual_points'];
                                                $answers[$z]['earned_points'] = $checkStudentAnswer[$k]['earned_points'];
                                                $answers[$z]['answer_status'] = $checkStudentAnswer[$k]['answer_status'];
                                                $answers[$z]['answer_attended'] = $checkStudentAnswer[$k]['answer_attended'];
                                                $answers[$z]['auto_grade'] = $checkStudentAnswer[$k]['auto_grade'];
                                                $answers[$z]['feedback'] = $checkStudentAnswer[$k]['feedback'];
                                                $answers[$z]['annotation'] = $checkStudentAnswer[$k]['annotation'];
                                                $answers[$z]['jiixdata'] = $checkStudentAnswer[$k]['jiixdata'];
                                                $answers[$z]['roughdata'] = $checkStudentAnswer[$k]['roughdata'];
                                                $answers[$z]['student_roughdata'] = $checkStudentAnswer[$k]['student_roughdata'];
                                                $answers[$z]['rough_image_url'] = $checkStudentAnswer[$k]['rough_image_url'];
                                                $answers[$z]['rough_image_thumb_url'] = $checkStudentAnswer[$k]['rough_image_thumb_url'];
                                                $answers[$z]['modified_by'] = $params['user_id'];
                                                $answers[$z]['modified_date'] = date('Y-m-d H:i:s');
                                                $z++;
                                            }
                                        }
                                        if (count($answers) > 0) {
                                            if (count($answers) > 100) {
                                                $chunk_result = array_chunk($answers, 100, true);
                                                foreach ($chunk_result as $chunk) {
                                                    $this->common_model->updateBatchMultiple('student_answers', $chunk, 'answer_id', $params['to_class'], $params['student_id'], $shiftedClassContent[$j]['content_id']);
                                                }
                                            } else {
                                                $this->common_model->updateBatchMultiple('student_answers', $answers, 'answer_id', $params['to_class'], $params['student_id'], $shiftedClassContent[$j]['content_id']);
                                            }
                                        }
//                                    if (count($answers) > 0) {
//                                        $this->common_model->bulkInsert('student_answers', $answers);
//                                    }
                                        $data = array(
                                            'class_id' => $params['to_class'],
                                            'modified_by' => $params['user_id'],
                                            'modified_date' => date('Y-m-d H:i:s')
                                        );
                                        $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class'], 'content_id' => $fromClassContent[$i]['content_id']);
                                        $this->common_model->update('student_content', $data, $condition);
                                        $studentName = $this->student_model->studentName($params['to_class']);
                                        $work = array(
                                            'class_id' => $params['to_class'],
                                            'class_name' => $studentName['class_name']
                                        );
                                        $this->common_model->update('student_work', $work, $condition);
                                        $this->jsonarr["IsSuccess"] = true;
                                        $this->jsonarr["ResponseObject"] = "Student Added Successfully";
                                    }
                                }
                            }
                        }
                        //student inprogress content move from class to shift class
                        $getInprogressContent = $this->student_model->classContent($params['from_class'], 'inprogress', $params);
                        if (count($getInprogressContent) > 0) {
                            $getInprogressContent = array_values(array_diff($getInprogressContent, $shiftedContents));
                            foreach ($getInprogressContent as $key => $value) {
                                if (count($studentContentExists) > 0) {
                                    $data = array(
                                        'draft_status' => 1,
                                        'modified_by' => $params['user_id'],
                                        'modified_date' => date('Y-m-d H:i:s')
                                    );
                                    $condition = array('student_id' => $params['student_id'], 'content_id' => $value['content_id'], 'class_id' => $params['to_class']);
                                    $this->common_model->update('student_content', $data, $condition);
                                }
                                $checkStudentAnswer = $this->student_model->getStudentAnswerList($value['content_id'], $params['from_class'], $params['student_id']);
                                if (count($checkStudentAnswer) > 0) {
                                    $z = 0;
                                    for ($k = 0; $k < count($checkStudentAnswer); $k++) {
                                        $answers[$z]['answer_id'] = $checkStudentAnswer[$k]['answer_id'];
                                        $answers[$z]['question_no'] = $checkStudentAnswer[$k]['question_no'];
//                                            $answers[$z]['content_id'] = $checkStudentAnswer[$k]['content_id'];
//                                            $answers[$z]['class_id'] = $params['to_class'];
//                                            $answers[$z]['student_id'] = $params['student_id'];
                                        $answers[$z]['correct_answer'] = $checkStudentAnswer[$k]['correct_answer'];
                                        $answers[$z]['student_answer'] = $checkStudentAnswer[$k]['student_answer'];
                                        $answers[$z]['editor_answer'] = $checkStudentAnswer[$k]['editor_answer'];
                                        $answers[$z]['student_answer_image'] = $checkStudentAnswer[$k]['student_answer_image'];
                                        $answers[$z]['options'] = $checkStudentAnswer[$k]['options'];
                                        $answers[$z]['optionsCopy'] = $checkStudentAnswer[$k]['optionsCopy'];
                                        $answers[$z]['actual_points'] = $checkStudentAnswer[$k]['actual_points'];
                                        $answers[$z]['earned_points'] = $checkStudentAnswer[$k]['earned_points'];
                                        $answers[$z]['answer_status'] = $checkStudentAnswer[$k]['answer_status'];
                                        $answers[$z]['answer_attended'] = $checkStudentAnswer[$k]['answer_attended'];
                                        $answers[$z]['auto_grade'] = $checkStudentAnswer[$k]['auto_grade'];
                                        $answers[$z]['feedback'] = $checkStudentAnswer[$k]['feedback'];
                                        $answers[$z]['annotation'] = $checkStudentAnswer[$k]['annotation'];
                                        $answers[$z]['jiixdata'] = $checkStudentAnswer[$k]['jiixdata'];
                                        $answers[$z]['roughdata'] = $checkStudentAnswer[$k]['roughdata'];
                                        $answers[$z]['student_roughdata'] = $checkStudentAnswer[$k]['student_roughdata'];
                                        $answers[$z]['rough_image_url'] = $checkStudentAnswer[$k]['rough_image_url'];
                                        $answers[$z]['rough_image_thumb_url'] = $checkStudentAnswer[$k]['rough_image_thumb_url'];
                                        $answers[$z]['modified_by'] = $params['user_id'];
                                        $answers[$z]['modified_date'] = date('Y-m-d H:i:s');
                                        $z++;
                                    }
                                }
                                if (count($answers) > 0) {
                                    if (count($answers) > 100) {
                                        $chunk_result = array_chunk($answers, 100, true);
                                        foreach ($chunk_result as $chunk) {
                                            $this->common_model->updateBatchMultiple('student_answers', $chunk, 'answer_id', $params['to_class'], $params['student_id'], $shiftedClassContent[$j]['content_id']);
                                        }
                                    } else {
                                        $this->common_model->updateBatchMultiple('student_answers', $answers, 'answer_id', $params['to_class'], $params['student_id'], $shiftedClassContent[$j]['content_id']);
                                    }
                                }
//                                    if (count($answers) > 0) {
//                                        $this->common_model->bulkInsert('student_answers', $answers);
//                                    }
                                $data = array(
                                    'class_id' => $params['to_class'],
                                    'modified_by' => $params['user_id'],
                                    'modified_date' => date('Y-m-d H:i:s')
                                );
                                $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class'], 'content_id' => $fromClassContent[$i]['content_id']);
                                $this->common_model->update('student_content', $data, $condition);
                                $studentName = $this->student_model->studentName($params['to_class']);
                                $work = array(
                                    'class_id' => $params['to_class'],
                                    'class_name' => $studentName['class_name']
                                );
                                $this->common_model->update('student_work', $work, $condition);
                            }
                        }
                        foreach ($shiftedClassContent as $key => $value) {
                            $studentContentExists = $this->student_model->checkContent($params, $value['content_id'],'to_class');
                            if (count($studentContentExists) == 0) {
                                $studentContent = array(
                                    'class_id' => $params['to_class'],
                                    'student_id' => $params['student_id'],
                                    'content_id' => $value['content_id'],
                                    'status' => 1,
                                    'created_by' => $params['user_id'],
            'created_date' => date('Y-m-d H:i:s')
                                );
                                $this->common_model->insert('student_content', $studentContent);
                                $type = $this->student_model->getContentType($value['content_id']);
                                $name = $this->student_model->name($value['content_id'],$params['student_id'],$params['to_class']);
                                $studentWork = array(
                                    'class_id' => $params['to_class'],
                                    'class_name ' => $name['class_name'],
                                    'student_id' => $params['student_id'],
                                    'student_name' => $name['student_name'],
                                    'content_id' => $value['content_id'],
                                    'content_name' => $name['content_name'],
                                    'content_type' => $type['content_type'],
                                    'content_format' => $type['content_format'],
                                    'status' => 1,
                                    'created_by' => $params['user_id'],
                                    'created_date' => date('Y-m-d H:i:s')
                                );
                                $this->common_model->insert('student_work', $studentWork);
                            } elseif ($studentContentExists[0]['draft_status'] == 1) {
                                $studentContent = array(
                                    'draft_status' => 0,
                                    'modified_by' => $params['user_id'],
                                    'modified_date' => date('Y-m-d H:i:s')
                                );
                                $condition = array('class_id' => $params['to_class'],'student_id' => $params['student_id'],'content_id' => $value['content_id']);
                                $this->common_model->update('student_content',$studentContent,$condition);
                            }
                        }
                    }
                }

                $this->jsonarr["IsSuccess"] = true;
                $this->jsonarr["ResponseObject"] = "Student Added Successfully";
            }
        }
        $this->common_model->createLog($params,'v1/student/studentClassShifts',$this->jsonarr,'studentClassShifts');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function studentClassShiftNew_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['to_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Shifted Class Should not be Empty";
        } elseif ($params['from_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Current Class Should not be Empty";
        } else {
            $this->common_model->createLog($params, 'v1/student/studentClassShift', 'only request', 'studentClassShift');
            if ($this->config->item('class_shift') == true) {
                //checking whether class is already added or not
                $checkStudentExists = $this->student_model->checkStudent($params);
                if (count($checkStudentExists) == 0) {
                    $studentClassInsert = array(
                        'class_id' => $params['to_class'],
                        'from_class' => $params['from_class'],
                        'student_id' => $params['student_id'],
                        'validity' => $params['end_date'],
                        'status' => $params['status'],
                        'created_by' => $params['user_id'],
                        'created_date' => date('Y-m-d H:i:s'),
                        'joining_date' => $params['joining_date'],
                        'class_type' => 1

                    );
                    $this->common_model->insert('student_class', $studentClassInsert);
                } else {
                    if ($checkStudentExists[0]['status'] == 3 || $checkStudentExists[0]['status'] == 0) {
                        $data = array('status' => 1,
                            'modified_by' => $params['user_id'],
                            'modified_date' => date('Y-m-d H:i:s'));
                        $condition = array('class_id' => $checkStudentExists[0]['class_id'], 'student_id' => $params['student_id']);
                        $this->common_model->update('student_class', $data, $condition);
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Student already added";
                        return $this->printjson($this->jsonarr);
                        exit();
                    }
                }

                //fromclass content checking
                $shiftedContents = [];
                $data = array(
                    'status' => 3,
                    'drafted_date' => date('Y-m-d H:i:s'),
                    'modified_by' => $params['user_id'],
                    'modified_date' => date('Y-m-d H:i:s')
                );
                $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class']);
                $this->common_model->update('student_class', $data, $condition);
                $fromClassContent = $this->student_model->getFromClassContent($params);
                // from class inprogress content
                foreach ($fromClassContent as $key => $value) {
                    // if from class content already exists then to update the to_class_id to from_class_id
                    $checkContentExists = $this->student_model->checkContentExists($params, $value['content_id']);
                    if ($checkContentExists) {
                        $studentContentExists = $this->student_model->checkContent($params, $value['content_id'], 'to_class');
                        $data = array(
                            'class_id' => $params['from_class'],
                            'student_id' => $params['student_id'],
                            'content_id' => $value['content_id'],
                            'draft_status' => 1,
                            'drafted_date' => date('Y-m-d H:i:s'),
                            'modified_by' => $params['user_id'],
                            'modified_date' => date('Y-m-d H:i:s')
                        );
                        $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class'], 'content_id' => $value['content_id']);
                        $this->common_model->update('student_content', $data, $condition);
                        //to get student_name,class_name,content_name then to update the student_work table
                        $name = $this->student_model->name($value['content_id'], $params['student_id'], $params['from_class']);
                        $work = array(
                            'class_id' => $params['from_class'],
                            'class_name' => $name['class_name'],
                            'student_id' => $params['student_id'],
                            'student_name' => $name['student_name'],
                            'content_id' => $value['content_id'],
                            'content_name' => $name['content_name'],
                        );
                        $this->common_model->update('student_work', $work, $condition);
                        if ($studentContentExists) {
                            $toClass = array(
                                'status' => $value['status'],
                            );
                            $condition1 = array('class_id' => $params['to_class'], 'content_id' => $value['content_id'], 'student_id' => $params['student_id']);
                            $this->common_model->update('student_content', $toClass, $condition1);
                            $this->common_model->update('student_work', $toClass, $condition1);
                            // check both from and to class answer exists or not
                            // if both class have the answers then to update from_class answers to to_class_id
                            // if only from_class have the answers then to insert the from_class answers to to_class_id
                            $checkStudentAnswer = $this->student_model->getStudentAnswerList($value['content_id'], $params['from_class'], $params['student_id']);
                            $toClassAnswer = $this->student_model->getStudentAnswerList($value['content_id'], $params['to_class'], $params['student_id']);
                            if ($checkStudentAnswer && $toClassAnswer) {
                                $answers = [];
                                $z = 0;
                                for ($k = 0; $k < count($checkStudentAnswer); $k++) {
                                    $answers[$z]['answer_id'] = $checkStudentAnswer[$k]['answer_id'];
                                    $answers[$z]['question_no'] = $checkStudentAnswer[$k]['question_no'];
                                    $answers[$z]['correct_answer'] = $checkStudentAnswer[$k]['correct_answer'];
                                    $answers[$z]['student_answer'] = $checkStudentAnswer[$k]['student_answer'];
                                    $answers[$z]['editor_answer'] = $checkStudentAnswer[$k]['editor_answer'];
                                    $answers[$z]['student_answer_image'] = $checkStudentAnswer[$k]['student_answer_image'];
                                    $answers[$z]['options'] = $checkStudentAnswer[$k]['options'];
                                    $answers[$z]['optionsCopy'] = $checkStudentAnswer[$k]['optionsCopy'];
                                    $answers[$z]['actual_points'] = $checkStudentAnswer[$k]['actual_points'];
                                    $answers[$z]['earned_points'] = $checkStudentAnswer[$k]['earned_points'];
                                    $answers[$z]['answer_status'] = $checkStudentAnswer[$k]['answer_status'];
                                    $answers[$z]['answer_attended'] = $checkStudentAnswer[$k]['answer_attended'];
                                    $answers[$z]['auto_grade'] = $checkStudentAnswer[$k]['auto_grade'];
                                    $answers[$z]['feedback'] = $checkStudentAnswer[$k]['feedback'];
                                    $answers[$z]['annotation'] = $checkStudentAnswer[$k]['annotation'];
                                    $answers[$z]['jiixdata'] = $checkStudentAnswer[$k]['jiixdata'];
                                    $answers[$z]['roughdata'] = $checkStudentAnswer[$k]['roughdata'];
                                    $answers[$z]['student_roughdata'] = $checkStudentAnswer[$k]['student_roughdata'];
                                    $answers[$z]['rough_image_url'] = $checkStudentAnswer[$k]['rough_image_url'];
                                    $answers[$z]['rough_image_thumb_url'] = $checkStudentAnswer[$k]['rough_image_thumb_url'];
                                    $answers[$z]['modified_by'] = $params['user_id'];
                                    $answers[$z]['modified_date'] = date('Y-m-d H:i:s');
                                    $z++;
                                }
                                if (count($answers) > 0) {
                                    if (count($answers) > 100) {
                                        $chunk_result = array_chunk($answers, 100, true);
                                        foreach ($chunk_result as $chunk) {
                                            $this->common_model->updateBatchMultiple('student_answers', $chunk, 'answer_id', $params['to_class'], $params['student_id'], $value['content_id']);
                                        }
                                    } else {
                                        $this->common_model->updateBatchMultiple('student_answers', $answers, 'answer_id', $params['to_class'], $params['student_id'], $value['content_id']);
                                    }
                                }
                            } else if ($checkStudentAnswer && !$toClassAnswer) {
                                $z = 0;
                                $answers = [];
                                for ($k = 0; $k < count($checkStudentAnswer); $k++) {
                                    $answers[$z]['answer_id'] = $checkStudentAnswer[$k]['answer_id'];
                                    $answers[$z]['question_no'] = $checkStudentAnswer[$k]['question_no'];
                                    $answers[$z]['content_id'] = $checkStudentAnswer[$k]['content_id'];
                                    $answers[$z]['class_id'] = $params['to_class'];
                                    $answers[$z]['student_id'] = $params['student_id'];
                                    $answers[$z]['correct_answer'] = $checkStudentAnswer[$k]['correct_answer'];
                                    $answers[$z]['student_answer'] = $checkStudentAnswer[$k]['student_answer'];
                                    $answers[$z]['editor_answer'] = $checkStudentAnswer[$k]['editor_answer'];
                                    $answers[$z]['student_answer_image'] = $checkStudentAnswer[$k]['student_answer_image'];
                                    $answers[$z]['options'] = $checkStudentAnswer[$k]['options'];
                                    $answers[$z]['optionsCopy'] = $checkStudentAnswer[$k]['optionsCopy'];
                                    $answers[$z]['actual_points'] = $checkStudentAnswer[$k]['actual_points'];
                                    $answers[$z]['earned_points'] = $checkStudentAnswer[$k]['earned_points'];
                                    $answers[$z]['answer_status'] = $checkStudentAnswer[$k]['answer_status'];
                                    $answers[$z]['answer_attended'] = $checkStudentAnswer[$k]['answer_attended'];
                                    $answers[$z]['auto_grade'] = $checkStudentAnswer[$k]['auto_grade'];
                                    $answers[$z]['feedback'] = $checkStudentAnswer[$k]['feedback'];
                                    $answers[$z]['annotation'] = $checkStudentAnswer[$k]['annotation'];
                                    $answers[$z]['jiixdata'] = $checkStudentAnswer[$k]['jiixdata'];
                                    $answers[$z]['roughdata'] = $checkStudentAnswer[$k]['roughdata'];
                                    $answers[$z]['student_roughdata'] = $checkStudentAnswer[$k]['student_roughdata'];
                                    $answers[$z]['rough_image_url'] = $checkStudentAnswer[$k]['rough_image_url'];
                                    $answers[$z]['rough_image_thumb_url'] = $checkStudentAnswer[$k]['rough_image_thumb_url'];
                                    $answers[$z]['modified_by'] = $params['user_id'];
                                    $answers[$z]['modified_date'] = date('Y-m-d H:i:s');
                                    $z++;
                                }
                                if (count($answers) > 0) {
                                    $this->common_model->bulkInsert('student_answers', $answers);
                                }
                            }
                        } else {
                            $studentContent = array(
                                'class_id' => $params['to_class'],
                                'student_id' => $params['student_id'],
                                'content_id' => $value['content_id'],
                                'status' => $value['status'],
                                'draft_status' => 0,
                                'annotation' => $value['annotation'],
                                'teacher_annotation' => $value['annotation'],
                                'answer_sheet_annotation' => $value['answer_sheet_annotation'],
                                'feedback' => $value['feedback'],
                                'student_feedback' => $value['student_feedback'],
                                'upload_answer' => $value['upload_answer'],
                                'points' => $value['points'],
                                'earned_points' => $value['earned_points'],
                                'answer_completed_date' => $value['answer_completed_date'],
                                'created_by' => $params['user_id'],
            'created_date' => date('Y-m-d H:i:s')
                            );
                            $annotation = $this->common_model->insert('student_content', $studentContent);
                            $folder = "../uploads/studentAnnotation/";
                            $fileName = "student-annotation".$annotation.$params['class_id'].$params['content_id'].'.json';
                            $createAnnotationFile = $this->common_model->createFlatFile($folder,$fileName,$value['annotation']);
                            $path = "uploads/studentAnnotation/".$fileName;

                            $teacherFolder = "../uploads/studentTeacherAnnotation/";
                            $teacherName = "teacher-annotation".$annotation.$params['class_id'].$params['content_id'].'.json';
                            $createAnnotationFile = $this->common_model->createFlatFile($teacherFolder,$teacherName,$value['annotation']);
                            $teacherPath = "uploads/studentTeacherAnnotation/".$teacherName;

                            $answerFolder = "../uploads/answerAnnotation/";
                            $answerName = "answer-annotation".$annotation.$params['class_id'].$params['content_id'].'.json';
                            $createAnnotationFile = $this->common_model->createFlatFile($answerFolder,$answerName,$value['answer_sheet_annotation']);
                            $answerPath = "uploads/answerAnnotation/".$answerName;

                            $data = array('annotation' => $path, 'teacher_annotation' => $teacherPath, 'answer_sheet_annotation' => $answerPath);
                            $updateCondition = array(
                                'content_id' => $params['content_id'],
                                'student_id' => $params['student_id'],
                                'class_id' => $params['class_id']
                            );
                            $this->common_model->update('student_content', $data, $updateCondition);

                            $type = $this->student_model->getContentType($value['content_id']);
                            $name = $this->student_model->name($value['content_id'], $params['student_id'], $params['to_class']);
                            $studentWork = array(
                                'class_id' => $params['to_class'],
                                'class_name ' => $name['class_name'],
                                'student_id' => $params['student_id'],
                                'student_name' => $name['student_name'],
                                'content_id' => $value['content_id'],
                                'content_name' => $name['content_name'],
                                'content_type' => $type['content_type'],
                                'content_format' => $type['content_format'],
                                'status' => $value['status'],
                                'created_by' => $params['user_id'],
                                'created_date' => date('Y-m-d H:i:s')
                            );
                            $this->common_model->insert('student_work', $studentWork);
//                    else {
//                        $studentContent = array(
//                            'class_id' => $params['to_class'],
//                            'student_id' => $params['student_id'],
//                            'content_id' => $value['content_id'],
//                            'status' => $value['status'],
//                            'draft_status' => 0,
//                            'created_by' => $params['user_id'],
//                            'created_date' => date('Y-m-d H:i:s')
//                        );
//                        $this->common_model->insert('student_content', $studentContent);
//                        $type = $this->student_model->getContentType($value['content_id']);
//                        $name = $this->student_model->name($value['content_id'],$params['student_id'],$params['to_class']);
//                        $studentWork = array(
//                            'class_id' => $params['to_class'],
//                            'class_name ' => $name['class_name'],
//                            'student_id' => $params['student_id'],
//                            'student_name' => $name['student_name'],
//                            'content_id' => $value['content_id'],
//                            'content_name' => $name['content_name'],
//                            'content_type' => $type['content_type'],
//                            'content_format' => $type['content_format'],
//                            'status' => $value['status'],
//                            'created_by' => $params['user_id'],
//                            'created_date' => date('Y-m-d H:i:s')
//                        );
//                        $this->common_model->insert('student_work', $studentWork);
//
                            $checkStudentAnswer = $this->student_model->getStudentAnswerList($value['content_id'], $params['from_class'], $params['student_id']);
                            if ($checkStudentAnswer) {
                                $z = 0;
                                $answers = [];
                                for ($k = 0; $k < count($checkStudentAnswer); $k++) {
                                    $answers[$z]['answer_id'] = $checkStudentAnswer[$k]['answer_id'];
                                    $answers[$z]['question_no'] = $checkStudentAnswer[$k]['question_no'];
                                    $answers[$z]['content_id'] = $checkStudentAnswer[$k]['content_id'];
                                    $answers[$z]['class_id'] = $params['to_class'];
                                    $answers[$z]['student_id'] = $params['student_id'];
                                    $answers[$z]['correct_answer'] = $checkStudentAnswer[$k]['correct_answer'];
                                    $answers[$z]['student_answer'] = $checkStudentAnswer[$k]['student_answer'];
                                    $answers[$z]['editor_answer'] = $checkStudentAnswer[$k]['editor_answer'];
                                    $answers[$z]['student_answer_image'] = $checkStudentAnswer[$k]['student_answer_image'];
                                    $answers[$z]['options'] = $checkStudentAnswer[$k]['options'];
                                    $answers[$z]['optionsCopy'] = $checkStudentAnswer[$k]['optionsCopy'];
                                    $answers[$z]['actual_points'] = $checkStudentAnswer[$k]['actual_points'];
                                    $answers[$z]['earned_points'] = $checkStudentAnswer[$k]['earned_points'];
                                    $answers[$z]['answer_status'] = $checkStudentAnswer[$k]['answer_status'];
                                    $answers[$z]['answer_attended'] = $checkStudentAnswer[$k]['answer_attended'];
                                    $answers[$z]['auto_grade'] = $checkStudentAnswer[$k]['auto_grade'];
                                    $answers[$z]['feedback'] = $checkStudentAnswer[$k]['feedback'];
                                    $answers[$z]['annotation'] = $checkStudentAnswer[$k]['annotation'];
                                    $answers[$z]['jiixdata'] = $checkStudentAnswer[$k]['jiixdata'];
                                    $answers[$z]['roughdata'] = $checkStudentAnswer[$k]['roughdata'];
                                    $answers[$z]['student_roughdata'] = $checkStudentAnswer[$k]['student_roughdata'];
                                    $answers[$z]['rough_image_url'] = $checkStudentAnswer[$k]['rough_image_url'];
                                    $answers[$z]['rough_image_thumb_url'] = $checkStudentAnswer[$k]['rough_image_thumb_url'];
                                    $answers[$z]['modified_by'] = $params['user_id'];
                                    $answers[$z]['modified_date'] = date('Y-m-d H:i:s');
                                    $z++;
                                }
                                if (count($answers) > 0) {
                                    $this->common_model->bulkInsert('student_answers', $answers);
                                }
                                //student content feedback
                                $checkFeedback = $this->student_model->checkContentFeedback($params, $value['content_id']);
                                $feedbackArray = array();
                                foreach ($checkFeedback as $feedback) {
                                    $feedbackArray[] = array(
                                        'content_id' => $feedback['content_id'],
                                        'class_id' => $params['to_class'],
                                        'student_id' => $feedback['student_id'],
                                        'notes' => $feedback['notes'],
                                        'created_by' => $params['user_id'],
                                        'created_date' => date('Y-m-d H:i:s')
                                    );
                                }
                                if (count($feedbackArray) > 0) {
                                    $this->common_model->bulkInsert('student_content_feedback', $feedbackArray);
                                }
                                //student questions feedback
                                $checkQuestionFeedback = $this->student_model->checkQuestionFeedback($params, $value['content_id']);
                                $feedbackQuestionArray = array();
                                foreach ($checkQuestionFeedback as $feedback) {
                                    $feedbackQuestionArray[] = array(
                                        'content_id' => $feedback['content_id'],
                                        'class_id' => $params['to_class'],
                                        'student_id' => $feedback['student_id'],
                                        'answer_id' => $feedback['answer_id'],
                                        'school_id' => $feedback['school_id'],
                                        'suggestion_query' => $feedback['suggestion_query'],
                                        'created_by' => $params['user_id'],
                                        'created_date' => date('Y-m-d H:i:s')
                                    );
                                }
                                if (count($feedbackQuestionArray) > 0) {
                                    $this->common_model->bulkInsert('student_suggestions', $feedbackQuestionArray);
                                }
                            }
                        }
                    }
                }
//                    }*/
//                }

                //shiftclass contents tagging
                // check to_class content exists or not
                // if exists then to get different content_id and insert the data.
                $getShiftClassContent = $this->student_model->getToClassContent($params);
                $ids1 = array();
                foreach ($fromClassContent as $elem1)
                    $ids1[] = $elem1['content_id'];

                $ids2 = array();
                foreach ($getShiftClassContent as $elem2)
                    $ids2[] = $elem2['content_id'];
                /*foreach ($ids2 as $key)
                $search = array_search($key,$ids1,true);
                if(!$search){
                    $ids3[] = $key;
                }*/
                $newContent = array_diff($ids2, $ids1);
                //    $newContent = array_merge($newContent,$ids3);
                // $newContent = array_unique($fromClassContent,$getShiftClassContent);
                if ($newContent) {
                    foreach ($newContent as $key => $value) {
                        $checkToClassContentExists = $this->student_model->checkStudentContentExists($params, $value);
                        if (count($checkToClassContentExists) == 0) {
                            $studentContentExists = $this->student_model->checkContent($params, $value, 'to_class');
                            if (count($studentContentExists) == 0) {
                                $studentContent = array(
                                    'class_id' => $params['to_class'],
                                    'student_id' => $params['student_id'],
                                    'content_id' => $value,
                                    'status' => 1,
                                    'draft_status' => 0,
                                    'created_by' => $params['user_id'],
                                    'created_date' => date('Y-m-d H:i:s')
                                );
                                $this->common_model->insert('student_content', $studentContent);
                                $getDetailName = $this->student_model->name($value, $params['student_id'], $params['to_class']);
                                $insertStudentContent = array(
                                    'class_id' => $params['to_class'],
                                    'class_name' => $getDetailName['class_name'],
                                    'student_id' => $params['student_id'],
                                    'student_name' => $getDetailName['student_name'],
                                    'content_id' => $value,
                                    'content_name' => $getDetailName['content_name'],
                                    'student_content_status' => 1,
                                    'created_by' => $params['user_id'],
                                    'created_date' => date('Y-m-d H:i:s')
                                );
                                $this->common_model->insert('student_work', $insertStudentContent);
                                /*$checkFromClassContent =  $this->student_model->checkContent($params, $value, 'from_class');
                                if(count($checkFromClassContent) > 0){
                                    $condition2 = array('class_id' => $params['from_class'], 'content_id' => $value, 'student_id' => $params['student_id']);
                                    $data = array(
                                        'draft_status' => 1
                                    );
                                    $this->common_model->update('student_content', $data, $condition2);
                                }*/
                            } else {
                                $toClass = array(
                                    'draft_status' => 0,
                                    'status' => 1
                                );

                                $condition = array('class_id' => $params['to_class'], 'content_id' => $value, 'student_id' => $params['student_id']);
                                $this->common_model->update('student_content', $toClass, $condition);
                            }
                        }
                    }
                }
            }
        }
        $this->jsonarr["IsSuccess"] = true;
        $this->jsonarr["ResponseObject"] = "Student Added Successfully";
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params,'v1/student/studentClassShift',$this->jsonarr,'studentClassShift');
        $this->printjson($this->jsonarr);
    }

    public function studentClassShift_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['to_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Shifted Class Should not be Empty";
        } elseif ($params['from_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Current Class Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/student/studentClassShiftNew','only request','studentClassShiftNew');
            if ($this->config->item('class_shift') == true) {
                if($params['joining_date'] > date('Y-m-d')){
                     $futureClass = array(
                         'class_id' => $params['to_class'],
                         'from_class' => $params['from_class'],
                         'to_class' => $params['to_class'],
                         'student_id' => $params['student_id'],
                         'validity' => $params['end_date'],
                         'status' => 0,
                         'type' => 'T',
                         'created_by' => $params['user_id'],
                         'created_date' => date('Y-m-d H:i:s'),
                         'joining_date' => $params['joining_date']
                     );
                    $this->common_model->insert('student_class_transfer', $futureClass);
                    $this->jsonarr["IsSuccess"] = true;
                    $this->jsonarr["ResponseObject"] = "Student Transferred Successfully";
                    return $this->printjson($this->jsonarr);
                    exit();
                }
                //checking whether class is already added or not
                $checkStudentExists = $this->student_model->checkStudent($params);
                if (count($checkStudentExists) == 0) {
                    $studentClassInsert = array(
                        'class_id' => $params['to_class'],
                        'from_class' => $params['from_class'],
                        'student_id' => $params['student_id'],
                        'validity' => $params['end_date'],
                        'status' => $params['status'],
                        'created_by' => $params['user_id'],
                        'created_date' => date('Y-m-d H:i:s'),
                        'joining_date' => $params['joining_date'],
                        'class_type' => 1
                    );
                    $this->common_model->insert('student_class', $studentClassInsert);

                    $studentClassTransfer = array(
                        'class_id' => $params['to_class'],
                        'from_class' => $params['from_class'],
                        'to_class' => $params['to_class'],
                        'student_id' => $params['student_id'],
                        'validity' => $params['end_date'],
                        'status' => 1,
                        'type' => 'T',
                        'created_by' => $params['user_id'],
                        'created_date' => date('Y-m-d H:i:s'),
                        'joining_date' => $params['joining_date']
                    );
                    $this->common_model->insert('student_class_transfer', $studentClassTransfer);
                } else {
                    if ($checkStudentExists[0]['status'] == 3 || $checkStudentExists[0]['status'] == 0) {
                        $data = array(
                            'status' => 1,
                            'from_class' => $params['from_class'],
                            'joining_date' => $params['joining_date'],
                            'modified_by' => $params['user_id'],
                            'modified_date' => date('Y-m-d H:i:s')
                        );
                        $condition = array('class_id' => $checkStudentExists[0]['class_id'], 'student_id' => $params['student_id']);
                        $this->common_model->update('student_class', $data, $condition);
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Student already added";
                        return $this->printjson($this->jsonarr);
                        exit();
                    }
                }

                //fromclass content checking
                $shiftedContents = [];
                $data = array(
                    'status' => 3,
                    'drafted_date' => date('Y-m-d H:i:s'),
                    'modified_by' => $params['user_id'],
                    'modified_date' => date('Y-m-d H:i:s')
                );
                $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class']);
                $this->common_model->update('student_class', $data, $condition);
                $sameContent = [];
                $fromClassContent = $this->student_model->getFromClassContent1($params);
                $getShiftClassContent = $this->student_model->getToClassContent($params);
                // fromclass content move to draft status
                foreach ($fromClassContent as $key => $value) {
                    // if from class content already exists then to update the to_class_id to from_class_id
                    $checkContentExists = $this->student_model->checkContentExists($params, $value['content_id']);
                    if ($checkContentExists) {
                        $studentContentExists = $this->student_model->checkContent($params, $value['content_id'], 'to_class');
                        $data = array(
                            'class_id' => $params['from_class'],
                            'student_id' => $params['student_id'],
                            'content_id' => $value['content_id'],
                            'draft_status' => 1,
                            'drafted_date' => date('Y-m-d H:i:s'),
                            'modified_by' => $params['user_id'],
                            'modified_date' => date('Y-m-d H:i:s')
                        );
                        $condition = array('student_id' => $params['student_id'], 'class_id' => $params['from_class'], 'content_id' => $value['content_id']);
                        $this->common_model->update('student_content', $data, $condition);
                        //to get student_name,class_name,content_name then to update the student_work table
                        $name = $this->student_model->name($value['content_id'], $params['student_id'], $params['from_class']);
                        $work = array(
                            'class_id' => $params['from_class'],
                            'class_name' => $name['class_name'],
                            'student_id' => $params['student_id'],
                            'student_name' => $name['student_name'],
                            'content_id' => $value['content_id'],
                            'content_name' => $name['content_name'],
                            'draft_status' => 1
                        );
                        $this->common_model->update('student_work', $work, $condition);
                        $deleteCondition = array(
                            'class_id' => $params['from_class'],
                            'student_id' => $params['student_id'],
                            'content_id' => $value['content_id']
                        );
                        $this->common_model->delete('student_work', $deleteCondition);
                    }
                }
                $from = [];
                $to = [];
                for ($a = 0; $a < count($fromClassContent); $a++) {
                    array_push($from, $fromClassContent[$a]['content_id']);
                }
                for ($b = 0; $b < count($getShiftClassContent); $b++) {
                    array_push($to, $getShiftClassContent[$b]['content_id']);
                }
                $sameContent = array_values(array_intersect($from, $to));
                if ($sameContent) {
                    $studentContentNew = $insertStudentContentNew = [];
                    for ($x = 0; $x < count($sameContent); $x++) {
                        $checkStudentAnswer = $this->student_model->getStudentAnswerList($sameContent[$x], $params['from_class'], $params['student_id']);
                        if ($checkStudentAnswer) {
                            $answers = [];
                            $z = 0;
                            for ($k = 0; $k < count($checkStudentAnswer); $k++) {
                                $answers[$z]['class_id'] = $params['to_class'];
                                $answers[$z]['answer_id'] = $checkStudentAnswer[$k]['answer_id'];
                                $answers[$z]['question_no'] = $checkStudentAnswer[$k]['question_no'];
                                $answers[$z]['correct_answer'] = $checkStudentAnswer[$k]['correct_answer'];
                                $answers[$z]['student_answer'] = $checkStudentAnswer[$k]['student_answer'];
                                $answers[$z]['editor_answer'] = $checkStudentAnswer[$k]['editor_answer'];
                                $answers[$z]['student_answer_image'] = $checkStudentAnswer[$k]['student_answer_image'];
                                $answers[$z]['options'] = $checkStudentAnswer[$k]['options'];
                                $answers[$z]['optionsCopy'] = $checkStudentAnswer[$k]['optionsCopy'];
                                $answers[$z]['actual_points'] = $checkStudentAnswer[$k]['actual_points'];
                                $answers[$z]['earned_points'] = $checkStudentAnswer[$k]['earned_points'];
                                $answers[$z]['answer_status'] = $checkStudentAnswer[$k]['answer_status'];
                                $answers[$z]['answer_attended'] = $checkStudentAnswer[$k]['answer_attended'];
                                $answers[$z]['auto_grade'] = $checkStudentAnswer[$k]['auto_grade'];
                                $answers[$z]['feedback'] = $checkStudentAnswer[$k]['feedback'];
                                $answers[$z]['annotation'] = $checkStudentAnswer[$k]['annotation'];
                                $answers[$z]['jiixdata'] = $checkStudentAnswer[$k]['jiixdata'];
                                $answers[$z]['roughdata'] = $checkStudentAnswer[$k]['roughdata'];
                                $answers[$z]['student_roughdata'] = $checkStudentAnswer[$k]['student_roughdata'];
                                $answers[$z]['rough_image_url'] = $checkStudentAnswer[$k]['rough_image_url'];
                                $answers[$z]['rough_image_thumb_url'] = $checkStudentAnswer[$k]['rough_image_thumb_url'];
                                $answers[$z]['modified_by'] = $params['user_id'];
                                $answers[$z]['modified_date'] = date('Y-m-d H:i:s');
                                $z++;
                            }
                            if (count($answers) > 0) {
                                if (count($answers) > 100) {
                                    $chunk_result = array_chunk($answers, 100, true);
                                    foreach ($chunk_result as $chunk) {
                                        $this->common_model->updateBatchMultiple1('student_answers', $chunk, 'answer_id', $params['from_class'], $params['student_id'], $sameContent[$x]);
                                    }
                                } else {
                                    $this->common_model->updateBatchMultiple1('student_answers', $answers, 'answer_id', $params['from_class'], $params['student_id'], $sameContent[$x]);
                                }
                            }
                        }
                        $checkToclassContent = $this->student_model->checkToclassContent($params, $sameContent[$x]);
                        $getFromClassContent = $this->student_model->checkFromclassContent($params, $sameContent[$x]);
                        if ($checkToclassContent) {
                            $studentContentExists = $this->student_model->getContentAnnotation($params, $sameContent[$x], 'from_class');
                            if (count($studentContentExists) > 0 && !is_null($studentContentExists[0]['annotation']) && $studentContentExists[0]['annotation'] != '[]') {
                                $getAnnotation = $this->common_model->annotation($studentContentExists[0]['annotation']);
                                $getAnnotation = json_decode($getAnnotation);
                                if ($getAnnotation != '[]') {
                                    $folder = "../uploads/studentAnnotation/";
                                    $fileName = "student-annotation" . $studentContentExists[0]['id'] . $params['to_class'] . $sameContent[$x] . '.json';
                                    $createAnnotationFile = $this->common_model->createFlatFile($folder, $fileName, $getAnnotation);
                                    $path = "uploads/studentAnnotation/" . $fileName;
                                } else {
                                    $path = NULL;
                                }
                            } else {
                                $path = NULL;
                            }
                            $data = array(
                                'status' => $getFromClassContent[0]['status'], 'draft_status' => 0,
                                'annotation' => $path,
                                'upload_answer' => $studentContentExists[0]['upload_answer']
                            );
                            //$name = $this->student_model->name($sameContent[$x], $params['student_id'], $params['to_class']);
                            $data1 = array('student_content_status' => $getFromClassContent[0]['status'], 'draft_status' => 0);
                            $condition = array('class_id' => $params['to_class'], 'student_id' => $params['student_id'], 'content_id' => $sameContent[$x]);
                            $this->common_model->update('student_content', $data, $condition);
                            $this->common_model->update('student_work', $data1, $condition);
                            //student content feedback
                            $checkFeedback = $this->student_model->checkContentFeedback($params, $sameContent[$x]);
                            if ($checkFeedback) {
                                $this->common_model->update('student_content_feedback', $checkFeedback, $condition);
                            }
                            //student questions feedback
                            $checkQuestionFeedback = $this->student_model->checkQuestionFeedback($params, $sameContent[$x]);

                            if (count($checkQuestionFeedback) > 0) {
                                $this->common_model->update('student_suggestions', $checkQuestionFeedback, $condition);
                            }
                        } else {
                            $Annotation = [];
                            $studentContentExists = $this->student_model->getContentAnnotation($params, $sameContent[$x], 'from_class');
                            if (count($studentContentExists) > 0 && !is_null($studentContentExists[0]['annotation']) && $studentContentExists[0]['annotation'] != '[]') {
                                $getAnnotation = $this->common_model->annotation($studentContentExists[0]['annotation']);
                                if ($getAnnotation != '[]') {
                                    $Annotation = $getAnnotation;
                                } else {
                                    $Annotation = NULL;
                                }
                            } else {
                                $Annotation = NULL;
                            }
                            $getClassContentId = $this->student_model->getClassContentId($params['to_class'], $sameContent[$x]);
                            $getStudentGrade = $this->classes_model->studentGrade($params['school_id'], $params['student_id']);
                            $studentContentNew[] = array(
                                'class_id' => $params['to_class'],
                                'student_id' => $params['student_id'],
                                'content_id' => $sameContent[$x],
                                'status' => $studentContentExists[0]['status'],
                                'draft_status' => 0,
                                'grade_id' => $getStudentGrade[0]['grade_id'],
                                'class_content_id' => $getClassContentId[0]['id'],
                                'start_date' => $getClassContentId[0]['start_date'],
                                'end_date' => $getClassContentId[0]['end_date'],
                                'upload_answer' => $studentContentExists[0]['upload_answer'],
                                'annotation' => $Annotation,
                                'created_by' => $params['user_id'],
                                'created_date' => date('Y-m-d H:i:s')
                            );
                            //$this->common_model->insert('student_content', $studentContent);
                            $getDetailName = $this->student_model->name($sameContent[$x], $params['student_id'], $params['to_class']);
                            $insertStudentContentNew[] = array(
                                'class_id' => $params['to_class'],
                                'class_name' => $getDetailName['class_name'],
                                'student_id' => $params['student_id'],
                                'student_name' => $getDetailName['student_name'],
                                'content_id' => $sameContent[$x],
                                'draft_status' => 0,
                                'content_format' => $getDetailName['content_format'],
                                'content_type' => $getDetailName['content_type'],
                                'content_name' => $getDetailName['content_name'],
                                'student_content_status' => $studentContentExists[0]['status'],
                                'created_by' => $params['user_id'],
                                'created_date' => date('Y-m-d H:i:s')
                            );
                            //$this->common_model->insert('student_work', $insertStudentContent);
                        }
                        // }
                    }
                    if (count($studentContentNew) > 0) {
                        $this->common_model->bulkInsert('student_content', $studentContentNew);
                        $folder = "../uploads/studentAnnotation/";
                        for ($q = 0; $q < count($studentContentNew); $q++) {
                            if($studentContentNew[$q]['annotation'] != ''){
                                $studentContentNew[$q]['annotation'] = json_decode($studentContentNew[$q]['annotation']);
                                $getStudentContent = $this->student_model->getStudentContent($studentContentNew[$q]);
                                $fileName = "student-annotation" . $getStudentContent[0]['id'] . $studentContentNew[$q]['class_id'] . $studentContentNew[$q]['content_id'] . '.json';
                                $createAnnotationFile = $this->common_model->createFlatFile($folder, $fileName, $studentContentNew[$q]['annotation']);
                                $path = "uploads/studentAnnotation/" . $fileName;
                                $data = array('annotation' => $path);
                                $condition = array('class_id' => $studentContentNew[$q]['class_id'], 'student_id' => $studentContentNew[$q]['student_id'], 'content_id' => $studentContentNew[$q]['content_id']);
                                $this->common_model->update('student_content', $data, $condition);
                            }
                        }
                    }
                    if (count($insertStudentContentNew) > 0) {
                        $this->common_model->bulkInsert('student_work', $insertStudentContentNew);
                        // $folder = "../uploads/studentAnnotation/";
                        // for ($q = 0; $q < count($studentContentNew); $q++) {
                        //     $getStudentContent = $this->student_model->getStudentContent($studentContentNew[$q]);
                        //     $fileName = "student-annotation" . $getStudentContent[0]['id'] . $studentContentNew[$q]['class_id'] . $studentContentNew[$q]['content_id'] . '.json';
                        //     $createAnnotationFile = $this->common_model->createFlatFile($folder, $fileName, $studentContentNew[$q]['annotation']);
                        //     $path = "uploads/studentAnnotation/" . $fileName;
                        //     $data = array('annotation' => $path);
                        //     $condition = array('class_id' => $studentContentNew[$q]['class_id'], 'student_id' => $studentContentNew[$q]['student_id'], 'content_id' => $studentContentNew[$q]['content_id']);
                        //     $this->common_model->update('student_content', $data, $condition);
                        // }
                    }
                }
                //shiftclass contents tagging
                $getShiftClassContent = $this->student_model->getToClassContent($params);
                $ids1 = array();
                foreach ($fromClassContent as $elem1)
                    $ids1[] = $elem1['content_id'];

                $ids2 = array();
                foreach ($getShiftClassContent as $elem2)
                    $ids2[] = $elem2['content_id'];

                $newContent = array_values(array_diff($ids2, $ids1));
                if ($newContent) {
                    $studentContent = $insertStudentContent = [];
                    foreach ($newContent as $key1 => $value1) {
                        $checkToClassContentExists = $this->student_model->checkStudentContentExists($params, $value1);
                        if (count($checkToClassContentExists) == 0) {
                            $studentContentExists = $this->student_model->checkContent($params, $value1, 'to_class');
                            $studentContent1 = $this->student_model->checkContent($params, $value1, 'class');

                            //  for ($s = 0; $s < count($Id); $s++) {
                            if (count($studentContentExists) == 0 && count($studentContent1) == 0) {
                                $getClassContentId = $this->student_model->getClassContentId($params['to_class'], $value1);
                                $getStudentGrade = $this->classes_model->studentGrade($params['school_id'], $params['student_id']);
                                $studentContent[] = array(
                                    'class_id' => $params['to_class'],
                                    'student_id' => $params['student_id'],
                                    'content_id' => $value1,
                                    'grade_id' => $getStudentGrade[0]['grade_id'],
                                    'class_content_id' => $getClassContentId[0]['id'],
                                    'start_date' => $getClassContentId[0]['start_date'],
                                    'end_date' => $getClassContentId[0]['end_date'],
                                    'status' => 1,
                                    'draft_status' => 0,
                                    'created_by' => $params['user_id'],
                                    'created_date' => date('Y-m-d H:i:s')
                                );
                                //                                    $this->common_model->insert('student_content', $studentContent);
                                $getDetailName = $this->student_model->name($value1, $params['student_id'], $params['to_class']);
                                $insertStudentContent[] = array(
                                    'class_id' => $params['to_class'],
                                    'class_name' => $getDetailName['class_name'],
                                    'student_id' => $params['student_id'],
                                    'student_name' => $getDetailName['student_name'],
                                    'content_id' => $value1,
                                    'draft_status' => 0,
                                    'content_name' => $getDetailName['content_name'],
                                    'student_content_status' => 1,
                                    'created_by' => $params['user_id'],
                                    'created_date' => date('Y-m-d H:i:s')
                                );
                                //                                    $this->common_model->insert('student_work', $insertStudentContent);
                                //student content feedback
                                $checkFeedback = $this->student_model->checkContentFeedback($params, $value1);
                                $feedbackArray = array();
                                foreach ($checkFeedback as $feedback) {
                                    $feedbackArray[] = array(
                                        'content_id' => $feedback['content_id'],
                                        'class_id' => $params['to_class'],
                                        'student_id' => $feedback['student_id'],
                                        'notes' => $feedback['notes'],
                                        'created_by' => $params['user_id'],
                                        'created_date' => date('Y-m-d H:i:s')
                                    );
                                }
                                if (count($feedbackArray) > 0) {
                                    $this->common_model->bulkInsert('student_content_feedback', $feedbackArray);
                                }
                                //student questions feedback
                                $checkQuestionFeedback = $this->student_model->checkQuestionFeedback($params, $value1);
                                $feedbackQuestionArray = array();
                                foreach ($checkQuestionFeedback as $feedback) {
                                    $feedbackQuestionArray[] = array(
                                        'content_id' => $feedback['content_id'],
                                        'class_id' => $params['to_class'],
                                        'student_id' => $feedback['student_id'],
                                        'answer_id' => $feedback['answer_id'],
                                        'school_id' => $feedback['school_id'],
                                        'suggestion_query' => $feedback['suggestion_query'],
                                        'created_by' => $params['user_id'],
                                        'created_date' => date('Y-m-d H:i:s')
                                    );
                                }
                                if (count($feedbackQuestionArray) > 0) {
                                    $this->common_model->bulkInsert('student_suggestions', $feedbackQuestionArray);
                                }
                            } else {
                                $status = 1;
                                if (count($studentContentExists) > 0) {
                                    $status = $studentContentExists[0]['status'];
                                }
                                if (count($studentContent1) > 0) {
                                    $status = $studentContent1[0]['status'];
                                }

                                $toClass = array(
                                    'draft_status' => 0,
                                    'status' => $status
                                );
                                $studentWork = array(
                                    'student_content_status' => $status,
                                    'draft_status' => 0
                                );
                                $condition = array('class_id' => $params['to_class'], 'content_id' => $value1, 'student_id' => $params['student_id']);
                                $this->common_model->update('student_content', $toClass, $condition);
                                $this->common_model->update('student_work', $studentWork, $condition);
                            }
                            //  }
                        }
                    }
                    if (count($studentContent) > 0) {
                        $this->common_model->bulkInsert('student_content', $studentContent);
                    }
                    if (count($insertStudentContent) > 0) {
                        $this->common_model->bulkInsert('student_work', $insertStudentContent);
                    }
                }
            }
        }
        $this->jsonarr["IsSuccess"] = true;
        $this->jsonarr["ResponseObject"] = "Student Transfer Successfully";
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params, 'v1/student/studentClassShiftNew', $this->jsonarr, 'studentClassShiftNew');
        $this->printjson($this->jsonarr);
    }

    public function StudentFromClassList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Shifted Class Should not be Empty";
        } else {
            $this->common_model->createLog($params, 'v1/student/StudentFromClassList', 'only request', 'StudentFromClassList');
            $classList = $this->student_model->studentFromClass($params);
            foreach ($classList as $key => $value){
                $classList[$key]['teacher_id'] = explode(',',$value['teacher_id']);
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = array_values(array_map("unserialize", array_unique(array_map("serialize", $classList))));
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params, 'v1/student/StudentFromClassList', $this->jsonarr, 'StudentFromClassList');
        return $this->printjson($this->jsonarr);
    }

    public function answerKeyRequest_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Student Id Should not be Empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Class Id Should not be Empty";
        } elseif ($params['content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Content Id Should not be Empty";
        } else {
            $this->common_model->createLog($params,'v1/student/answerKeyRequest','only request','answerKeyRequest');
            $checkAnswerKeyRequest = $this->student_model->checkAnswerKeyRequest($params);
            if (count($checkAnswerKeyRequest) == 0) {
                $answerkey = array(
                    'student_id' => $params['student_id'],
                    'content_id' => $params['content_id'],
                    'class_id' => $params['class_id'],
                    'created_by' => $params['user_id'],
                    'created_date' => date('Y-m-d H:i:s'),
                    'status' => 1
                );
                $insertAnswerkey = $this->common_model->insert('student_answerkey_request', $answerkey);
                $data = array(
                    'answer_request' => 1
                );
                $condition = array(
                    'student_id' => $params['student_id'],
                    'content_id' => $params['content_id'],
                    'class_id' => $params['class_id']
                );
                $updateAnswerkey = $this->common_model->update('student_content', $data, $condition);
                if ($insertAnswerkey && $updateAnswerkey) {
                    $this->jsonarr["IsSuccess"] = true;
                    $this->jsonarr["ResponseObject"] = "Student Answerkey Request Added Successful";
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "Student Answerkey Request Add Failed";
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Student Answerkey Request Already Exists";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params, 'v1/student/answerKeyRequest', $this->jsonarr, 'answerKeyRequest');
        return $this->printjson($this->jsonarr);
    }

    public function uploadAnswerList_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        //$this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } else {
            $this->common_model->createLog($params, 'v1/student/uploadAnswerList', 'only request', 'uploadAnswerList');
            $uploadAnswerList = $this->student_model->getUploadAnswerList($params);
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $uploadAnswerList;

        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params, 'v1/student/uploadAnswerList', $this->jsonarr, 'uploadAnswerList');
        return $this->printjson($this->jsonarr);
    }

    public function myProfile_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents("php://input"), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User id should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role id should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School id should not be Empty";
        } else {
            $this->common_model->createLog($params, 'v1/student/answerKeyRequest', 'only request', 'answerKeyRequest');
            $getProfile = $this->user_model->getUserDetails($params);
            $params['student_id'] = $params['user_id'];
            $studentClassList = $this->student_model->studentclasslist($params);
            $myProfile = [];
            for ($i = 0; $i < count($getProfile); $i++) {
                $dataAvailable = false;
                for ($j = 0; $j < count($myProfile); $j++) {
                    if ($myProfile[$j]['user_id'] == $getProfile[$i]['user_id']) {
                        $dataAvailable = true;
                    }
                }
                if (!$dataAvailable) {
                    $c = count($myProfile);
                    $myProfile[$c]['user_id'] = $getProfile[$i]['user_id'];
                    $myProfile[$c]['role_id'] = $getProfile[$i]['role_id'];
                    $myProfile[$c]['email_id'] = $getProfile[$i]['email_id'];
                    $getMobile = explode(',', $getProfile[$i]['mobile']);
                    $myProfile[$c]['mobile'] = $getMobile[0];
                    $myProfile[$c]['school_id'] = $getProfile[$i]['school_id'];
                    $myProfile[$c]['school_name'] = $getProfile[$i]['school_name'];
                    $myProfile[$c]['first_name'] = $getProfile[$i]['first_name'];
                    $myProfile[$c]['last_name'] = $getProfile[$i]['last_name'];
                    $myProfile[$c]['profile_url'] = $getProfile[$i]['profile_url'];
                    $myProfile[$c]['profile_thumb_url'] = $getProfile[$i]['profile_thumb_url'];
                    $myProfile[$c]['birthday'] = $params['platform'] == 'ios' && $getProfile[$i]['birthday'] != '0000-00-00' ?
                        date('m-d-Y', strtotime($getProfile[$i]['birthday'])) : $getProfile[$i]['birthday'];
                    $myProfile[$c]['gender'] = $getProfile[$i]['gender'];
                    $myProfile[$c]['school_idno'] = $getProfile[$i]['school_idno'];
                    $myProfile[$c]['grade_id'] = $getProfile[$i]['grade_id'];
                    if ($getProfile[$i]['name'] == ',') {
                        $myProfile[$c]['parent1_name'] = '';
                    } else {
                        $parentName1 = explode(',', $getProfile[$i]['name']);
                        $myProfile[$c]['parent1_name'] = implode(' ', $parentName1);
                    }
                    $myProfile[$c]['parent1_name'] = implode(' ', $parentName1);
                    $myProfile[$c]['address'][0]['address1'] = $getProfile[$i]['address1'];
                    $myProfile[$c]['address'][0]['address2'] = $getProfile[$i]['address2'];
                    $myProfile[$c]['address'][0]['city'] = $getProfile[$i]['city'];
                    $myProfile[$c]['address'][0]['state'] = $getProfile[$i]['state'];
                    $myProfile[$c]['address'][0]['state_name'] = $getProfile[$i]['state_name'];
                    $myProfile[$c]['address'][0]['country'] = $getProfile[$i]['country'];
                    $myProfile[$c]['address'][0]['country_name'] = $getProfile[$i]['country_name'];
                    $myProfile[$c]['address'][0]['postal_code'] = $getProfile[$i]['postal_code'];
                    if ($studentClassList) {
                        $myProfile[$c]['class_details'][0]['teacher_id'] = $studentClassList[0]['teacher_id'];
                        $myProfile[$c]['class_details'][0]['class_id'] = $studentClassList[0]['class_id'];
                        $myProfile[$c]['class_details'][0]['from_class'] = $studentClassList[0]['from_class'];
                        $myProfile[$c]['class_details'][0]['transfer_class'] = $studentClassList[0]['transfer_class'];
                        $myProfile[$c]['class_details'][0]['transferred_date'] = $studentClassList[0]['transferred_date'];
                        $myProfile[$c]['class_details'][0]['class_name'] = $studentClassList[0]['class_name'];
                        $myProfile[$c]['class_details'][0]['status'] = $studentClassList[0]['status'];
                        $myProfile[$c]['class_details'][0]['class_code'] = $studentClassList[0]['class_code'];
                        $myProfile[$c]['class_details'][0]['start_date'] = $studentClassList[0]['start_date'];
                        $myProfile[$c]['class_details'][0]['end_date'] = $studentClassList[0]['end_date'];
                        $myProfile[$c]['class_details'][0]['profile_url'] = $studentClassList[0]['profile_url'];
                        $myProfile[$c]['class_details'][0]['subject'] = $studentClassList[0]['subject'];
                        $myProfile[$c]['class_details'][0]['grade'] = $studentClassList[0]['grade'];
                        $myProfile[$c]['class_details'][0]['resources'] = $studentClassList[0]['resources'];
                        $myProfile[$c]['class_details'][0]['assignment'] = $studentClassList[0]['assignment'];
                        $myProfile[$c]['class_details'][0]['assessment'] = $studentClassList[0]['assessment'];
                    } elseif (count($studentClassList) == 0) {
                        $myProfile[$c]['class_details'] = [];
                    }
                } else {
                    for ($k = 0; $k < count($myProfile); $k++) {
                        if ($myProfile[$k]['user_id'] == $getProfile[$i]['user_id']) {
                            $cnt = count($myProfile[$k]['address']);
                            if ($getProfile[$i]['name'] == ',') {
                                $myProfile[$k]['parent2_name'] = '';
                            } else {
                                $parentName2 = explode(',', $getProfile[$i]['name']);
                                $myProfile[$k]['parent2_name'] = implode(' ', $parentName2);
                            }
                            $myProfile[$k]['address'][$cnt]['address1'] = $getProfile[$i]['address1'];
                            $myProfile[$k]['address'][$cnt]['address2'] = $getProfile[$i]['address2'];
                            $myProfile[$k]['address'][$cnt]['city'] = $getProfile[$i]['city'];
                            $myProfile[$k]['address'][$cnt]['state'] = $getProfile[$i]['state'];
                            $myProfile[$k]['address'][$cnt]['state_name'] = $getProfile[$i]['state_name'];
                            $myProfile[$k]['address'][$cnt]['country'] = $getProfile[$i]['country'];
                            $myProfile[$k]['address'][$cnt]['country_name'] = $getProfile[$i]['country_name'];
                            $myProfile[$k]['address'][$cnt]['postal_code'] = $getProfile[$i]['postal_code'];


                            for ($d = 0; $d < count($studentClassList); $d++) {
                                $cn = count($myProfile[$k]['class_details']);
                                $myProfile[$k]['class_details'][$cn]['teacher_id'] = $studentClassList[$d]['teacher_id'];
                                $myProfile[$k]['class_details'][$cn]['class_id'] = $studentClassList[$d]['class_id'];
                                $myProfile[$k]['class_details'][$cn]['from_class'] = $studentClassList[$d]['from_class'];
                                $myProfile[$k]['class_details'][$cn]['transfer_class'] = $studentClassList[$d]['transfer_class'];
                                $myProfile[$k]['class_details'][$cn]['transferred_date'] = $studentClassList[$d]['transferred_date'];
                                $myProfile[$k]['class_details'][$cn]['class_name'] = $studentClassList[$d]['class_name'];
                                $myProfile[$k]['class_details'][$cn]['status'] = $studentClassList[$d]['status'];
                                $myProfile[$k]['class_details'][$cn]['class_code'] = $studentClassList[$d]['class_code'];
                                $myProfile[$k]['class_details'][$cn]['start_date'] = $studentClassList[$d]['start_date'];
                                $myProfile[$k]['class_details'][$cn]['end_date'] = $studentClassList[$d]['end_date'];
                                $myProfile[$k]['class_details'][$cn]['profile_url'] = $studentClassList[$d]['profile_url'];
                                $myProfile[$k]['class_details'][$cn]['subject'] = $studentClassList[$d]['subject'];
                                $myProfile[$k]['class_details'][$cn]['grade'] = $studentClassList[$d]['grade'];
                                $myProfile[$k]['class_details'][$cn]['resources'] = $studentClassList[$d]['resources'];
                                $myProfile[$k]['class_details'][$cn]['assignment'] = $studentClassList[$d]['assignment'];
                                $myProfile[$k]['class_details'][$cn]['assessment'] = $studentClassList[$d]['assessment'];
                            }
                        }
                    }
                }
            }

        }
        $this->jsonarr["IsSuccess"] = true;
        $this->jsonarr["ResponseObject"] = $myProfile;
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params, 'v1/student/uploadAnswerList', $this->jsonarr, 'uploadAnswerList');
        return $this->printjson($this->jsonarr);

    }

    public function ClassRecording_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents("php://input"), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id Should not be Empty";
        } else {
            $this->common_model->createLog($params, 'v1/student/ClassRecording', 'only request', 'ClassRecording');
            $completedSchedule = $this->student_model->completedSchedule($params['class_id']);
            if (count($completedSchedule) > 0) {
                for ($a = 0; $a < count($completedSchedule);$a++) {
                    $completedSchedule[$a]['meeting_recording'] = [];
                    if ($completedSchedule[$a]['meeting_id'] != '' && $completedSchedule[$a]['user_email'] != '') {
                        $zoomInstance = $this->zoom_model->listOfZoomInstances($params, $completedSchedule[$a]['meeting_id'],$completedSchedule[$a]['schedule_id']);
                        if (isset($zoomInstance['meetings']) && $zoomInstance['meetings']) {
                            for ($b = 0; $b < count($zoomInstance['meetings']); $b++) {
                                $zoomRecordings = $this->zoom_model->zoomrecordings($params, $zoomInstance['meetings'][$b]['uuid'],$completedSchedule[$a]['schedule_id']);
                                if ($zoomRecordings) {
                                    $completedSchedule[$a]['meeting_recording'][$b]['meeting_id'] = $zoomRecordings['id'];
                                    $completedSchedule[$a]['meeting_recording'][$b]['play_video'] = $zoomRecordings['recording_files'][0]['play_url'];
                                    $completedSchedule[$a]['meeting_recording'][$b]['audio_only'] = $zoomRecordings['recording_files'][1]['play_url'];
                                    $completedSchedule[$a]['meeting_recording'][$b]['recording_start'] = $zoomRecordings['recording_files'][0]['recording_start'];
                                    $completedSchedule[$a]['meeting_recording'][$b]['recording_end'] = $zoomRecordings['recording_files'][0]['recording_end'];
                                    $completedSchedule[$a]['meeting_recording'][$b]['passcode'] = $zoomRecordings['password'];
                                }
                            }
                        }
                    }
                }
            }
        }
        foreach ($completedSchedule as $key => $value) {
            if(empty($completedSchedule[$key]['meeting_recording'])) {
                unset($completedSchedule[$key]);
            }
        }
        if ($completedSchedule) {
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = array_values($completedSchedule);
        } else {
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = [];
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        $this->common_model->createLog($params, 'v1/student/ClassRecording', $this->jsonarr, 'ClassRecording');
        return $this->printjson($this->jsonarr);
    }

    public function getZoomLink_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents("php://input"), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id Should not be Empty";
        } elseif ($params['schedule_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Schedule Id Should not be Empty";
        } else {
            $getZoomLink = $this->student_model->getZoomLink($params);
            if($getZoomLink) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = $getZoomLink;
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ResponseObject']['message'] = "Meeting not started";
            }
            $this->benchmark->mark('code_end');
            $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
            $this->common_model->createLog($params, 'v1/student/ClassRecording', $this->jsonarr, 'ClassRecording');
        }
        return $this->printjson($this->jsonarr);
    }

    public function studentClassHistory_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Student Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should not be Empty";
        } else {
            $getstudentclasslist = $this->student_model->getClassHistory($params);
            foreach ($getstudentclasslist as $key => $value) {
                if ($value['from_class'] == 0) {
                    $getstudentclasslist[$key]['transferred_date'] = '';
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $getstudentclasslist;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }
    public function addRepository_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Role Id Should not be Empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "Student Id Should not be Empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObejct"] = "School Id Should not be Empty";
        } else {
            if(isset($params['type']) && $params['type'] == 1) {
                $studentRepository['name'] = $params['name'];
                $studentRepository['description'] = isset($params['description']) ? $params['description'] : '';
                $studentRepository['category_id'] = $params['category_id'];
                $studentRepository['school_id'] = $params['school_id'];
                $studentRepository['student_id'] = $params['student_id'];
                $studentRepository['status'] = 1;
                $studentRepository['subject_name'] = isset($params['subject_name']) && $params['subject_name'] != '' ? $params['subject_name'] : '';
                $studentRepository['grade_name'] = isset($params['grade_name']) && $params['grade_name'] != '' ? $params['grade_name'] : '';
                $studentRepository['file_path'] = isset($params['file_path']) && $params['file_path'] != '' ? json_encode($params['file_path']) : '';
                $studentRepository['links'] = isset($params['link']) ? $params['link'] : '';
                $studentRepository['created_by'] = $params['name'];
                $studentRepository['created_date'] = $params['name'];
                $checkRepository = $this->student_model->checkRepository($params);
                if(count($checkRepository) == 0) {
                    $addStudentRepository = $this->common_model->insert('student_repository', $studentRepository);
                    if ($addStudentRepository > 0) {
                        $this->jsonarr["IsSuccess"] = true;
                        $this->jsonarr["ResponseObject"] = "Content Added Successfully";
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObejct"] = "Content Add failed";
                    }
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObejct"] = "Name Already Exists";
                }
            } else {
                $studentRepository = [];
                $z = 0;
                for($i=0;$i< count($params['contents']);$i++) {
                    $studentRepository[$z]['name'] = $params['contents'][$i]['name'];
                    $studentRepository[$z]['category_id'] = $params['contents'][$i]['category_id'];
                    $studentRepository[$z]['school_id'] = $params['school_id'];
                    $studentRepository[$z]['student_id'] = $params['student_id'];
                    $studentRepository[$z]['description'] = isset($params['contents'][$i]['description']) && $params['contents'][$i]['description'] != '' ? $params['contents'][$i]['description'] : '';
                    $studentRepository[$z]['grade_name'] = isset($params['contents'][$i]['grade_name']) && $params['contents'][$i]['grade_name'] != '' ? $params['contents'][$i]['grade_name'] : '';
                    $studentRepository[$z]['subject_name'] = isset($params['contents'][$i]['subject_name']) && $params['contents'][$i]['subject_name'] != '' ? $params['contents'][$i]['subject_name'] : '';
                    if (isset($params['contents'][$i]['file_path'])) {
                        if ($params['contents'][$i]['file_path'] != '') {
                            $studentRepository[$z]['file_path'] = json_encode($params['contents'][$i]['file_path']);
                        } elseif ($params['contents'][$i]['file_path'] == '') {
                            $studentRepository[$z]['file_path'] = '';
                        }
                    }
                    $studentRepository[$z]['links'] = isset($params['contents'][$i]['link']) && $params['contents'][$i]['link'] != '' ? $params['contents'][$i]['link'] : '';
                    $studentRepository[$z]['status'] = 1;
                    $studentRepository[$z]['created_by'] = $params['user_id'];
                    $studentRepository[$z]['created_date'] = date('Y-m-d H:i:s');
                    $z++;
                }
                if(count($studentRepository) > 0) {
                    $addStudentRepository = $this->common_model->bulkInsert('student_repository', $studentRepository);
                    if ($addStudentRepository > 0) {
                        $this->jsonarr["IsSuccess"] = true;
                        $this->jsonarr["ResponseObject"] = "Content Added Successfully";
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObejct"] = "Content Add failed";
                    }
                }

            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function editRepository_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
     //   $this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Name Id should not be empty";
        }  elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School Id should not be empty";
        } elseif(count($this->jsonarr)==0) {
            $studentRepository['name'] = $params['name'];
            $studentRepository['description'] = isset($params['description']) ? $params['description'] : '';
            $studentRepository['category_id'] = $params['category_id'];
            $studentRepository['status'] = $params['status'];
            $studentRepository['subject_name'] = isset($params['subject_name']) && $params['subject_name'] != '' ? $params['subject_name'] : '';
            $studentRepository['grade_name'] = isset($params['grade_name']) && $params['grade_name'] != '' ? $params['grade_name'] : '';
            $studentRepository['file_path'] = isset($params['file_path']) && $params['file_path'] != '' ? json_encode($params['file_path']) : '';
            $studentRepository['links'] = isset($params['link']) ? $params['link'] : '';
            $studentRepository['modified_by'] = $params['user_id'];
            $studentRepository['created_date'] = date('Y-m-d H:i:s');
            $condition = array('id' => $params['repository_id']);
            $updated = $this->common_model->update('student_repository', $studentRepository, $condition);
            if ($updated) {
                 $this->jsonarr["IsSuccess"] = true;
                 $this->jsonarr["ResponseObject"] = "Content updated successfully";
            } else {
                 $this->jsonarr["IsSuccess"] = false;
                 $this->jsonarr["ErrorObject"] = "Failed To Update Content";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }
    public function repositoryList_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
      //  $this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } else {
            $list = $this->student_model->repositoryList($params);
            foreach ($list as $key => $value ){
                $list[$key]['file_path'] = json_decode($value['file_path']);
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $list;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function addContentFolder_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
     //   $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['category_name'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Folder Name should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Student Id should not be empty";
        } else {
            $checkFolder = $this->student_model->checkFolder($params, 'add');
            if (count($checkFolder) == 0) {
                $data = array(
                    'category_name' => $params['category_name'],
            'school_id' => $params['school_id'],
                    'student_id' => $params['student_id'],
                    'status' => $params['status'],
                    'created_by' => $params['user_id'],
                    'created_date' => date('Y-m-d H:i:s')
                );
                $folderId = $this->common_model->insert('student_category', $data);
                if ($folderId > 0) {
                    $this->jsonarr["IsSuccess"] = true;
                    $this->jsonarr["ResponseObject"] = "Folder added successfully";
                } else {
                    $this->jsonarr['IsSuccess'] = false;
                    $this->jsonarr['ErrorObject'] = "Folder not added";
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Folder already Exists";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function contentFolderList_post() {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
      //  $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } else {
            $folderList = $this->student_model->folderList($params);
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $folderList;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function editContentFolder_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
       // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['category_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Category Id should not be empty";
        } elseif ($params['category_name'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Folder Name should not be empty";
        }  elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        }  elseif ($params['student_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Student Id should not be empty";
        }
        $checkFolder = $this->student_model->checkFolder($params,'edit');
        if (count($checkFolder) == 0) {
            $condition = array("category_id" => $params['category_id']);
            $data = array(
                'category_name'=>$params['category_name'],
                'school_id'=>$params['school_id'],
                'status'=>$params['status'],
                'modified_by'=>$params['user_id'],
                'modified_date'=>date('Y-m-d H:i:s')
            );
            $update=$this->common_model->update('student_category',$data,$condition);
            if ($update) {
                $this->jsonarr["IsSuccess"] = true;
                $this->jsonarr["ResponseObject"] = "Folder updated successfully";
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Failed to update Folder";
            }
        } else {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Folder not found";
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }


    public function googleRegister_post() {

        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['google_token'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Token should not be empty";
        } elseif ($params['class_code'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class code should not be empty";
        } else {

            $getTokenDetails = $this->user_model->checkGoogleRegisToken($params);
            if(count($getTokenDetails) > 0) {
                $responseArray = explode('.', $getTokenDetails['0']['googleid_token']);
                $responseObject = base64_decode($responseArray[1]);
                $responseJSON = json_decode($responseObject, true);
                $params['email_id'] = $responseJSON['email'];
                if($params['email_id'] == $getTokenDetails['0']['email_id']) {
                    $params['first_name'] = $responseJSON['given_name'];
                    $params['last_name'] = $responseJSON['family_name'];
                    $params['password'] = "Welcome@2023";
                    $params['type'] = 'GOOGLE' ;
                    $params['grade_id'] = '' ;
                    $params['gender'] = '' ;
                    $params['mobile'] = [] ;
                    $this->jsonarr = $this->registerNewStudent($params);
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "Something went wrong. Please try again after sometime or contact Administrator ";
                }
                // TODO delete google token
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Something went wrong. Please try again after sometime or contact Administrator ";
            }

            $this->benchmark->mark('code_end');
            $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
            $this->printjson($this->jsonarr);
        }
    }

    public function register_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['class_code'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class Code should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "First_name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Last_name should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Email should not be empty";
        } else {
            $this->jsonarr = $this->registerNewStudent($params);
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function registerNewStudent($params)
    {
        $getClassId = $this->student_model->getClassId($params);
        if (count($getClassId) > 0) {
            $params['class_id'] = $getClassId[0]['class_id'];
            $params['school_id'] = $getClassId[0]['school_id'];
            $condition = "WHERE email_id = '{$params['email_id']}' AND class_id = {$getClassId[0]['class_id']}";
            $getMailNotification = $this->classes_model->classMailNotification($condition);
            if (count($getMailNotification) > 0) {
                $salt = $this->config->item('salt');
                $password = md5($salt . $params['password'] . $salt);
                $userExists = $this->student_model->user($params, 'add', '');
                if (count($userExists) == 0) {
                    $checkSchool = $this->student_model->checkSchool($params);
                    if (count($checkSchool) == 0) {
                        $user = [];
                        $user['role_id'] = 5;
                        $user['status'] = 1;
                        $user['login_type'] = 'WEB';
                        if (isset($params['type'])) {
                            $user['login_type'] = $params['type'];
                        }

                        $user['created_by'] = $getClassId[0]['admin'];
                        $user['created_date'] = date('Y-m-d H:i:s');
                        $user['email_id'] = $params['email_id'];
                        if (isset($params['mobile']) && count($params['mobile']) > 0) {
                            $user['mobile'] = implode(",", $params['mobile']);
                        }
                        $user['password'] = $password;
                        $user['school_id'] = $params['school_id'];
                        $id = $this->common_model->insert('user', $user);
                        if ($id > 0) {
                            $upgradeDetails = [];
                            $upgradeDetails['school_id'] = $params['school_id'];
                            $upgradeDetails['student_id'] = $id;
                            $upgradeDetails['grade_id'] = $params['grade_id'];
                            $upgradeDetails['active_date'] = date('Y-m-d H:i:s');
                            $upgradeDetails['created_by'] = $getClassId[0]['admin'];
                            $upgradeDetails['created_date'] = date('Y-m-d H:i:s');
                            $this->common_model->insert('upgrade', $upgradeDetails);
                            $userProfile = [];
                            $userProfile['user_id'] = $id;
                            $userProfile['first_name'] = $params['first_name'];
                            $userProfile['last_name'] = $params['last_name'];
                            $userProfile['gender'] = $params['gender'];
                            $userProfile['birthday'] = '0000-00-00';
                            $userProfile['created_by'] = $getClassId[0]['admin'];
                            $userProfile['created_date'] = date('Y-m-d H:i:s');
                            if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                                $userProfile['profile_url'] = $params['profile_url'];
                                $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                            }
                            $profileId = $this->common_model->insert('user_profile', $userProfile);
                            if ($profileId > 0) {
                                $userProfileDetail = [];
                                $userProfileDetail['user_id'] = $id;
                                $userProfileDetail['doj'] = date('Y-m-d');
                                $userProfileDetail['dropped_date'] = '0000-00-00';
                                $userProfileDetail['school_idno'] = '';
                                $userProfileDetail['school_id'] = $params['school_id'];
                                if (isset($params['grade_id']) && $params['grade_id'] != 0) {
                                    $userProfileDetail['grade_id'] = $params['grade_id'];
                                } else {
                                    $userProfileDetail['grade_id'] = 0;
                                }
                                $userProfileDetail['created_by'] = $getClassId[0]['admin'];
                                $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                                $profileDetailId = $this->common_model->insert('user_profile_details', $userProfileDetail);
                                if ($profileDetailId > 0) {
                                    $this->jsonarr["IsSuccess"] = true;
                                    $this->jsonarr["ResponseObject"]['msg'] = "Student registered successfully";
                                    $this->jsonarr["ResponseObject"]['class_code'] = $params['class_code'];
                                    $this->jsonarr["ResponseObject"]['user_id'] = $id;
                                    $this->jsonarr["ResponseObject"]['user_role'] = 5;
                                    $this->jsonarr["ResponseObject"]['status'] = 1;
                                    $this->jsonarr["ResponseObject"]['email_id'] = $params['email_id'];
                                    $this->jsonarr["ResponseObject"]['mobile'] = $params['mobile'];
                                    $this->jsonarr["ResponseObject"]['first_name'] = $params['first_name'];
                                    $this->jsonarr["ResponseObject"]['last_name'] = $params['last_name'];
                                    $this->jsonarr["ResponseObject"]['birthday'] = '0000-00-00';
                                    $this->jsonarr["ResponseObject"]['profile_url'] = '';
                                    $this->jsonarr["ResponseObject"]['profile_thumb_url'] = '';
                                    $this->jsonarr["ResponseObject"]['gender'] = $params['gender'];
                                    $this->jsonarr["ResponseObject"]['currency'] = '';
                                    $this->jsonarr["ResponseObject"]['address1'] = '';
                                    $this->jsonarr["ResponseObject"]['address2'] = '';
                                    $this->jsonarr["ResponseObject"]['city'] = '';
                                    $this->jsonarr["ResponseObject"]['state'] = '';
                                    $this->jsonarr["ResponseObject"]['state_name'] = '';
                                    $this->jsonarr["ResponseObject"]['country'] = '';
                                    $this->jsonarr["ResponseObject"]['country_name'] = '';
                                    $this->jsonarr["ResponseObject"]['tc_status'] = 0;
                                    $schoolDetails = $this->student_model->schoolDetails($params['school_id'], $id);
                                    $this->jsonarr["ResponseObject"]['school_details'] = $schoolDetails;
                                    if ($this->jsonarr["ResponseObject"]['user_id'] != null) {
                                        $generateToken = AUTHORIZATION::generateToken((object)array('user' => $this->jsonarr["ResponseObject"]['user_id'] . '|user', 'timestamp' => time()));
                                        $this->jsonarr['ResponseObject']['Accesstoken'] = $generateToken;
                                        $tokenInsert = array(
                                            'user_id' => $id,
                                            'access_token' => $generateToken,
            'status' => 1,
                                            'ip_address' => $_SERVER['REMOTE_ADDR'],
            'created_date' => date('Y-m-d H:i:s')
                                        );
                                        $this->common_model->insert('user_token', $tokenInsert);
                                        $noOfUsersForStudent = $this->student_model->usersForStudent();
                                        $userPermission = $noOfUsersForStudent['value'];
                                        if ($userPermission != 0) {
                                            $getToken = $this->user_model->getUserToken($id);
                                            if ($userPermission < count($getToken)) {
                                                foreach ($getToken as $key => $value) {
                                                    if ($key > $userPermission - 1) {
                                                        $updateData = array('status' => 0);
                                                        $condition = array('id' => $value['id']);
                                                        $this->common_model->update('user_token', $updateData, $condition);
                                                    }
                                                }
                                            }
                                        }

                                        $condition = array('class_id' => $getClassId[0]['class_id'], 'email_id' => $params['email_id']);
                                        $data['provider_id'] = '';
                                        $data['googleid_token'] = '';
                                        $this->common_model->update('class_mail_notification', $data, $condition);
                                    } else {
                                        $this->jsonarr['IsSuccess'] = "false";
                                        $this->jsonarr['ErrorObject'] = "Unauthorised User";
                                    }
                                } else {
                                    $this->jsonarr["IsSuccess"] = false;
                                    $this->jsonarr["ErrorObject"] = "Student profile detail not added";
                                }
                            } else {
                                $this->jsonarr["IsSuccess"] = false;
                                $this->jsonarr["ErrorObject"] = "Student profile not added";
                            }
                        } else {
                            $this->jsonarr["IsSuccess"] = false;
                            $this->jsonarr["ErrorObject"] = "Student not added";
                        }
                    }
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "Email-Id already exists";
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "You have not been invited to this class.Please contact your Teacher";
            }
        } else {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class Not Found";
        }
        return $this->jsonarr;
    }

    public function answerDetails_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents("php://input"), true);
        $headers = $this->input->request_headers();
        $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['student_content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Content Id Should not be Empty";
        } elseif ($params['question_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Question Id Should not be Empty";
        } else {
            $getStudentAnswer = $this->student_model->studentAnswer($params);
            if(count($getStudentAnswer) > 0){
                $getStudentAnswer[0]['correct_answer'] = json_decode($getStudentAnswer[0]['correct_answer']);
                $getStudentAnswer[0]['student_answer'] = json_decode($getStudentAnswer[0]['student_answer']);
                $getStudentAnswer[0]['options'] = json_decode($getStudentAnswer[0]['options']);
            }
            $getContentPercentage = $this->student_model->contentPercentage($params);
            $getStudentAnswer[0]['percentage'] = count($getContentPercentage) > 0 && !is_null($getContentPercentage[0]['percentage']) ? $getContentPercentage[0]['percentage'] : 0;
             $this->jsonarr['IsSuccess'] = true;
            $this->jsonarr['ResponseObject'] = $getStudentAnswer;
            $this->benchmark->mark('code_end');
            $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
            $this->common_model->createLog($params, 'v1/student/answerDetails', $this->jsonarr, 'answerDetails');
            return $this->printjson($this->jsonarr);
        }
    }

    public function attendanceDetail_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        //  $this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } else {
            $getStudentAttendance = $this->student_model->studentAttendance($params);
            foreach ($getStudentAttendance as $key => $value) {
                if (isset($value['attendance']) && $value['attendance'] == 0) {
                    $condition = "WHERE sc.from_class = {$value['class_id']} AND sc.student_id = {$params['student_id']} AND sc.absent_date = '{$value['date']}' AND sc.type = 'M' AND sc.status = 1";
                    $checkMakeUpClass = $this->student_model->makeUpClass($condition);
                    $getStudentAttendance[$key]['makeup_class_id'] = count($checkMakeUpClass) > 0 ? $checkMakeUpClass[0]['class_id'] : '';
                    $getStudentAttendance[$key]['makeup_class_name'] = count($checkMakeUpClass) > 0 ? $checkMakeUpClass[0]['class_name'] : '';
                    $getStudentAttendance[$key]['makeup_class_date'] = count($checkMakeUpClass) > 0 ? $checkMakeUpClass[0]['joining_date'] : '';
                } else {
                    $getStudentAttendance[$key]['makeup_class_id'] = '';
                    $getStudentAttendance[$key]['makeup_class_name'] = '';
                    $getStudentAttendance[$key]['makeup_class_date'] = '';
                }
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $getStudentAttendance;
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function addAcademyStudent_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $prop = parse_ini_file('../properties.ini', true, INI_SCANNER_RAW);
        $params['access_token'] = base64_decode(base64_decode($params['access_token']));
        // if ($params['access_token'] == $prop['access_token']) {
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['first_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "First_name should not be empty";
        } elseif ($params['last_name'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Last_name should not be empty";
        } elseif ($params['status'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "status should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School id should not be empty";
        } elseif ($params['email_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "School id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $this->common_model->createLog($params, 'v1/student/add', 'only request', 'add');
            $userExists = $this->student_model->user($params, 'add', '');
            if (count($userExists) == 0) {
                $checkSchool = $this->student_model->checkSchool($params);
                if (count($checkSchool) == 0) {
                    $user = [];
                    $user['role_id'] = 5;
                    $user['status'] = 1;
                    $user['login_type'] = 'WEB';
                    $user['created_by'] = $params['user_id'];
                    $user['created_date'] = date('Y-m-d H:i:s');
                    $user['email_id'] = $params['email_id'];
                    $user['mobile'] = $params['mobile'];
                    $user['school_id'] = $params['school_id'];
                    $salt = $this->config->item('salt');
                    $password = md5($salt . $params['password'] . $salt);
                    $user['password'] = $password;
                    $user['academy_user_id'] = isset($params['academy_student_id']) ? $params['academy_student_id'] : 0;
                    $id = $this->common_model->insert('user', $user);
                    if ($id > 0) {
                        $upgradeDetails = [];
                        $upgradeDetails['school_id'] = $params['school_id'];
                        $upgradeDetails['student_id'] = $id;
                        $upgradeDetails['grade_id'] = $params['grade_id'];
                        $upgradeDetails['active_date'] = date('Y-m-d H:i:s');
                        $upgradeDetails['created_by'] = $params['user_id'];
                        $upgradeDetails['created_date'] = date('Y-m-d H:i:s');
                        $this->common_model->insert('upgrade', $upgradeDetails);
                        $userProfile = [];
                        $userProfile['user_id'] = $id;
                        $userProfile['first_name'] = $params['first_name'];
                        $userProfile['last_name'] = $params['last_name'];
                        if (isset($params['gender']) && $params['gender'] != '') {
                            $userProfile['gender'] = $params['gender'] == 'M' ? 'male' : 'female';
                        } else {
                            $userProfile['gender'] = '';
                        }
                        $userProfile['birthday'] = isset($params['dob']) ? $params['dob'] : '0000-00-00';
                        $userProfile['created_by'] = $params['user_id'];
                        $userProfile['created_date'] = date('Y-m-d H:i:s');
                        if (isset($params['profile_url']) && isset($params['profile_thumb_url'])) {
                            $userProfile['profile_url'] = $params['profile_url'];
                            $userProfile['profile_thumb_url'] = $params['profile_thumb_url'];
                        }
                        $profileId = $this->common_model->insert('user_profile', $userProfile);
                        if ($profileId > 0) {
                            $userProfileDetail = [];
                            $userProfileDetail['user_id'] = $id;
                            $userProfileDetail['doj'] = date('Y-m-d');
                            $userProfileDetail['dropped_date'] = isset($params['dropped_date']) ? $params['dropped_date'] : '';
                            $userProfileDetail['school_idno'] = isset($params['school_idno']) ? $params['school_idno'] : '';
                            $userProfileDetail['school_id'] = $params['school_id'];
                            if ($params['grade_id'] != 0) {
                                $userProfileDetail['grade_id'] = $params['grade_id'];
                            } else {
                                $userProfileDetail['grade_id'] = 0;
                            }
                            $userProfileDetail['batch_id'] = 0;
                            $userProfileDetail['created_by'] = $params['user_id'];
                            $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                            $profileDetailId = $this->common_model->insert('user_profile_details', $userProfileDetail);
                            if ($profileDetailId > 0) {
                                $this->jsonarr["IsSuccess"] = true;
                                $this->jsonarr["ResponseObject"]['message'] = "Student added successfully";
                                $this->jsonarr["ResponseObject"]['student_id'] = $id;
                            } else {
                                $this->jsonarr["IsSuccess"] = false;
                                $this->jsonarr["ErrorObject"] = "Student profile detail not added";
                            }
                        } else {
                            $this->jsonarr["IsSuccess"] = false;
                            $this->jsonarr["ErrorObject"] = "Student profile not added";
                        }
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Student not added";
                    }
                } elseif (count($checkSchool) > 0) {
                    $condition = array('user_id' => $checkSchool[0]['user_id']);
                    $school = array();
                    $schoolIds = explode(",", $checkSchool[0]['school_id']);
                    array_push($schoolIds, $params['school_id']);
                    $school['school_id'] = implode(",", $schoolIds);
                    $school['academy_user_id'] = isset($params['academy_student_id']) ? $params['academy_student_id'] : 0;
                    $userProfileDetail = [];
                    $userProfileDetail['user_id'] = $checkSchool[0]['user_id'];
                    $userProfileDetail['doj'] = date('Y-m-d');
                    $userProfileDetail['dropped_date'] = '';
                    $userProfileDetail['school_id'] = $params['school_id'];
                    if ($params['grade_id'] != 0) {
                        $userProfileDetail['grade_id'] = $params['grade_id'];
                    } else {
                        $userProfileDetail['grade_id'] = 0;
                    }
                    $userProfileDetail['batch_id'] = 0;
                    $userProfileDetail['school_idno'] = '';
                    $userProfileDetail['created_by'] = $params['user_id'];
                    $userProfileDetail['created_date'] = date('Y-m-d H:i:s');
                    $update1 = $this->common_model->update('user', $school, $condition);
                    $update2 = $this->common_model->insert('user_profile_details', $userProfileDetail);
                    $upgradeDetails = [];
                    $upgradeDetails['school_id'] = $params['school_id'];
                    $upgradeDetails['student_id'] = $checkSchool[0]['user_id'];
                    $upgradeDetails['grade_id'] = $params['grade_id'];
                    $upgradeDetails['active_date'] = date('Y-m-d H:i:s');
                    $upgradeDetails['created_by'] = $params['user_id'];
                    $upgradeDetails['created_date'] = date('Y-m-d H:i:s');
                    $this->common_model->insert('upgrade', $upgradeDetails);
                    $this->jsonarr["IsSuccess"] = true;
                    $this->jsonarr["ResponseObject"]['message'] = "Student added successfully";
                    $this->jsonarr["ResponseObject"]['student_id'] = $checkSchool[0]['user_id'];
                }
            } else {
                $params['student_id'] = $userExists[0]['user_id'];
                $this->jsonarr["IsSuccess"] = true;
                $this->jsonarr["ResponseObject"]['message'] = "Student added successfully";
                $this->jsonarr["ResponseObject"]['student_id'] = $params['student_id'];
            }
        }
        // } else {
        //     $this->jsonarr["IsSuccess"] = false;
        //     $this->jsonarr["ErrorObject"] = "Unauthorised User";
        // }

        $this->common_model->createLog($params, 'v1/student/add', $this->jsonarr, 'add');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }
    public function addStudentClass($params)
    {
        if(isset($params['course_type']) && $params['course_type'] == 'F'){
            $condition = "WHERE academy_schedule_id = {$params['schedule_id']} AND academy_course_id = {$params['course_id']}";
            $getClassId = $this->classes_model->getAcademyClass($condition);
            if (count($getClassId) > 0) {
                $params['class_id'] = $getClassId[0]['class_id'];
                $studentExists = $this->classes_model->checkStudent($params['class_id'], $params['student_id']);
                if (count($studentExists) > 0) {
                    if ($studentExists[0]['status'] != 1) {
                        $studentcondition = "student_id = {$params['student_id']} AND class_id = {$params['class_id']}";
                        $student['class_id'] = $params['class_id'];
                        $student['student_id'] = $params['student_id'];
                        $student['validity'] = '';
                        $student['status'] = 1;
                        $student['modified_by'] = $params['user_id'];
                        $student['modified_date'] = date('Y-m-d H:i:s');
                        $this->common_model->update('student_class', $student, $studentcondition);
                    } else {
                        $this->jsonarr["IsSuccess"] = false;
                        $this->jsonarr["ErrorObject"] = "Student Already Registered In This Schedule";
                        $this->printjson($this->jsonarr);
                        exit;
                    }
                } else {
                    $student['class_id'] = $params['class_id'];
                    $student['student_id'] = $params['student_id'];
                    $student['validity'] = '';
                    $student['status'] = 1;
                    $student['created_by'] = $params['user_id'];
                    $student['created_date'] = date('Y-m-d H:i:s');
                    $student['joining_date'] = date('Y-m-d');
                    $this->common_model->insert('student_class', $student);
                }
                return true;
            } else {
                return false;
            }
        } else {
            return true;
        }
    }

    public function addStudentClass_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Id should not be empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class Id should not be empty";
        } elseif (count($this->jsonarr) == 0) {
            $id = 0;
            $studentExists = $this->classes_model->checkStudent($params['class_id'], $params['student_id']);
            if (count($studentExists) > 0) {
                if ($studentExists[0]['status'] != 1) {
                    $studentcondition = "student_id = {$params['student_id']} AND class_id = {$params['class_id']}";
                    $student['class_id'] = $params['class_id'];
                    $student['student_id'] = $params['student_id'];
                    $student['validity'] = '';
                    $student['status'] = 1;
                    $student['modified_by'] = $params['user_id'];
                    $student['modified_date'] = date('Y-m-d H:i:s');
                    $this->common_model->update('student_class', $student, $studentcondition);
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "Student Already Registered In This Schedule";
                    $this->printjson($this->jsonarr);
                    exit;
                }
            } else {
                $student['class_id'] = $params['class_id'];
                $student['student_id'] = $params['student_id'];
                $student['validity'] = '';
                $student['status'] = 1;
                $student['created_by'] = $params['user_id'];
                $student['created_date'] = date('Y-m-d H:i:s');
                $student['joining_date'] = date('Y-m-d');
                $id = $this->common_model->insert('student_class', $student);
            }
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = "Student added successfully";
            $this->jsonarr["student_class_id"] = $id;
        }
        $this->common_model->createLog($params, 'v1/user/getUserDetail', $this->jsonarr, 'getUserDetail');
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function updateNotifyStatus_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['class_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Class Id should not be empty";
        } elseif ($params['school_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "School Id should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Student Id should not be empty";
        } else{
            $checkStudent = $this->classes_model->checkStudentExist($params['student_id'], $params['class_id']);
            if (count($checkStudent) > 0) {
                $condition = array("id" => $checkStudent[0]['id']);
                $data = array(
                    'notify_status' => $params['notify_status'],
                    'modified_by' => $params['user_id'],
                    'modified_date' => date('Y-m-d H:i:s')
                );
                $update = $this->common_model->update('student_class', $data, $condition);
                if ($update) {
                    $this->jsonarr["IsSuccess"] = true;
                    $this->jsonarr["ResponseObject"] = "Notify Status updated successfully";
                } else {
                    $this->jsonarr["IsSuccess"] = false;
                    $this->jsonarr["ErrorObject"] = "Failed to update Notify Status";
                }
            } else {
                $this->jsonarr["IsSuccess"] = false;
                $this->jsonarr["ErrorObject"] = "Student Class not found";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }
    // Start - Added By Raj on 2024-08-05 - To perform pre validations before calling for feedback
    // Function to get embeddings from OpenAI
    function get_embeddings($text, $api_key)
    {
        $url = "https://api.openai.com/v1/embeddings";
        $headers = [
            "Authorization: Bearer $api_key",
            "Content-Type: application/json"
        ];
        $data = json_encode([
            "input" => $text,
            "model" => "text-embedding-ada-002"
        ]);

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);

        $response = curl_exec($ch);
        curl_close($ch);

        $decoded_response = json_decode($response, true);
        return $decoded_response['data'][0]['embedding'];
    }

    // Function to calculate cosine similarity between two vectors
    // function cosine_similarity($vec1, $vec2)
    // {
    //     $dot_product = array_sum(array_map(function ($x, $y) {
    //         return $x * $y;
    //     }, $vec1, $vec2));

    //     $magnitude1 = sqrt(array_sum(array_map(function ($x) {
    //         return pow($x, 2);
    //     }, $vec1)));

    //     $magnitude2 = sqrt(array_sum(array_map(function ($y) {
    //         return pow($y, 2);
    //     }, $vec2)));

    //     if ($magnitude1 == 0 || $magnitude2 == 0) {
    //         return 0;
    //     }

    //     return $dot_product / ($magnitude1 * $magnitude2);
    // }
    function cosine_similarity($vec1, $vec2)
    {
        $dot_product = 0;
        $magnitude1 = 0;
        $magnitude2 = 0;

        $length = min(count($vec1), count($vec2)); 

        for ($i = 0; $i < $length; $i++) {
            $dot_product += $vec1[$i] * $vec2[$i];
            $magnitude1 += $vec1[$i] ** 2;
            $magnitude2 += $vec2[$i] ** 2;
        }

        $magnitude1 = sqrt($magnitude1);
        $magnitude2 = sqrt($magnitude2);

        if ($magnitude1 * $magnitude2 == 0) {
            return 0;
        } else {
            return $dot_product / ($magnitude1 * $magnitude2);
        }
    }

    // Function to validate if the essay is relevant to the prompt
    function validate_essay($prompt, $essay, $api_key)
    {
        $prompt_embedding = $this->get_embeddings($prompt, $api_key);
        $essay_embedding = $this->get_embeddings($essay, $api_key);

        $similarity_score = $this->cosine_similarity($prompt_embedding, $essay_embedding);

        // Define a threshold for relevance (e.g., 0.5)
        $threshold = 0.8;
        if ($similarity_score < $threshold) {
            return ['is_valid' => false, 'score' => $similarity_score];
        } else {
            return ['is_valid' => true, 'score' =>$similarity_score, 'prompt_embedding' => $prompt_embedding, 'essay_embedding' => $essay_embedding];
        }
    }

    public
    function generate_tfidf_vector($essay, $all_essays)
    {
        if (empty($all_essays)) {
            $all_essays = [$essay];
        }

        $all_text = implode(" ", $all_essays);

        $word_counts = array_count_values(str_word_count($all_text, 1));
        $words = array_keys($word_counts);

        $vector = array_fill(0, count($words), 0);
        //echo the vector array 


        $word_to_index = array_flip($words);
        $essay_words = str_word_count($essay, 1);

        foreach ($essay_words as $word) {
            if ($word <> '' && array_key_exists($word, $word_to_index)) { // Check if key exists
                $vector[$word_to_index[$word]]++;
            }
        }

        return $vector;
    }
    function check_same_essay($original_embedding, $revised_embedding)
    {
       // $original_embedding = $this->get_embeddings($original_essay, $api_key);
       // $revised_embedding = $this->get_embeddings($revised_essay, $api_key);

        $similarity_score = $this->cosine_similarity($original_embedding, $revised_embedding);

        // Define a threshold to determine if the essays are too similar (e.g., 0.95)
        $threshold = 0.95;
        if ($similarity_score >= $threshold) {
            return ['is_same' => true, 'score' => $similarity_score];
        } else {
            return ['is_same' => false, 'score' => $similarity_score];
        }
    }

    // End - Added By Raj on 2024-08-05 - To perform pre validations before calling for feedback

    public function getOpenAiFeedback_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        //   $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['question_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Question Id should not be empty";
        } elseif ($params['question'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Question should not be empty";
        } elseif ($params['student_id'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Student Id should not be empty";
        } elseif ($params['student_answer'] == "") {
            $this->jsonarr['IsSuccess'] = false;
            $this->jsonarr['ErrorObject'] = "Student Answer should not be empty";
        } else {
            $prop = parse_ini_file('../properties.ini', true, INI_SCANNER_RAW);
            $get_api_key = $prop['api_key'];
            $GoLive = $get_api_key == "" ? false : true;
            if ($GoLive) {
                $api_key = $get_api_key;
            }
            $prevStudentEssay = "";
            $prevFeedback = "";
            $prevEssayEmbedding = "";

            //get most recent feedback from essay_feedback table
            $condition = "WHERE status = 1 AND student_content_id = {$params['student_content_id']} AND question_id = {$params['question_id']} ORDER BY student_essay_id DESC";
            $getStudentEssay = $this->student_model->getStudentEssay($condition);
            if (count($getStudentEssay) > 0) {
                $prevStudentEssay = $getStudentEssay[0]["student_answer"];
                $prevFeedback = $getStudentEssay[0]["feedback"];
                $prevEssayEmbedding = $getStudentEssay[0]["essay_embedding"];
            }
            // Initial essay and feedback
            $initial_essay_prompt = $params['question'];
            $initial_essay = $prevStudentEssay;
            $initial_feedback = $prevFeedback;
            // Student's updated essay based on feedback
            $updated_essay = $params['student_answer'];

            // Default rubric criteria and max score
            $rubric_criteria = "- Content: Thorough explanation of ideas, Use of detailed examples and evidence
                - Organization: Well-structured introduction, body, and conclusion, Smooth transitions between ideas
                - Style: Precise and descriptive language, Complex sentence structures
                - Grammar and Mechanics: Accurate grammar, Correct punctuation and capitalization, Spelling accuracy
";
            $maxScore = 10;

            $condition = "WHERE sc.id = {$params['student_content_id']}";
            $getClassGrade = $this->student_model->getClassGrade($condition);
            $grade = explode(',', $getClassGrade[0]['grade']);
            // If class grade is empty, get student grade from user table
            if ($grade[0] == '') {
                $studentGrade = $this->classes_model->studentGrade($params['school_id'], $params['student_id']);
                $grade[0] = count($studentGrade) > 0 ? $studentGrade[0]['grade_id'] : '';
            }
            if ($grade[0] != '') {
                $getGradeList = $this->db->query("SELECT grade_id,grade_name FROM grade WHERE grade_id = {$grade[0]}")->result_array();
                $params['grade_id'] = $getGradeList[0]['grade_name'];
                if (($params['grade_id'] >= 1 && $params['grade_id'] <= 12) || $params['grade_id'] == 'College' || $params['grade_id'] == 'PKG' || $params['grade_id'] == 'KG') {
                    $condition = "WHERE studentGrade='{$params['grade_id']}' and Status='Active' LIMIT 1";
                    $getEssayRubric = $this->student_model->getEssayRubric($condition);
                    if (count($getEssayRubric) > 0) {
                        $rubric_criteria = $getEssayRubric[0]["essayCriteria"];
                        $maxScore = $getEssayRubric[0]["maxScore"];
                    }
                    $rubric = $rubric_criteria;

                    if (
                        $prevFeedback == ""
                    ) {
                        // If Previous feedback is empty, provide feedback on the initial essay prompt and student's essay
                        $full_prompt = "
                The student was asked to write an essay on the following prompt: {$initial_essay_prompt}

                Here is the student's essay:
                {$updated_essay}

                Please provide feedback for a {$params['grade_id']} grade level essay on the following writing traits, with a score out of 5 for each:
Provide scores out of 5 in a separate line for each trait. Format the score with a prefix SCORE: .
            1. Development of Ideas: Score and feedback
            2. Organization: Score and feedback
            3. Style: Score and feedback
            4. Word Choice: Score and feedback
            5. Sentence Fluency: Score and feedback
            6. Conventions: Score and feedback
            7. Textual Evidence: Score and feedback
            8. Content Accuracy: Score and feedback

            ";
                    } else {
                        // If previous feedback is available, provide feedback on the updated essay based on the previous feedback
                        $full_prompt = "
                The student was asked to write an essay on the following prompt: {$initial_essay_prompt}

                Here is the feedback that was given for the original submission:
                {$initial_feedback}

                Here is the student's revised essay::
                {$updated_essay}

                Please provide updated feedback for a {$params['grade_id']} grade level essay by focusing on how the student improved the essay based on the original feedback. Assess the current essay using the following writing traits: Development of Ideas, Organization, Style, Word Choice, Sentence Fluency, Conventions, Textual Evidence, and Content Accuracy. Provide scores out of 5 in a separate line for each trait. Format the score with a prefix SCORE: .

            ";
                    }

                    /*
                if ($prevFeedback == "") {
                    // If Previous feedback is empty, provide feedback on the initial essay prompt and student's essay
                    $full_prompt = "
                Here is the initial essay prompt: {$initial_essay_prompt}

                Here is the initial student's essay:
                {$updated_essay}
        
            ";
                } else {
                    // If previous feedback is available, provide feedback on the updated essay based on the previous feedback
                    $full_prompt = "
                Here is the initial essay prompt: {$initial_essay_prompt}
        
                Here is the initial student's essay:
                {$initial_essay}
        
                Here is the initial feedback for the student's essay:
                {$initial_feedback}
        
                Here is the student's updated essay based on the feedback:
                {$updated_essay}
                
            ";
                }

                $full_prompt .= "Using the following rubric for a {$params['grade_id']} grade level essay, provide detailed feedback on the following traits: Development of Ideas, Organization, Style, Word Choice, Sentence Fluency, Conventions, Textual Evidence, and Content Accuracy. For each trait, provide a score out of 5 in the following format (Score: 4/5) with examples of how to improve the essay. Highlight specific sections of the student's essay that need improvement and point out grammatical and spelling errors. Provide an overall feedback on the essay and suggestions for the student to enhance their writing skills.
			Rubric: {$rubric}";
 */
                    if ($GoLive) {


                        //Start - Added by Raj 2024-08-07
                        // Adding pre-validation before calling for feedback
                        $validation_result = $this->validate_essay($initial_essay_prompt, $updated_essay, $api_key);

                        if (!$validation_result['is_valid']) {
                            // Provide feedback that the essay is off-topic
                            $this->jsonarr['IsSuccess'] = false;
                            $this->jsonarr['ErrorObject'] = "Your essay does not address the prompt. Please ensure that your response relates to the theme of conformity in the provided texts.";
                            $this->jsonarr['Score'] = $validation_result['score'];
                            $this->common_model->createLog($params, 'v1/student/getOpenAiFeedback', $this->jsonarr, 'OpenAiFeedbackResponse');
                            return $this->printjson($this->jsonarr);
                            exit;
                            // $feedback = "Your essay does not address the prompt. Please ensure that your response relates to the theme of perseverance in the provided texts.";
                        } else {
                            /*
                        if (isset($params['finalSubmit']) && $params['finalSubmit'] == 0 && $prevEssayEmbedding != "") {
                            $check_same_essay = $this->check_same_essay(json_decode($prevEssayEmbedding, true), $validation_result['essay_embedding']);
                            if ($check_same_essay['is_same']) {
                                $this->jsonarr['IsSuccess'] = false;
                                $this->jsonarr['ErrorObject'] = "Essay Not Updated: There are no changes to submit.";
                                $this->jsonarr['Score'] = $check_same_essay['score'];
                                return $this->printjson($this->jsonarr);
                                exit;
                            }
                        }
			     */
                            // End - Added by Raj 2024-08-07

                            $curl = curl_init();

                            curl_setopt_array($curl, [
                                CURLOPT_URL => "https://api.openai.com/v1/chat/completions",
                                CURLOPT_RETURNTRANSFER => true,
                                CURLOPT_ENCODING => "",
                                CURLOPT_MAXREDIRS => 10,
                                CURLOPT_TIMEOUT => 30,
                                CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                                CURLOPT_CUSTOMREQUEST => "POST",
                                CURLOPT_POSTFIELDS => json_encode([
                                    "model" => "gpt-3.5-turbo",
                                    "messages" => [
                                        ["role" => "system", "content" => "You are an assistant that provides detailed and constructive feedback to the student essays to help them improve their essay writing skills."],

                                        ["role" => "user", "content" => $full_prompt]
                                    ],
                                    "max_tokens" => 1500,
                                    "n" => 1,
                                    "stop" => null,
                                    "temperature" => 0.5,
                                ]),
                                CURLOPT_HTTPHEADER => [
                                    "Content-Type: application/json",
                                    "Authorization: Bearer $api_key"
                                ],
                            ]);

                            $response = curl_exec($curl);
                            $err = curl_error($curl);
                            $httpCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                            // curl_close($curl);
                            if ($httpCode != 200) {
                                $httpResponse = json_decode($response, true);
                                $this->jsonarr['IsSuccess'] = false;
                                $this->jsonarr['ErrorObject'] = $httpResponse['error']['message'];
                                return $this->printjson($this->jsonarr);
                                exit;
                            } else {

                                $responseData = json_decode($response, true);
                                $this->common_model->createLog(
                                    $params,
                                    'v1/student/getOpenAiFeedback',
                                    $response,
                                    'OpenAiFeedbackResponse'
                                );
                                // $feedback = $this->db->escape($responseData['choices'][0]['message']['content']);
                                $feedback = $responseData['choices'][0]['message']['content'];
                                //  $studentEssay = $this->db->escape($studentEssay);
                            }
                            //Start - Added by Raj - 2024-08-07
                        }
                        //End Added by Raj - 2024-08-07
                    } else {

                        $feedback = "
				Unable to get feedback. Please contact EdQuill Support.
";
                        // $feedback = $this->db->escape($feedback);
                    }

                    //$traitScore = 0;
                    $maxTraitScore = 0;
                    $totalScore = 0;
                    $traitScoreArray = array();
                    $maxTraitScoreArray = array();
                    $totalScoreArray = array();
                    $feedbackArray = explode("\n", $feedback);
                    foreach ($feedbackArray as $line) {
                        if (
                            strpos($line, 'SCORE:') !== false
                        ) {
                            $traitScore = intval(substr($line, strpos($line, 'SCORE: ') + 7, 1));
                            $maxTraitScore += 5;
                            $totalScore += $traitScore;
                            array_push($traitScoreArray, $traitScore);
                            array_push($maxTraitScoreArray, $maxTraitScore);
                            array_push($totalScoreArray, $totalScore);
                        }
                    }
                    $maxTraitScore = 40; // inserted by Raj because the incorrect essay was showing zero & Exceptional 
                    $addStudentEssay = [];
                    $addStudentEssay['student_content_id'] = $params['student_content_id'];
                    $addStudentEssay['question_id'] = $params['question_id'];
                    $addStudentEssay['question'] = $params['question'];
                    $addStudentEssay['student_answer'] = $params['student_answer'];
                    $addStudentEssay['student_score'] = $totalScore;
                    $addStudentEssay['total_score'] = $maxTraitScore;
                    $addStudentEssay['feedback'] = $feedback;
                    $addStudentEssay['feedback_received'] = date('Y-m-d H:i:s');
                    $addStudentEssay['time_taken'] = $params['time_taken'];
                    $addStudentEssay['status'] = 1;
                    $addStudentEssay['essay_embedding'] = json_encode($validation_result['essay_embedding']);
                    $addStudentEssay['created_by'] = $params['user_id'];
                    $addStudentEssay['created_date'] = date('Y-m-d H:i:s');
                    $studentEssayId = $this->common_model->insert('student_essays', $addStudentEssay);
                    if ($studentEssayId > 0) {
                        $condition = "WHERE student_essay_id = {$studentEssayId}";
                        $getStudentEssay = $this->student_model->getStudentEssay($condition);
                        $this->jsonarr["IsSuccess"] = true;
                        $this->jsonarr["ResponseObject"] = $getStudentEssay;
                        //Empty the old essay embeddings
                        $condition = "WHERE student_essay_id != {$studentEssayId} AND essay_embedding != '' AND student_content_id = {$params['student_content_id']} AND question_id = {$params['question_id']} ORDER BY student_essay_id DESC";
                        $getStudentEssay = $this->student_model->getStudentEssay($condition);
                        if (count($getStudentEssay) > 0) {
                            foreach ($getStudentEssay as $key => $value) {
                                $condition = array('student_essay_id' => $value['student_essay_id']);
                                $essay_embedding['essay_embedding'] = '';
                                $this->common_model->update('student_essays', $essay_embedding, $condition);
                            }
                        }
                    } else {
                        $this->jsonarr['IsSuccess'] = false;
                        $this->jsonarr['ErrorObject'] = "Feedback Not Updated";
                    }
                } else {
                    $this->jsonarr['IsSuccess'] = false;
                    $this->jsonarr['ErrorObject'] = "Invalid Grade";
                }
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ErrorObject'] = "Class Grade and Student Grade are empty.";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function getOpenAiFeedbackCount_post(){
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
        //  $this->common_model->checkPermission($this->controller,$params,$headers);
        if ($params['platform'] != "web" && $params['platform'] != "ios") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform should not be empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id should not be empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id should not be empty";
        } elseif ($params['student_content_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Student Content Id should not be empty";
        } else {
            $condition = "WHERE status = 1 AND student_content_id = {$params['student_content_id']} AND question_id = {$params['question_id']} ORDER BY student_essay_id DESC";
            $getStudentEssay = $this->student_model->getStudentEssay($condition);
            $this->jsonarr["IsSuccess"] = true;
            $this->jsonarr["ResponseObject"] = $getStudentEssay;
            $this->jsonarr["count"] = count($getStudentEssay);
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }

    public function makeUpClass_post()
    {
        $this->benchmark->mark('code_start');
        $params = json_decode(file_get_contents('php://input'), true);
        $headers = $this->input->request_headers();
       // $this->common_model->checkPermission($this->controller, $params, $headers);
        if ($params['platform'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Platform Should not be Empty";
        } elseif ($params['user_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "User Id Should not be Empty";
        } elseif ($params['role_id'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Role Id Should not be Empty";
        } elseif ($params['to_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "MakeUp Class Should not be Empty";
        } elseif ($params['from_class'] == "") {
            $this->jsonarr["IsSuccess"] = false;
            $this->jsonarr["ErrorObject"] = "Current Class Should not be Empty";
        } else {
            $condition = "WHERE from_class = {$params['from_class']} AND to_class = {$params['to_class']} AND student_id = {$params['student_id']} AND type = 'M'";
            $checkStudentExists = $this->student_model->studentClassTransfer($condition);
            $makeUpClass = array(
                'class_id' => $params['to_class'],
                'from_class' => $params['from_class'],
                'to_class' => $params['to_class'],
                'student_id' => $params['student_id'],
                'validity' => $params['start_date'],
                'absent_date' => $params['absent_date'],
                'status' => 1,
                'type' => 'M',
                'joining_date' => $params['start_date']
            );
            if (count($checkStudentExists) == 0) {
                $makeUpClass['created_by'] = $params['user_id'];
                $makeUpClass['created_date'] = date('Y-m-d H:i:s');
                $makeUpClassId = $this->common_model->insert('student_class_transfer', $makeUpClass);
            } else {
                $makeUpClass['modified_by'] = $params['user_id'];
                $makeUpClass['modified_date'] = date('Y-m-d H:i:s');
                $condition = array('id' => $checkStudentExists[0]['id']);
                $updateStudentClass = $this->common_model->update('student_class_transfer', $makeUpClass, $condition);
                $makeUpClassId = $updateStudentClass ? 1 : 0;
            }

            $studentExists = $this->classes_model->checkStudent($params['to_class'], $params['student_id']);
            if (count($studentExists) > 0) {
                $studentcondition = "student_id = {$params['student_id']} AND class_id = {$params['to_class']}";
                $student['class_id'] = $params['to_class'];
                $student['from_class'] = $params['from_class'];
                $student['student_id'] = $params['student_id'];
                $student['joining_date'] = $params['start_date'];
                $student['validity'] = $params['start_date'];
                $student['status'] = 1;
                $student['modified_by'] = $params['user_id'];
                $student['modified_date'] = date('Y-m-d H:i:s');
                $update = $this->common_model->update('student_class', $student, $studentcondition);
                $studentClassId = $update ? 1 : 0;
            } else {
                $studentClass['class_id'] = $params['to_class'];
                $studentClass['from_class'] = $params['from_class'];
                $studentClass['student_id'] = $params['student_id'];
                $studentClass['joining_date'] = $params['start_date'];
                $studentClass['validity'] = $params['start_date'];
                $studentClass['status'] = 1;
                $studentClass['class_type'] = 2;
                $studentClass['created_by'] = $params['user_id'];
                $studentClass['created_date'] = date('Y-m-d H:i:s');
                $studentClassId = $this->common_model->insert('student_class', $studentClass);
            }

            if ($studentClassId > 0 && $makeUpClassId > 0) {
                $this->jsonarr['IsSuccess'] = true;
                $this->jsonarr['ResponseObject'] = "Student Added Successfully.";
            } else {
                $this->jsonarr['IsSuccess'] = false;
                $this->jsonarr['ErrorObject'] = "Failed to add";
            }
        }
        $this->benchmark->mark('code_end');
        $this->jsonarr["processing_time"] = $this->benchmark->elapsed_time('code_start', 'code_end');
        return $this->printjson($this->jsonarr);
    }
    
}
